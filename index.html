<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log√≠stica B2B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- OVERLAY CARGA -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-[9999] flex flex-col items-center justify-center transition-opacity duration-300 hidden pointer-events-none opacity-0">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-emerald-600"></div>
        <p id="loading-text" class="text-slate-600 font-medium mt-4 animate-pulse">Conectando...</p>
    </div>

    <!-- DEBUG FLOATING -->
    <div id="debug-panel" class="fixed bottom-4 right-4 z-[50] hidden">
        <button id="btn-toggle-view" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-full shadow-lg text-sm font-bold flex items-center gap-2 transition hover:scale-105">
            <i data-lucide="eye" class="w-4 h-4"></i> <span id="btn-toggle-label">Ver como Cliente</span>
        </button>
    </div>

    <!-- VISTA AUTH -->
    <div id="view-auth" class="flex-1 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-100 to-emerald-50 hidden">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden border border-slate-100 slide-up">
            <div class="bg-slate-900 p-8 text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="box" class="w-32 h-32 text-white"></i></div>
                <div class="relative z-10">
                    <h1 class="text-2xl font-bold text-white">Log√≠stica Pro</h1>
                    <div id="connection-status" class="inline-flex items-center gap-1.5 bg-white/10 px-3 py-1 rounded-full text-[10px] font-medium text-white/80 mt-2 backdrop-blur-sm">
                        <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> Sistema Seguro
                    </div>
                </div>
            </div>

            <div class="p-8">
                <form onsubmit="app.handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase ml-1 mb-1">WhatsApp</label>
                        <input id="auth-phone" type="tel" required placeholder="Ingresa tu n√∫mero" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-emerald-500 transition font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase ml-1 mb-1">Contrase√±a</label>
                        <input id="auth-pass" type="password" required placeholder="Tu clave asignada" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-emerald-500 transition">
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2">
                        Iniciar Sesi√≥n
                    </button>
                </form>
                <p id="auth-error" class="text-red-500 text-xs text-center mt-4 font-bold hidden"></p>
                <div class="mt-6 text-center text-xs text-slate-400 border-t pt-4">
                    Acceso exclusivo para socios registrados.
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="view-admin" class="flex-1 flex flex-col h-full hidden bg-slate-100">
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-500 p-2 rounded-lg"><i data-lucide="shield" class="w-5 h-5"></i></div>
                <h1 class="font-bold text-lg">Panel Administrador</h1>
            </div>
            <button onclick="app.logout()" class="text-xs font-bold bg-white/10 hover:bg-white/20 px-3 py-2 rounded transition">Salir</button>
        </header>
        <main class="flex-1 p-4 md:p-8 overflow-y-auto max-w-5xl mx-auto w-full space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-indigo-600"></i> Alta de Emprendedor</h2>
                <form onsubmit="app.adminCreateUser(event)" class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">WhatsApp del Cliente</label>
                        <input id="admin-new-phone" type="tel" required placeholder="Ej: 999888777" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full md:w-auto bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2 shadow-lg shadow-indigo-100">
                        <i data-lucide="zap" class="w-4 h-4"></i> Generar & Enviar
                    </button>
                </form>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800">Usuarios Registrados</h2>
                    <button onclick="app.adminLoadUsers()" class="p-2 hover:bg-slate-50 rounded-full text-slate-400"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 uppercase text-xs"><tr><th class="px-6 py-3">WhatsApp</th><th class="px-6 py-3">Contrase√±a (Hash)</th><th class="px-6 py-3">Fecha Alta</th><th class="px-6 py-3 text-right">Acci√≥n</th></tr></thead><tbody id="admin-users-list" class="divide-y divide-slate-100"></tbody></table>
                </div>
            </div>
        </main>
    </div>

    <!-- VISTA DASHBOARD (EMPRENDEDOR) -->
    <div id="view-dashboard" class="flex-1 flex flex-col md:flex-row h-full hidden">
        <aside class="w-full md:w-72 bg-white border-b md:border-r border-slate-200 flex flex-col shadow-sm z-20">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <div class="bg-emerald-100 p-2 rounded-xl text-emerald-600"><i data-lucide="package" class="w-6 h-6"></i></div>
                <div><h1 class="font-bold text-lg text-slate-800">Mi Panel</h1><p class="text-xs text-slate-400">Emprendedor</p></div>
            </div>
            <nav class="flex md:flex-col p-2 gap-1 overflow-x-auto">
                <button onclick="app.setTab('config')" id="nav-config" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center bg-emerald-50 text-emerald-700"><i data-lucide="settings" class="w-4 h-4"></i> Configurar</button>
                <button onclick="app.setTab('share')" id="nav-share" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-500 hover:bg-slate-50"><i data-lucide="share-2" class="w-4 h-4"></i> Compartir</button>
                <button onclick="app.setTab('orders')" id="nav-orders" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-500 hover:bg-slate-50"><i data-lucide="shopping-bag" class="w-4 h-4"></i> Pedidos</button>
            </nav>
            <div class="mt-auto p-4 border-t border-slate-100">
                <div class="flex items-center gap-3 mb-3"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i data-lucide="phone" class="w-4 h-4 text-slate-500"></i></div><div class="overflow-hidden"><p id="user-display" class="text-sm font-bold text-slate-700 truncate">...</p></div></div>
                <button onclick="app.logout()" class="w-full text-red-500 text-xs font-bold hover:bg-red-50 py-2 rounded transition">Cerrar Sesi√≥n</button>
            </div>
        </aside>
        <main class="flex-1 bg-slate-50/50 p-4 md:p-8 overflow-y-auto relative">
            <div id="tab-config" class="tab-content max-w-2xl mx-auto space-y-6 slide-up">
                <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-slate-800">Configuraci√≥n</h2><button onclick="app.saveConfig()" class="bg-slate-900 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition flex gap-2"><i data-lucide="save" class="w-4 h-4"></i> Guardar</button></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                    <h3 class="font-bold text-slate-800">Datos P√∫blicos</h3>
                    <div><label class="text-xs font-bold text-slate-400 uppercase">Nombre Tienda</label><input id="inp-store-name" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none"></div>
                    <div><label class="text-xs font-bold text-slate-400 uppercase">WhatsApp Pedidos</label><input id="inp-whatsapp" type="tel" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                    <h3 class="font-bold text-slate-800">Log√≠stica</h3>
                    <label class="text-xs font-bold text-slate-400 uppercase">Couriers</label><div id="container-couriers" class="grid grid-cols-2 gap-2"></div>
                    <label class="text-xs font-bold text-slate-400 uppercase block mt-4">D√≠as Env√≠o</label><div id="container-days" class="flex flex-wrap gap-2"></div>
                    <div class="flex items-center gap-2 mt-2"><span class="text-sm font-bold text-slate-600">Hora Corte:</span><input type="time" id="inp-time" class="border rounded px-2 py-1 text-sm"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="lock" class="w-4 h-4 text-indigo-500"></i> Seguridad</h3>
                    <div class="flex gap-2 items-end"><div class="flex-1"><label class="text-xs font-bold text-slate-400 uppercase">Nueva Contrase√±a</label><input id="inp-new-pass" type="password" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-indigo-500 outline-none"></div><button onclick="app.changePassword()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition h-[42px]">Actualizar</button></div>
                </div>
            </div>
            <div id="tab-share" class="tab-content hidden h-full flex flex-col items-center justify-center p-4">
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 text-center max-w-md w-full slide-up">
                    <div class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600"><i data-lucide="share-2" class="w-8 h-8"></i></div>
                    <h2 class="text-xl font-bold mb-2">Enlace P√∫blico</h2>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 break-all"><code id="share-link" class="text-xs text-indigo-600 font-bold select-all">...</code></div>
                    <div class="space-y-2"><button onclick="app.copyLink()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Copiar Link</button><button onclick="app.shareOnWhatsapp()" class="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold hover:bg-emerald-600 transition flex items-center justify-center gap-2"><i data-lucide="message-circle" class="w-4 h-4"></i> Enviar por WhatsApp</button></div>
                </div>
            </div>
            <div id="tab-orders" class="tab-content hidden max-w-3xl mx-auto">
                <div class="flex justify-between mb-6"><h2 class="text-xl font-bold text-slate-800">Pedidos</h2><button onclick="app.loadData()" class="p-2 bg-white rounded-full shadow hover:bg-slate-50"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button></div>
                <div id="orders-list" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <!-- VISTA CLIENTE (CON DESPLEGABLES COMPACTOS Y FECHAS REALES) -->
    <div id="view-client" class="flex-1 min-h-screen bg-slate-50 hidden overflow-y-auto">
        <div class="max-w-2xl mx-auto min-h-screen bg-white shadow-2xl overflow-hidden flex flex-col">
            <div class="bg-slate-900 text-white p-6 sticky top-0 z-10 shadow-md flex items-center gap-3">
                <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center"><i data-lucide="shopping-bag" class="w-5 h-5 text-emerald-400"></i></div>
                <div><h1 id="client-title" class="font-bold text-lg leading-tight">Cargando...</h1><p class="text-xs text-slate-400">Datos de Env√≠o</p></div>
            </div>

            <div class="flex-1 p-6 space-y-8 pb-32">
                <div class="bg-orange-50 border-l-4 border-orange-400 p-4 rounded-r-lg shadow-sm"><p class="text-xs text-orange-700">üìÖ Pedidos para hoy cierran a las <strong id="client-time">--:--</strong>.</p></div>

                <form id="client-form" onsubmit="app.submitOrder(event)" class="space-y-8">
                    <!-- PASO 1 -->
                    <div class="space-y-4">
                        <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider border-b pb-2">1. Configura tu Env√≠o</h3>
                        
                        <!-- COURIER DESPLEGABLE -->
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-2">Selecciona Agencia o Delivery</label>
                            <div class="relative">
                                <select id="c-courier-select" onchange="app.onCourierChange(this.value)" class="w-full appearance-none bg-white border border-slate-300 rounded-xl py-3 pl-4 pr-10 text-slate-700 font-medium focus:ring-2 focus:ring-slate-800 outline-none cursor-pointer">
                                    <option value="" disabled selected>Elige una opci√≥n...</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><i data-lucide="chevron-down" class="w-4 h-4"></i></div>
                            </div>
                        </div>

                        <!-- FECHA DESPLEGABLE -->
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-2">Fecha de Despacho (Pr√≥ximas 2 semanas)</label>
                            <div class="relative">
                                <select id="c-date-select" onchange="app.validateForm()" class="w-full appearance-none bg-white border border-slate-300 rounded-xl py-3 pl-4 pr-10 text-slate-700 font-medium focus:ring-2 focus:ring-slate-800 outline-none cursor-pointer">
                                    <option value="" disabled selected>Elige fecha...</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><i data-lucide="calendar" class="w-4 h-4"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 2 (DIN√ÅMICO) -->
                    <div id="dynamic-form-section" class="hidden space-y-6 fade-in">
                        <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider border-b pb-2">2. Datos de Destino</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div><label class="block text-xs font-semibold text-slate-500 mb-1">Nombre Completo</label><input id="c-name" required class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition"></div>
                            <div><label class="block text-xs font-semibold text-slate-500 mb-1">Celular / WhatsApp</label><input id="c-phone" type="tel" required class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition"></div>
                        </div>

                        <!-- AGENCIA (BUSCADOR ESTILO CLARO) -->
                        <div id="fields-agency" class="hidden space-y-4">
                            <div><label class="block text-xs font-semibold text-slate-500 mb-1">DNI / CE</label><input id="c-dni" type="tel" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition"></div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">BUSCAR SEDE (CALLE/DISTRITO)</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="h-5 w-5 text-slate-400"></i></div>
                                    <input id="c-agency" type="text" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl pl-10 pr-10 py-3 outline-none focus:ring-2 focus:ring-slate-800 transition placeholder-slate-400" placeholder="Escribe para buscar..." autocomplete="off" oninput="app.searchAgency(this.value)">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center"><button type="button" id="btn-clear-agency" onclick="app.clearAgency()" class="hidden text-slate-400 hover:text-slate-600"><i data-lucide="x" class="h-5 w-5"></i></button></div>
                                    <div id="agency-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-slate-200 rounded-xl shadow-2xl max-h-64 overflow-y-auto z-50 divide-y divide-slate-100"></div>
                                </div>
                            </div>
                        </div>

                        <!-- DOMICILIO -->
                        <div id="fields-home" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2"><label class="block text-xs font-semibold text-slate-500 mb-1">Direcci√≥n Exacta</label><input id="c-address" placeholder="Calle / Av / Jr" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition"></div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">DISTRITO</label>
                                    <div class="relative group">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="map-pin" class="h-5 w-5 text-slate-400"></i></div>
                                        <input id="c-district" type="text" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl pl-10 pr-10 py-3 outline-none focus:ring-2 focus:ring-slate-800 transition placeholder-slate-400" placeholder="Buscar distrito..." autocomplete="off" oninput="app.searchDistrict(this.value)">
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center"><button type="button" id="btn-clear-district" onclick="app.clearDistrict()" class="hidden text-slate-400 hover:text-slate-600"><i data-lucide="x" class="h-5 w-5"></i></button></div>
                                        <div id="district-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-slate-200 rounded-xl shadow-2xl max-h-64 overflow-y-auto z-50 divide-y divide-slate-100"></div>
                                    </div>
                                </div>
                                <div><label class="block text-xs font-semibold text-slate-500 mb-1">Referencia</label><input id="c-ref" placeholder="Frente a..." class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition"></div>
                            </div>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-200 flex justify-center max-w-2xl mx-auto z-20">
                        <button type="submit" id="btn-submit-order" disabled class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="message-circle" class="w-6 h-6"></i> Enviar Datos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbwitgwqdco87Kwil7SdmI4N8anuhu1C02-Uzt7_0Q4Gf8lfq4GBv3Jheyfole1RELe3IQ/exec";
        const JSON_DISTRITOS = "https://raw.githubusercontent.com/complicidad/form/main/lstDinsides.json";
        const JSON_SHALOM = "https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json";

        const COURIER_TYPES = {
            "Shalom": "agency", "Olva Courier": "agency", "Flores": "agency", "Cruz del Sur": "agency",
            "Rappi": "home", "PedidosYa": "home", "Motorizado": "home", "DHL": "home", "FedEx": "home", "Tienda": "home"
        };

        const SafeStorage = {
            memory: {},
            setItem: function(key, value) { try { localStorage.setItem(key, value); } catch(e) { this.memory[key] = value; } },
            getItem: function(key) { try { return localStorage.getItem(key); } catch(e) { return this.memory[key] || null; } },
            removeItem: function(key) { try { localStorage.removeItem(key); } catch(e) { delete this.memory[key]; } }
        };

        const ALL_COURIERS = ["Olva Courier", "Shalom", "Rappi", "PedidosYa", "DHL", "FedEx", "Motorizado", "Tienda"];
        const ALL_DAYS = ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"];
        // Mapa para convertir nombre d√≠a a √≠ndice JS (0=Dom, 1=Lun...)
        const DAY_INDEX_MAP = { "Dom": 0, "Lun": 1, "Mar": 2, "Mi√©": 3, "Jue": 4, "Vie": 5, "S√°b": 6 };
        const DAY_NAMES_FULL = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        const MONTH_NAMES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

        const initialState = { merchantName: "", whatsapp: "", couriers: [], shippingDays: [], updateTime: "18:00" };
        const state = { user: null, merchantId: null, apiUrl: DEFAULT_API_URL, isClientView: false, config: { ...initialState }, selectedCourierType: null, externalData: {} };

        window.app = {
            updateConnectionStatus: () => {
                const el = document.getElementById('connection-status');
                if(el) el.innerHTML = state.apiUrl ? `<span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> Sistema Seguro` : `Local`;
            },

            // --- EXTERNAL DATA ---
            loadExternalLists: async () => {
                try {
                    if(!state.externalData.districts) {
                        const res = await fetch(JSON_DISTRITOS);
                        const data = await res.json();
                        state.externalData.districts = data.map(d => d.Distrito || d.nombre);
                    }
                    if(!state.externalData.agencies) {
                        const res = await fetch(JSON_SHALOM);
                        state.externalData.agencies = await res.json(); 
                    }
                } catch(e) { console.error(e); }
            },

            // --- AGENCY SEARCH LOGIC ---
            searchAgency: (query) => {
                const resultsContainer = document.getElementById('agency-results');
                const clearBtn = document.getElementById('btn-clear-agency');
                if (!query) { resultsContainer.classList.add('hidden'); clearBtn.classList.add('hidden'); return; }
                clearBtn.classList.remove('hidden');

                if(query.length < 2) { resultsContainer.classList.add('hidden'); return; }
                const lowerQ = query.toLowerCase();
                const matches = (state.externalData.agencies || []).filter(a => (a.Agencia && a.Agencia.toLowerCase().includes(lowerQ)) || (a.Direccion && a.Direccion.toLowerCase().includes(lowerQ))).slice(0, 50);

                resultsContainer.innerHTML = matches.length === 0 ? '<div class="p-4 text-slate-400 text-sm text-center">No se encontraron resultados</div>' : matches.map(a => `<div onclick="app.selectAgency('${a.Agencia.replace(/'/g, "\\'")}', '${a.Direccion.replace(/'/g, "\\'")}')" class="p-4 cursor-pointer hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><p class="font-bold text-slate-800 text-sm mb-1">${a.Agencia}</p><p class="text-xs text-slate-500">${a.Direccion}</p></div>`).join('');
                resultsContainer.classList.remove('hidden');
            },
            selectAgency: (name, address) => {
                const input = document.getElementById('c-agency'); input.value = `${name} - ${address}`;
                document.getElementById('agency-results').classList.add('hidden'); document.getElementById('btn-clear-agency').classList.remove('hidden');
            },
            clearAgency: () => {
                const input = document.getElementById('c-agency'); input.value = ''; document.getElementById('agency-results').classList.add('hidden'); document.getElementById('btn-clear-agency').classList.add('hidden'); input.focus();
            },

            // --- DISTRICT SEARCH LOGIC ---
            searchDistrict: (query) => {
                const resultsContainer = document.getElementById('district-results');
                const clearBtn = document.getElementById('btn-clear-district');
                if (!query) { resultsContainer.classList.add('hidden'); clearBtn.classList.add('hidden'); return; }
                clearBtn.classList.remove('hidden');
                if(query.length < 1) { resultsContainer.classList.add('hidden'); return; }

                const lowerQ = query.toLowerCase();
                const matches = (state.externalData.districts || []).filter(d => d.toLowerCase().includes(lowerQ)).slice(0, 50);
                resultsContainer.innerHTML = matches.length === 0 ? '<div class="p-4 text-slate-400 text-sm text-center">No se encontraron resultados</div>' : matches.map(d => `<div onclick="app.selectDistrict('${d.replace(/'/g, "\\'")}')" class="p-4 cursor-pointer hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><p class="font-bold text-slate-800 text-sm">${d}</p></div>`).join('');
                resultsContainer.classList.remove('hidden');
            },
            selectDistrict: (val) => {
                const input = document.getElementById('c-district'); input.value = val; document.getElementById('district-results').classList.add('hidden'); document.getElementById('btn-clear-district').classList.remove('hidden');
            },
            clearDistrict: () => {
                const input = document.getElementById('c-district'); input.value = ''; document.getElementById('district-results').classList.add('hidden'); document.getElementById('btn-clear-district').classList.add('hidden'); input.focus();
            },

            // --- DATE GENERATION LOGIC ---
            generateDateOptions: () => {
                const select = document.getElementById('c-date-select');
                select.innerHTML = '<option value="" disabled selected>Elige una fecha...</option>';
                
                const allowedDays = state.config.shippingDays || []; // ["Lun", "Vie"]
                if (allowedDays.length === 0) return;

                const today = new Date();
                // Iterar pr√≥ximos 14 d√≠as
                for(let i = 0; i < 14; i++) {
                    const futureDate = new Date(today);
                    futureDate.setDate(today.getDate() + i);
                    
                    // 0-6 (Dom-Sab)
                    const dayIndex = futureDate.getDay(); 
                    
                    // Buscar si este √≠ndice corresponde a alguno de los d√≠as permitidos por el usuario
                    // DAY_INDEX_MAP convierte "Lun" -> 1.
                    const isAllowed = allowedDays.some(allowedDayName => DAY_INDEX_MAP[allowedDayName] === dayIndex);
                    
                    if (isAllowed) {
                        const dayName = DAY_NAMES_FULL[dayIndex];
                        const dayNum = futureDate.getDate().toString().padStart(2, '0');
                        const monthName = MONTH_NAMES[futureDate.getMonth()];
                        const value = `${dayName} ${dayNum}/${(futureDate.getMonth()+1).toString().padStart(2,'0')}`; // Valor t√©cnico
                        const label = `${dayName} ${dayNum} ${monthName}`; // Etiqueta bonita
                        
                        const opt = document.createElement('option');
                        opt.value = value;
                        opt.innerText = label;
                        select.appendChild(opt);
                    }
                }
            },

            // --- CLIENT FORM HANDLERS ---
            onCourierChange: (courier) => {
                const type = COURIER_TYPES[courier] || "home";
                state.selectedCourierType = type;
                state.selectedCourier = courier;

                document.getElementById('dynamic-form-section').classList.remove('hidden');
                const agencyFields = document.getElementById('fields-agency');
                const homeFields = document.getElementById('fields-home');
                
                ['c-dni','c-agency','c-address','c-district'].forEach(id => document.getElementById(id).removeAttribute('required'));

                if(type === 'agency') {
                    agencyFields.classList.remove('hidden'); homeFields.classList.add('hidden');
                    document.getElementById('c-dni').setAttribute('required','true');
                    const agInput = document.getElementById('c-agency');
                    agInput.setAttribute('required','true');
                    agInput.value = "";
                    app.clearAgency(); 
                    app.clearDistrict();

                    if(courier.includes('Shalom')) {
                        agInput.placeholder = "Escribe para buscar sede...";
                    } else {
                        agInput.placeholder = "Nombre de Agencia / Direcci√≥n";
                    }
                } else {
                    agencyFields.classList.add('hidden'); homeFields.classList.remove('hidden');
                    document.getElementById('c-address').setAttribute('required','true');
                    document.getElementById('c-district').setAttribute('required','true');
                    app.clearAgency();
                    app.clearDistrict();
                }
                app.validateForm();
            },

            onDateChange: (val) => {
                app.validateForm();
            },

            validateForm: () => {
                const btn = document.getElementById('btn-submit-order');
                const courierVal = document.getElementById('c-courier-select').value;
                const dateVal = document.getElementById('c-date-select').value;
                
                if(courierVal && dateVal) btn.removeAttribute('disabled');
                else btn.setAttribute('disabled', 'true');
            },

            submitOrder: async (e) => {
                e.preventDefault();
                app.toggleLoading(true);
                const day = document.getElementById('c-date-select').value;
                const name = document.getElementById('c-name').value;
                const phone = document.getElementById('c-phone').value;
                
                let orderData = { clientName: name, clientPhone: phone, courier: state.selectedCourier, shippingDate: day, createdAt: Date.now(), product: "N/A" };
                let waText = "";

                if (state.selectedCourierType === 'agency') {
                    const dni = document.getElementById('c-dni').value;
                    const agency = document.getElementById('c-agency').value;
                    orderData.clientDni = dni; orderData.clientAgency = agency;
                    waText = `üì¶ *NUEVO ENV√çO (AGENCIA)*\n\nüë§ *Cliente:* ${name}\nüì± *Tel:* ${phone}\nüÜî *DNI:* ${dni}\n\nüè¢ *Agencia:* ${agency}\nüöö *Courier:* ${state.selectedCourier}\nüìÖ *Fecha:* ${day}`;
                } else {
                    const addr = document.getElementById('c-address').value;
                    const dist = document.getElementById('c-district').value;
                    const ref = document.getElementById('c-ref').value;
                    orderData.clientAddress = addr; orderData.clientDistrict = dist; orderData.clientRef = ref;
                    waText = `üì¶ *NUEVO ENV√çO (CASA)*\n\nüë§ *Cliente:* ${name}\nüì± *Tel:* ${phone}\n\nüìç *Distrito:* ${dist}\nüè† *Direcci√≥n:* ${addr}\nüó∫Ô∏è *Ref:* ${ref}\n\nüöö *Courier:* ${state.selectedCourier}\nüìÖ *Fecha:* ${day}`;
                }

                try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "saveOrder", merchantId: state.merchantId, data: orderData }) }); } catch(e) {}
                window.open(`https://wa.me/51${state.config.whatsapp}?text=${encodeURIComponent(waText)}`, '_blank');
                app.toggleLoading(false);
            },

            // --- STANDARD LOGIC ---
            handleLogin: async (e) => {
                e.preventDefault();
                const phone = document.getElementById('auth-phone').value.trim();
                const pass = document.getElementById('auth-pass').value.trim();
                const errorEl = document.getElementById('auth-error');
                app.toggleLoading(true);

                if (phone === '999000999' && pass === 'admin123') { app.loginSuccess({ uid: 'admin_master', phone: 'Administrador', isAdmin: true }); return; }

                if (state.apiUrl) {
                    try {
                        const res = await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "loginUser", data: { phone, password: pass } }) });
                        const json = await res.json();
                        if (json.status === 'success') { app.loginSuccess(json.user); return; } 
                        else { errorEl.innerText = json.message; errorEl.classList.remove('hidden'); app.toggleLoading(false); return; }
                    } catch (err) { console.error(err); }
                }
                const usersDB = JSON.parse(SafeStorage.getItem('app_users_db') || '[]');
                const user = usersDB.find(u => u.phone === phone && u.password === pass);
                if (user) app.loginSuccess(user);
                else { errorEl.innerText = "Usuario no encontrado"; errorEl.classList.remove('hidden'); app.toggleLoading(false); }
            },

            loginSuccess: (user) => { state.user = user; SafeStorage.setItem('app_current_user', JSON.stringify(user)); app.init(); },
            logout: () => { SafeStorage.removeItem('app_current_user'); state.user = null; state.merchantId = null; app.init(); },

            // Admin
            adminLoadUsers: async () => {
                const list = document.getElementById('admin-users-list'); list.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">Cargando...</td></tr>';
                let users = [];
                try { const res = await fetch(`${state.apiUrl}?action=getUsers`); const json = await res.json(); if(json.users) users = json.users; } catch(e) {}
                list.innerHTML = users.length ? users.map(u => `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-bold text-slate-700">${u.phone}</td><td class="px-6 py-4 font-mono text-xs text-slate-500">****</td><td class="px-6 py-4 text-xs text-slate-400">${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-'}</td><td class="px-6 py-4 text-right"><button onclick="app.adminResend('${u.uid}','${u.phone}')" class="text-indigo-600 text-xs font-bold">Re-enviar</button></td></tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center">Vac√≠o</td></tr>';
                app.toggleLoading(false);
            },
            adminCreateUser: async (e) => {
                e.preventDefault(); const phone = document.getElementById('admin-new-phone').value.trim();
                app.toggleLoading(true); const newPass = Math.floor(1000 + Math.random() * 9000).toString();
                try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "registerUser", data: { phone, password: newPass } }) }); } catch(e) {}
                const msg = `üîê Bienvenid@ a Log√≠stica Pro\nüì± Usuario: ${phone}\nüîë Clave: *${newPass}*\nIngresa: ${window.location.href}`;
                window.open(`https://wa.me/51${phone}?text=${encodeURIComponent(msg)}`, '_blank');
                document.getElementById('admin-new-phone').value = ""; app.adminLoadUsers();
            },
            adminResend: async (uid, phone) => {
                if(!confirm(`¬øNueva clave para ${phone}?`)) return; app.toggleLoading(true);
                const newPass = Math.floor(1000 + Math.random() * 9000).toString();
                try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "changePassword", merchantId: uid, newPassword: newPass }) }); } catch(e){}
                window.open(`https://wa.me/51${phone}?text=${encodeURIComponent(`üîê Recuperaci√≥n\nüì± ${phone}\nüîë Nueva: *${newPass}*`)}`, '_blank');
                app.toggleLoading(false);
            },

            // Merchant
            saveConfig: async () => {
                app.toggleLoading(true);
                state.config.merchantName = document.getElementById('inp-store-name').value; state.config.whatsapp = document.getElementById('inp-whatsapp').value; state.config.updateTime = document.getElementById('inp-time').value;
                SafeStorage.setItem(`config_${state.user.uid}`, JSON.stringify(state.config));
                try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "saveConfig", merchantId: state.user.uid, data: state.config }) }); } catch(e){}
                setTimeout(() => app.toggleLoading(false), 500);
            },
            loadData: async () => {
                app.toggleLoading(true); state.config = { ...initialState };
                try { const res = await fetch(`${state.apiUrl}?action=getConfig&merchantId=${state.merchantId}`); const json = await res.json(); if (json.data) state.config = json.data; } catch(e){}
                
                if (state.isClientView) app.renderClient(); else app.renderDashboard();
                if(!state.isClientView) app.loadOrders();
                app.toggleLoading(false);
            },
            loadOrders: async () => {
                const list = document.getElementById('orders-list'); list.innerHTML = '...'; let orders = [];
                try { const res = await fetch(`${state.apiUrl}?action=getOrders&merchantId=${state.merchantId}`); const json = await res.json(); if (json.orders) orders = json.orders; } catch(e){}
                
                if (!orders.length) list.innerHTML = '<div class="text-center py-10 text-slate-400">Sin pedidos</div>';
                else list.innerHTML = orders.map(o => `<div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 mb-2"><div class="flex justify-between font-bold text-slate-800"><span>${o.clientName}</span><span class="text-xs bg-emerald-100 px-2 py-0.5 rounded text-emerald-800">${o.shippingDate}</span></div><div class="text-xs text-slate-500 mt-1">${o.clientAgency ? `Agencia: ${o.clientAgency}` : `Direcci√≥n: ${o.clientAddress}`}</div></div>`).join('');
            },

            // UI
            setTab: (t) => { ['config','share','orders'].forEach(x => { document.getElementById(`tab-${x}`).classList.add('hidden'); document.getElementById(`nav-${x}`).className = "nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-500 hover:bg-slate-50 transition"; }); document.getElementById(`tab-${t}`).classList.remove('hidden'); document.getElementById(`nav-${t}`).className = "nav-item p-3 rounded-lg text-sm font-bold bg-emerald-50 text-emerald-700 text-left flex gap-3 items-center transition ring-1 ring-emerald-100"; if(t==='share') app.updateShareLink(); },
            updateShareLink: () => { document.getElementById('share-link').innerText = `${window.location.origin}${window.location.pathname}?merchant=${state.user.uid}`; },
            copyLink: () => { navigator.clipboard.writeText(document.getElementById('share-link').innerText); alert("¬°Copiado!"); },
            shareOnWhatsapp: () => { window.open(`https://wa.me/?text=${encodeURIComponent("Haz tu pedido aqu√≠: " + document.getElementById('share-link').innerText)}`, '_blank'); },
            openLink: () => { window.open(document.getElementById('share-link').innerText, '_blank'); },
            toggleLoading: (show) => { const el = document.getElementById('loading-overlay'); show ? (el.classList.remove('hidden'), setTimeout(()=>el.classList.remove('opacity-0'),10)) : (el.classList.add('opacity-0'), setTimeout(()=>el.classList.add('hidden'),300)); },
            toggleConfigItem: (k, v) => { if (state.config[k].includes(v)) state.config[k] = state.config[k].filter(i => i !== v); else state.config[k].push(v); app.renderDashboard(); },
            
            renderDashboard: () => {
                document.getElementById('inp-store-name').value = state.config.merchantName || ''; document.getElementById('inp-whatsapp').value = state.config.whatsapp || ''; document.getElementById('inp-time').value = state.config.updateTime || '';
                document.getElementById('container-couriers').innerHTML = ALL_COURIERS.map(c => `<div onclick="app.toggleConfigItem('couriers','${c}')" class="cursor-pointer border rounded p-2 text-xs font-bold flex items-center gap-2 select-none ${state.config.couriers.includes(c)?'bg-blue-50 border-blue-500 text-blue-700':'bg-white hover:bg-slate-50 text-slate-600'}"><div class="w-3 h-3 border rounded flex items-center justify-center ${state.config.couriers.includes(c)?'bg-blue-600 border-blue-600':''}">${state.config.couriers.includes(c)?'<i data-lucide="check" class="w-2 h-2 text-white"></i>':''}</div>${c}</div>`).join('');
                document.getElementById('container-days').innerHTML = ALL_DAYS.map(d => `<button onclick="app.toggleConfigItem('shippingDays','${d}')" class="px-3 py-1 rounded text-xs font-bold border ${state.config.shippingDays.includes(d)?'bg-emerald-500 text-white border-emerald-500':'bg-white text-slate-500 hover:bg-slate-50'}">${d}</button>`).join('');
                lucide.createIcons();
            },
            
            renderClient: () => {
                document.getElementById('client-title').innerText = state.config.merchantName || "Tienda"; document.getElementById('client-time').innerText = state.config.updateTime || "--:--";
                
                // Render Couriers Dropdown options
                const cl = state.config.couriers || [];
                const courierSelect = document.getElementById('c-courier-select');
                if (cl.length > 0) {
                     courierSelect.innerHTML = '<option value="" disabled selected>Elige una opci√≥n...</option>' + 
                        cl.map(c => `<option value="${c}">${c}</option>`).join('');
                } else {
                    courierSelect.innerHTML = '<option value="" disabled selected>Sin couriers configurados</option>';
                }
                
                app.generateDateOptions();
                app.loadExternalLists(); 
                lucide.createIcons();
            },

            init: () => {
                state.apiUrl = DEFAULT_API_URL;
                app.updateConnectionStatus();

                const params = new URLSearchParams(window.location.search);
                const mid = params.get('merchant');
                document.getElementById('view-client').classList.add('hidden'); document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-auth').classList.add('hidden'); document.getElementById('view-admin').classList.add('hidden');

                if (mid) { 
                    state.isClientView = true; state.merchantId = mid;
                    document.getElementById('view-client').classList.remove('hidden');
                    document.getElementById('debug-panel').classList.remove('hidden');
                    document.getElementById('btn-toggle-label').innerText = "Ir a Login";
                    document.getElementById('btn-toggle-view').onclick = () => { try{ history.pushState({},'',location.pathname); }catch(e){} app.init(); };
                    app.loadData();
                } else {
                    const storedUser = SafeStorage.getItem('app_current_user');
                    if (storedUser) { 
                        state.user = JSON.parse(storedUser); 
                        if(state.user.isAdmin) {
                            document.getElementById('view-admin').classList.remove('hidden');
                            app.adminLoadUsers();
                        } else {
                            state.merchantId = state.user.uid;
                            document.getElementById('view-dashboard').classList.remove('hidden');
                            document.getElementById('user-display').innerText = state.user.phone; 
                            document.getElementById('debug-panel').classList.remove('hidden');
                            document.getElementById('btn-toggle-view').onclick = () => { 
                                app.saveConfig().then(() => { try{ const u = new URL(location); u.searchParams.set('merchant',state.user.uid); history.pushState({},'',u); }catch(e){} state.isClientView=true; state.merchantId=state.user.uid; document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-client').classList.remove('hidden'); document.getElementById('btn-toggle-label').innerText="Volver Panel"; document.getElementById('btn-toggle-view').onclick=()=>app.init(); app.loadData(); });
                            };
                            app.setTab('config'); app.loadData();
                        }
                    } else { 
                        document.getElementById('view-auth').classList.remove('hidden');
                        document.getElementById('debug-panel').classList.add('hidden');
                    }
                }
                lucide.createIcons();
            }
        };
        app.init();
    </script>
</body>
</html>
