<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Log√≠stica B2B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modals & Sheets */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background-color: white; display: block !important; z-index: 9999; }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] overflow-hidden flex flex-col">

    <!-- OVERLAY CARGA -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-[9999] flex flex-col items-center justify-center transition-opacity duration-300 hidden pointer-events-none opacity-0">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-emerald-600"></div>
        <p id="loading-text" class="text-slate-600 font-medium mt-4 animate-pulse">Conectando...</p>
    </div>

    <!-- MODAL CONFIRMACI√ìN GEN√âRICO -->
    <div id="modal-confirm" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <div id="modal-card" class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl transform scale-95 transition-transform duration-200">
            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mb-4 text-indigo-600">
                <i data-lucide="alert-circle" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-900 mb-2">Confirmaci√≥n</h3>
            <p id="modal-msg" class="text-slate-600 text-sm mb-6 leading-relaxed text-center">...</p>
            <div class="flex gap-3">
                <button onclick="app.closeModal('modal-confirm')" class="flex-1 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition">Cancelar</button>
                <button id="modal-btn-confirm" class="flex-1 py-3 rounded-xl font-bold bg-indigo-600 text-white hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL SELECCI√ìN DE ESTADO (ACTION SHEET) -->
    <div id="modal-status" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden flex flex-col justify-end md:justify-center items-center transition-opacity duration-200 opacity-0">
        <div id="modal-status-card" class="bg-white w-full md:w-96 md:rounded-2xl rounded-t-2xl p-6 shadow-2xl transform translate-y-full md:translate-y-10 transition-transform duration-300">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6 md:hidden"></div>
            <h3 class="text-lg font-bold text-slate-900 mb-4 text-center">Actualizar Estado</h3>
            <p class="text-xs text-slate-500 text-center mb-6">Se aplicar√° a los elementos seleccionados.</p>
            
            <div class="space-y-3">
                <button onclick="app.setStatus('ENVIADO')" class="w-full py-4 rounded-xl font-bold bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200 flex items-center justify-center gap-3">
                    <i data-lucide="truck" class="w-5 h-5"></i> MARCAR COMO ENVIADO
                </button>
                <button onclick="app.setStatus('PENDIENTE')" class="w-full py-4 rounded-xl font-bold bg-yellow-50 text-yellow-700 hover:bg-yellow-100 border border-yellow-200 flex items-center justify-center gap-3">
                    <i data-lucide="clock" class="w-5 h-5"></i> MARCAR COMO PENDIENTE
                </button>
                <button onclick="app.closeModal('modal-status')" class="w-full py-3 rounded-xl font-bold text-slate-400 hover:bg-slate-50 mt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-slate-900 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 transition-all duration-300 -translate-y-20 opacity-0">
        <i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>
        <span id="toast-msg" class="font-bold text-sm">Acci√≥n completada</span>
    </div>

    <!-- √ÅREA DE IMPRESI√ìN -->
    <div id="print-area" class="hidden bg-white p-4"></div>

    <!-- VISTA AUTH (Login) -->
    <div id="view-auth" class="flex-1 h-full flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-100 to-emerald-50 hidden overflow-y-auto no-print">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden border border-slate-100 slide-up my-auto">
            <div class="bg-slate-900 p-8 text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="box" class="w-32 h-32 text-white"></i></div>
                <div class="relative z-10">
                    <h1 class="text-2xl font-bold text-white">Log√≠stica Pro</h1>
                    <div id="connection-status" class="inline-flex items-center gap-1.5 bg-white/10 px-3 py-1 rounded-full text-[10px] font-medium text-white/80 mt-2 backdrop-blur-sm">
                        <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> Sistema Seguro
                    </div>
                </div>
            </div>

            <div class="p-8">
                <form onsubmit="app.handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase ml-1 mb-1">WhatsApp</label>
                        <input id="auth-phone" type="tel" required placeholder="Ingresa tu n√∫mero" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-emerald-500 transition font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase ml-1 mb-1">Contrase√±a</label>
                        <input id="auth-pass" type="password" required placeholder="Tu clave asignada" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-emerald-500 transition">
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2">
                        Iniciar Sesi√≥n
                    </button>
                </form>
                <p id="auth-error" class="text-red-500 text-xs text-center mt-4 font-bold hidden"></p>
                <div class="mt-6 text-center text-xs text-slate-400 border-t pt-4">
                    Acceso exclusivo para socios registrados.
                </div>
            </div>
        </div>
        <div class="mt-8 text-[10px] font-bold text-slate-300 uppercase tracking-widest">
            POWERED BY LATAM5S
        </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="view-admin" class="flex-1 flex flex-col h-full hidden bg-slate-100 no-print overflow-hidden">
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md z-20">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-500 p-2 rounded-lg"><i data-lucide="shield" class="w-5 h-5"></i></div>
                <h1 class="font-bold text-lg">Panel Administrador</h1>
            </div>
            <button onclick="app.logout()" class="text-xs font-bold bg-white/10 hover:bg-white/20 px-3 py-2 rounded transition">Salir</button>
        </header>
        <main class="flex-1 p-4 md:p-8 overflow-y-auto max-w-5xl mx-auto w-full space-y-6 pb-20">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-indigo-600"></i> Alta de Emprendedor</h2>
                <form onsubmit="app.adminCreateUser(event)" class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">WhatsApp del Cliente</label>
                        <input id="admin-new-phone" type="tel" required placeholder="Ej: 999888777" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="w-full md:w-40">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Plan</label>
                        <select id="admin-new-plan" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                            <option value="Gratis">Gratis</option>
                            <option value="Pro">Pro</option>
                            <option value="Empresa">Empresa</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full md:w-auto bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2 shadow-lg shadow-indigo-100">
                        <i data-lucide="zap" class="w-4 h-4"></i> Crear
                    </button>
                </form>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800">Usuarios Registrados</h2>
                    <button onclick="app.adminLoadUsers()" class="p-2 hover:bg-slate-50 rounded-full text-slate-400"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 uppercase text-xs"><tr><th class="px-6 py-3">WhatsApp</th><th class="px-6 py-3">Plan</th><th class="px-6 py-3">Fecha Alta</th><th class="px-6 py-3 text-right">Acciones</th></tr></thead><tbody id="admin-users-list" class="divide-y divide-slate-100"></tbody></table>
                </div>
            </div>
            <div class="text-center text-[10px] text-slate-400 mt-8 uppercase font-bold tracking-widest">
                POWERED BY LATAM5S
            </div>
        </main>
    </div>

    <!-- VISTA DASHBOARD (EMPRENDEDOR) -->
    <div id="view-dashboard" class="flex-1 flex flex-col md:flex-row h-full hidden no-print overflow-hidden">
        <aside class="w-full md:w-72 bg-white border-b md:border-r border-slate-200 flex flex-col shadow-sm z-20 flex-shrink-0">
            <!-- HEADER ADAPTATIVO -->
            <div class="p-4 md:p-6 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-emerald-100 p-2 rounded-xl text-emerald-600"><i data-lucide="package" class="w-6 h-6"></i></div>
                    <div>
                        <h1 class="font-bold text-lg text-slate-800 leading-tight">Mi Panel</h1>
                        <p class="text-xs text-slate-400 hidden md:block">Emprendedor</p>
                    </div>
                </div>
                <!-- CONTROLES SOLO M√ìVIL -->
                <div class="flex items-center gap-3 md:hidden">
                    <div class="text-right">
                        <p class="user-phone-display text-xs font-bold text-slate-700">...</p>
                        <p class="user-plan-display text-[10px] font-bold text-indigo-600 bg-indigo-50 px-1 rounded">...</p>
                    </div>
                    <button onclick="app.logout()" class="bg-red-50 text-red-500 p-2 rounded-lg hover:bg-red-100 transition">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <nav class="flex md:flex-col p-2 gap-1 overflow-x-auto no-scrollbar">
                <button onclick="app.setTab('config')" id="nav-config" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center bg-emerald-50 text-emerald-700 whitespace-nowrap"><i data-lucide="settings" class="w-4 h-4"></i> Configurar</button>
                <button onclick="app.setTab('share')" id="nav-share" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-500 hover:bg-slate-50 whitespace-nowrap"><i data-lucide="share-2" class="w-4 h-4"></i> Compartir</button>
                <button onclick="app.setTab('orders')" id="nav-orders" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-500 hover:bg-slate-50 whitespace-nowrap"><i data-lucide="truck" class="w-4 h-4"></i> Env√≠os</button>
            </nav>
            
            <!-- FOOTER ESCRITORIO -->
            <div class="mt-auto p-4 border-t border-slate-100 hidden md:block">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i data-lucide="phone" class="w-4 h-4 text-slate-500"></i></div>
                    <div class="overflow-hidden">
                        <p class="user-phone-display text-sm font-bold text-slate-700 truncate">...</p>
                        <p class="user-plan-display text-[10px] font-bold text-indigo-600 uppercase tracking-wide bg-indigo-50 px-1.5 py-0.5 rounded w-fit mt-0.5">PLAN GRATIS</p>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full text-red-500 text-xs font-bold hover:bg-red-50 py-2 rounded transition">Cerrar Sesi√≥n</button>
                <div class="text-center text-[9px] text-slate-300 mt-4 uppercase font-bold tracking-widest">
                    POWERED BY LATAM5S
                </div>
            </div>
        </aside>
        
        <!-- Contenedor Principal Ajustado -->
        <main class="flex-1 bg-slate-50/50 relative overflow-hidden flex flex-col">
            
            <!-- PESTA√ëA CONFIGURACI√ìN -->
            <div id="tab-config" class="tab-content w-full h-full overflow-y-auto p-4 md:p-8 hidden no-scrollbar">
                <div class="max-w-2xl mx-auto space-y-6 slide-up pb-32">
                    <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-slate-800">Configuraci√≥n</h2><button id="btn-save-config" onclick="app.saveConfig()" class="bg-slate-900 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition flex gap-2"><i data-lucide="save" class="w-4 h-4"></i> Guardar</button></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                        <h3 class="font-bold text-slate-800">Datos P√∫blicos</h3>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Nombre Tienda</label><input id="inp-store-name" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">WhatsApp Pedidos</label><input id="inp-whatsapp" type="tel" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-emerald-500 outline-none"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                        <h3 class="font-bold text-slate-800">Log√≠stica</h3>
                        <label class="text-xs font-bold text-slate-400 uppercase">Couriers</label><div id="container-couriers" class="grid grid-cols-2 gap-2"></div>
                        <label class="text-xs font-bold text-slate-400 uppercase block mt-4">D√≠as Env√≠o</label><div id="container-days" class="flex flex-wrap gap-2"></div>
                        <div class="flex items-center gap-2 mt-2"><span class="text-sm font-bold text-slate-600">Hora Corte:</span><input type="time" id="inp-time" class="border rounded px-2 py-1 text-sm"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="lock" class="w-4 h-4 text-indigo-500"></i> Seguridad</h3>
                        <div class="flex gap-2 items-end"><div class="flex-1"><label class="text-xs font-bold text-slate-400 uppercase">Nueva Contrase√±a</label><input id="inp-new-pass" type="password" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-indigo-500 outline-none"></div><button id="btn-change-pass" onclick="app.changePassword()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition h-[42px]">Actualizar</button></div>
                    </div>
                    <div class="text-center text-[10px] text-slate-300 uppercase font-bold tracking-widest pt-8">
                        POWERED BY LATAM5S
                    </div>
                </div>
            </div>
            
            <!-- PESTA√ëA COMPARTIR -->
            <div id="tab-share" class="tab-content w-full h-full overflow-y-auto p-4 hidden no-scrollbar">
                <div class="min-h-full flex flex-col items-center justify-center py-8 pb-32">
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 text-center max-w-md w-full slide-up">
                        <div class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600"><i data-lucide="share-2" class="w-8 h-8"></i></div>
                        
                        <h2 class="text-xl font-bold mb-4">Enlace P√∫blico</h2>
                        <p class="text-slate-600 text-sm mb-6 leading-relaxed">
                            ¬°Listo para compartir! <br>
                            Tu formulario personalizado est√° activo. Comparte el siguiente enlace con tus clientes para que registren sus env√≠os.
                        </p>

                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 break-all"><code id="share-link" class="text-xs text-indigo-600 font-bold select-all">...</code></div>
                        
                        <div class="space-y-3">
                            <button id="btn-copy-link" onclick="app.copyLink()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Copiar Link</button>
                            <button onclick="app.shareOnWhatsapp()" class="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold hover:bg-emerald-600 transition flex items-center justify-center gap-2"><i data-lucide="message-circle" class="w-4 h-4"></i> Enviar por WhatsApp</button>
                            <button onclick="app.openClientLink()" class="w-full bg-white border-2 border-indigo-100 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-50 transition flex items-center justify-center gap-2"><i data-lucide="external-link" class="w-4 h-4"></i> Abrir en nueva pesta√±a</button>
                        </div>
                    </div>
                    <div class="text-center text-[10px] text-slate-300 uppercase font-bold tracking-widest mt-8">
                        POWERED BY LATAM5S
                    </div>
                </div>
            </div>
            
            <!-- PESTA√ëA ENV√çOS OPTIMIZADA -->
            <div id="tab-orders" class="tab-content hidden w-full h-full flex flex-col p-3 md:p-8">
                <!-- Header eliminado -->
                
                <!-- Toolbar Compacta 2 L√≠neas -->
                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm mb-3 flex flex-col gap-3 flex-shrink-0">
                    <!-- L√≠nea 1: Filtros (Buscador + Fecha) -->
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                            <input id="inp-search-orders" oninput="app.renderOrders()" class="w-full pl-9 pr-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Buscar...">
                        </div>
                        <input type="date" id="date-specific" onchange="app.renderOrders()" class="border rounded-lg px-2 py-2 text-sm w-32 text-slate-600 focus:ring-2 focus:ring-emerald-500 outline-none flex-shrink-0">
                    </div>
                    
                    <!-- L√≠nea 2: Herramientas y Acciones en Scroll Horizontal -->
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1">
                        <!-- Grupo Selecci√≥n -->
                        <button onclick="app.toggleAllSelection()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-2 flex-shrink-0 border border-slate-200">
                            <i data-lucide="check-square" class="w-4 h-4"></i> <span class="hidden sm:inline">Todo</span>
                        </button>
                        
                        <div class="h-6 w-px bg-slate-200 mx-1 flex-shrink-0"></div>
                        
                        <!-- Grupo Herramientas -->
                        <button onclick="app.printLabels()" class="px-3 py-2 bg-slate-50 text-slate-700 border border-slate-200 rounded-lg font-bold hover:bg-slate-100 transition flex items-center justify-center gap-2 text-xs flex-shrink-0">
                            <i data-lucide="printer" class="w-4 h-4"></i> <span class="hidden sm:inline">Etiquetas</span>
                        </button>
                        <button onclick="app.exportExcel()" class="px-3 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-lg font-bold hover:bg-emerald-100 transition flex items-center justify-center gap-2 text-xs flex-shrink-0">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> <span class="hidden sm:inline">Excel</span>
                        </button>
                        <button onclick="app.loadOrders()" class="px-3 py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 text-slate-600 flex-shrink-0">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>

                        <div class="h-6 w-px bg-slate-200 mx-1 flex-shrink-0"></div>

                        <!-- Grupo Acciones -->
                        <button onclick="app.openStatusMenu()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-1 flex-shrink-0 shadow-sm">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> <span class="hidden sm:inline">Estado</span>
                        </button>
                        <button onclick="app.deleteSelected()" class="px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-2 flex-shrink-0">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Lista -->
                <div class="flex-1 min-h-0 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm relative">
                    <div class="overflow-y-auto p-2 space-y-1 h-full pb-32" id="orders-list">
                        <!-- Items inyectados -->
                    </div>
                </div>
                
                <div class="text-center text-[10px] text-slate-300 uppercase font-bold tracking-widest mt-4 md:hidden pb-2">
                    POWERED BY LATAM5S
                </div>
            </div>
        </main>
    </div>

    <!-- VISTA CLIENTE -->
    <div id="view-client" class="flex-1 h-full hidden overflow-y-auto no-print bg-slate-50">
        <div class="max-w-2xl mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
            <div class="bg-slate-900 text-white p-6 sticky top-0 z-30 shadow-md flex items-center gap-3">
                <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center"><i data-lucide="shopping-bag" class="w-5 h-5 text-emerald-400"></i></div>
                <div><h1 id="client-title" class="font-bold text-lg leading-tight">Cargando...</h1><p class="text-xs text-slate-400">Datos de Env√≠o</p></div>
            </div>

            <div class="flex-1 p-6 space-y-8 pb-32">
                <div class="bg-orange-50 border-l-4 border-orange-400 p-4 rounded-r-lg shadow-sm"><p class="text-xs text-orange-700">üìÖ Pedidos para hoy cierran a las <strong id="client-time">--:--</strong>.</p></div>

                <form id="client-form" onsubmit="app.submitOrder(event)" class="space-y-8">
                    <!-- PASO 1 -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-2">Agencia / Delivery</label>
                                <div class="relative">
                                    <select id="c-courier-select" onchange="app.onCourierChange(this.value)" class="w-full appearance-none bg-white border border-slate-300 rounded-xl py-3 pl-4 pr-10 text-slate-700 font-medium focus:ring-2 focus:ring-slate-800 outline-none cursor-pointer">
                                        <option value="" disabled selected>Elige una opci√≥n...</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><i data-lucide="chevron-down" class="w-4 h-4"></i></div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-2">Fecha de Despacho</label>
                                <div class="relative">
                                    <select id="c-date-select" onchange="app.validateForm()" class="w-full appearance-none bg-white border border-slate-300 rounded-xl py-3 pl-4 pr-10 text-slate-700 font-medium focus:ring-2 focus:ring-slate-800 outline-none cursor-pointer">
                                        <option value="" disabled selected>Elige fecha...</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500"><i data-lucide="calendar" class="w-4 h-4"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PASO 2 -->
                    <div id="dynamic-form-section" class="hidden space-y-4 fade-in">
                        
                        <!-- AGENCIA -->
                        <div id="fields-agency" class="hidden space-y-4">
                            <!-- 1. Sede -->
                            <div class="relative z-20">
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="h-5 w-5 text-slate-400"></i></div>
                                    <input id="c-agency" type="text" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl pl-10 pr-10 py-3 outline-none focus:ring-2 focus:ring-slate-800 transition placeholder-slate-400" placeholder="Buscar Sede (Calle / Distrito)..." autocomplete="off" oninput="app.searchAgency(this.value)">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center"><button type="button" id="btn-clear-agency" onclick="app.clearAgency()" class="hidden text-slate-400 hover:text-slate-600 p-1"><i data-lucide="x" class="h-5 w-5"></i></button></div>
                                    <div id="agency-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-slate-200 rounded-xl shadow-2xl max-h-64 overflow-y-auto z-50 divide-y divide-slate-100"></div>
                                </div>
                            </div>
                            <!-- 2. DNI -->
                            <div><input id="c-dni" type="tel" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition" placeholder="DNI / CE"></div>
                        </div>

                        <!-- DOMICILIO -->
                        <div id="fields-home" class="hidden space-y-4">
                            <!-- 1. Distrito -->
                            <div class="relative z-20">
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="map-pin" class="h-5 w-5 text-slate-400"></i></div>
                                    <input id="c-district" type="text" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl pl-10 pr-10 py-3 outline-none focus:ring-2 focus:ring-slate-800 transition placeholder-slate-400" placeholder="Buscar Distrito..." autocomplete="off" oninput="app.searchDistrict(this.value)">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center"><button type="button" id="btn-clear-district" onclick="app.clearDistrict()" class="hidden text-slate-400 hover:text-slate-600 p-1"><i data-lucide="x" class="h-5 w-5"></i></button></div>
                                    <div id="district-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-slate-200 rounded-xl shadow-2xl max-h-64 overflow-y-auto z-50 divide-y divide-slate-100"></div>
                                    </div>
                            </div>
                            <!-- 2. Direccion -->
                            <div><input id="c-address" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition" placeholder="Direcci√≥n Exacta (Calle / Av / Jr)"></div>
                            <!-- 3. Referencia -->
                            <div><input id="c-ref" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition" placeholder="Referencia (Frente a...)"></div>
                        </div>

                        <!-- GENERICOS -->
                        <div class="space-y-4 pt-1">
                            <div><input id="c-name" required class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition" placeholder="Nombre Completo"></div>
                            <div><input id="c-phone" type="tel" required class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-slate-800 transition" placeholder="Celular / WhatsApp"></div>
                        </div>

                    </div>

                    <!-- FOOTER -->
                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-200 flex justify-center max-w-2xl mx-auto z-10">
                        <button type="submit" id="btn-submit-order" disabled class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="message-circle" class="w-6 h-6"></i> Enviar Datos
                        </button>
                    </div>
                </form>
                
                <div class="text-center text-[10px] text-slate-300 uppercase font-bold tracking-widest mt-8 pb-4">
                    POWERED BY LATAM5S
                </div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbzWQ_j4OzEZcbGvrNNB8UcmbBk644m9Ta70xeLU7CfvVZUwY03LpHezAgqj2G9BxBxqnQ/exec";
        const JSON_DISTRITOS = "https://raw.githubusercontent.com/complicidad/form/main/lstDinsides.json";
        const JSON_SHALOM = "https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json";

        const COURIER_TYPES = { "Shalom": "agency", "Olva Courier": "agency", "Flores": "agency", "Cruz del Sur": "agency", "Rappi": "home", "PedidosYa": "home", "Motorizado": "home", "DHL": "home", "FedEx": "home", "Tienda": "home" };
        const SafeStorage = { memory: {}, setItem: function(k, v) { try { localStorage.setItem(k, v); } catch(e) { this.memory[k] = v; } }, getItem: function(k) { try { return localStorage.getItem(k); } catch(e) { return this.memory[k] || null; } }, removeItem: function(k) { try { localStorage.removeItem(k); } catch(e) { delete this.memory[k]; } } };
        const ALL_COURIERS = ["Olva Courier", "Shalom", "Rappi", "PedidosYa", "DHL", "FedEx", "Motorizado", "Tienda"];
        const ALL_DAYS = ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"];
        const DAY_INDEX_MAP = { "Dom": 0, "Lun": 1, "Mar": 2, "Mi√©": 3, "Jue": 4, "Vie": 5, "S√°b": 6 };
        const DAY_NAMES_FULL = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        const MONTH_NAMES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const initialState = { merchantName: "", whatsapp: "", couriers: [], shippingDays: [], updateTime: "18:00" };
        const state = { user: null, merchantId: null, apiUrl: DEFAULT_API_URL, isClientView: false, config: { ...initialState }, selectedCourierType: null, externalData: {}, allOrders: [], selectedOrders: new Set(), visibleOrders: [] };

        // Helper para sanitizar XSS
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        window.app = {
            toggleLoading: (show) => { const el = document.getElementById('loading-overlay'); show ? (el.classList.remove('hidden'), setTimeout(()=>el.classList.remove('opacity-0'),10)) : (el.classList.add('opacity-0'), setTimeout(()=>el.classList.add('hidden'),300)); },
            
            // --- UI HELPERS: Modal & Toast ---
            showModal: (msg, callback) => {
                const el = document.getElementById('modal-confirm'), card = document.getElementById('modal-card');
                document.getElementById('modal-msg').innerText = msg;
                document.getElementById('modal-btn-confirm').onclick = () => { callback(); app.closeModal('modal-confirm'); };
                el.classList.remove('hidden');
                setTimeout(() => { el.classList.remove('opacity-0'); card.classList.remove('scale-95'); card.classList.add('scale-100'); }, 10);
            },
            
            // Nuevo: Control gen√©rico de modales
            closeModal: (modalId) => {
                const el = document.getElementById(modalId);
                if (!el) return;
                // Busca el primer hijo directo que sea la tarjeta
                const card = el.firstElementChild; 
                el.classList.add('opacity-0'); 
                if(card) {
                    card.classList.remove('scale-100', 'translate-y-0', 'md:translate-y-10'); 
                    card.classList.add('scale-95', 'translate-y-full');
                }
                setTimeout(() => el.classList.add('hidden'), 300);
            },
            
            openStatusMenu: () => {
                if (state.selectedOrders.size === 0) return app.showToast('Selecciona al menos un env√≠o');
                
                const el = document.getElementById('modal-status'), card = document.getElementById('modal-status-card');
                el.classList.remove('hidden');
                setTimeout(() => { 
                    el.classList.remove('opacity-0'); 
                    card.classList.remove('translate-y-full'); 
                    card.classList.add('translate-y-0'); // Mobile reset
                }, 10);
            },

            setStatus: (newStatus) => {
                app.closeModal('modal-status');
                app.showModal(`¬øCambiar ${state.selectedOrders.size} env√≠os a ${newStatus}?`, async () => {
                    app.toggleLoading(true);
                    const ids = Array.from(state.selectedOrders);
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "updateOrdersStatus", merchantId: state.merchantId, orderIds: ids, newStatus: newStatus }) }); app.showToast('Estados actualizados'); app.loadOrders(); } catch(e) {}
                    app.toggleLoading(false);
                });
            },
            
            showToast: (msg) => {
                const el = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                el.classList.remove('opacity-0', '-translate-y-20');
                setTimeout(() => el.classList.add('opacity-0', '-translate-y-20'), 3000);
            },
            // -------------------------------

            loadExternalLists: async () => { try { if(!state.externalData.districts) { const res = await fetch(JSON_DISTRITOS); const data = await res.json(); state.externalData.districts = data.map(d => d.Distrito || d.nombre); } if(!state.externalData.agencies) { const res = await fetch(JSON_SHALOM); state.externalData.agencies = await res.json(); } } catch(e) { console.error(e); } },
            scrollToEl: (el) => { setTimeout(() => { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100); },

            searchAgency: (q) => { const c = document.getElementById('agency-results'), x = document.getElementById('btn-clear-agency'); if (!q) { c.classList.add('hidden'); x.classList.add('hidden'); return; } x.classList.remove('hidden'); if(q.length<2) { c.classList.add('hidden'); return; } const lq = q.toLowerCase(); const m = (state.externalData.agencies||[]).filter(a => (a.Agencia && a.Agencia.toLowerCase().includes(lq)) || (a.Direccion && a.Direccion.toLowerCase().includes(lq))).slice(0,50); c.innerHTML = m.length ? m.map(a => `<div onclick="app.selectAgency('${escapeHtml(a.Agencia).replace(/'/g,"\\'")}','${escapeHtml(a.Direccion).replace(/'/g,"\\'").replace(/\n/g," ")}')" class="p-4 cursor-pointer hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><p class="font-bold text-slate-800 text-sm mb-1">${escapeHtml(a.Agencia)}</p><p class="text-xs text-slate-500">${escapeHtml(a.Direccion)}</p></div>`).join('') : '<div class="p-4 text-slate-400 text-sm text-center">Sin resultados</div>'; c.classList.remove('hidden'); },
            selectAgency: (n, a) => { document.getElementById('c-agency').value = `${n} - ${a}`; document.getElementById('agency-results').classList.add('hidden'); document.getElementById('btn-clear-agency').classList.remove('hidden'); },
            clearAgency: () => { const i = document.getElementById('c-agency'); i.value=''; document.getElementById('agency-results').classList.add('hidden'); document.getElementById('btn-clear-agency').classList.add('hidden'); i.focus(); },
            searchDistrict: (q) => { const c = document.getElementById('district-results'), x = document.getElementById('btn-clear-district'); if (!q) { c.classList.add('hidden'); x.classList.add('hidden'); return; } x.classList.remove('hidden'); if(q.length<1) { c.classList.add('hidden'); return; } const lq = q.toLowerCase(); const m = (state.externalData.districts||[]).filter(d => d.toLowerCase().includes(lq)).slice(0,50); c.innerHTML = m.length ? m.map(d => `<div onclick="app.selectDistrict('${escapeHtml(d).replace(/'/g,"\\'")}')" class="p-4 cursor-pointer hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><p class="font-bold text-slate-800 text-sm">${escapeHtml(d)}</p></div>`).join('') : '<div class="p-4 text-slate-400 text-sm text-center">Sin resultados</div>'; c.classList.remove('hidden'); },
            selectDistrict: (v) => { document.getElementById('c-district').value = v; document.getElementById('district-results').classList.add('hidden'); document.getElementById('btn-clear-district').classList.remove('hidden'); },
            clearDistrict: () => { const i = document.getElementById('c-district'); i.value=''; document.getElementById('district-results').classList.add('hidden'); document.getElementById('btn-clear-district').classList.add('hidden'); i.focus(); },

            generateDateOptions: () => { const s = document.getElementById('c-date-select'); s.innerHTML = '<option value="" disabled selected>Elige una fecha...</option>'; const ad = state.config.shippingDays || []; if (!ad.length) return; const now = new Date(); const [ch, cm] = (state.config.updateTime || "18:00").split(':').map(Number); const cut = new Date(now); cut.setHours(ch, cm, 0, 0); for(let i=0;i<14;i++) { const f = new Date(now); f.setDate(now.getDate()+i); if(i===0 && now>cut) continue; const di = f.getDay(); if(ad.some(n => DAY_INDEX_MAP[n]===di)) { const val = `${DAY_NAMES_FULL[di]} ${f.getDate().toString().padStart(2,'0')}/${(f.getMonth()+1).toString().padStart(2,'0')}`; const lbl = `${DAY_NAMES_FULL[di]} ${f.getDate()} ${MONTH_NAMES[f.getMonth()]}`; const o = document.createElement('option'); o.value = val; o.innerText = lbl; s.appendChild(o); } } },
            onCourierChange: (c) => { const type = COURIER_TYPES[c] || "home"; state.selectedCourierType = type; state.selectedCourier = c; document.getElementById('dynamic-form-section').classList.remove('hidden'); const af = document.getElementById('fields-agency'), hf = document.getElementById('fields-home'); ['c-dni','c-agency','c-address','c-district'].forEach(id => document.getElementById(id).removeAttribute('required')); if(type === 'agency') { af.classList.remove('hidden'); hf.classList.add('hidden'); document.getElementById('c-dni').setAttribute('required','true'); const ag = document.getElementById('c-agency'); ag.setAttribute('required','true'); ag.value=""; app.clearAgency(); app.clearDistrict(); if(c.includes('Shalom')) ag.placeholder="Escribe para buscar sede..."; else ag.placeholder="Nombre de Agencia / Direcci√≥n"; } else { af.classList.add('hidden'); hf.classList.remove('hidden'); document.getElementById('c-address').setAttribute('required','true'); document.getElementById('c-district').setAttribute('required','true'); app.clearAgency(); app.clearDistrict(); } app.validateForm(); },
            validateForm: () => { const btn = document.getElementById('btn-submit-order'), c = document.getElementById('c-courier-select').value, d = document.getElementById('c-date-select').value; if(c && d) btn.removeAttribute('disabled'); else btn.setAttribute('disabled','true'); },
            
            submitOrder: async (e) => { 
                e.preventDefault(); 
                app.toggleLoading(true); 
                const day = document.getElementById('c-date-select').value, name = document.getElementById('c-name').value, phone = document.getElementById('c-phone').value; 
                let data = { clientName: name, clientPhone: phone, courier: state.selectedCourier, shippingDate: day, createdAt: Date.now(), product: "N/A" }, wa = ""; 
                
                if (state.selectedCourierType === 'agency') { 
                    const dni = document.getElementById('c-dni').value, ag = document.getElementById('c-agency').value; 
                    data.clientDni = dni; data.clientAgency = ag; 
                    wa = `üì¶ *NUEVO ENV√çO (AGENCIA)*\n\nüë§ ${name} | üì± ${phone}\nüÜî DNI: ${dni}\nüè¢ Agencia: ${ag}\n\nüöö ${state.selectedCourier}\nüìÖ ${day}`; 
                } else { 
                    const ad = document.getElementById('c-address').value, ds = document.getElementById('c-district').value, rf = document.getElementById('c-ref').value; 
                    data.clientAddress = ad; data.clientDistrict = ds; data.clientRef = rf; 
                    wa = `üì¶ *NUEVO ENV√çO (CASA)*\n\nüë§ ${name} | üì± ${phone}\nüìç ${ds}\nüè† ${ad}\nüó∫Ô∏è Ref: ${rf}\n\nüöö ${state.selectedCourier}\nüìÖ ${day}`; 
                } 
                
                try { 
                    await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "saveOrder", merchantId: state.merchantId, data: data }) }); 
                    // Limpieza del formulario
                    document.getElementById('client-form').reset();
                    document.getElementById('dynamic-form-section').classList.add('hidden');
                    document.getElementById('btn-submit-order').setAttribute('disabled','true');
                    
                    window.open(`https://wa.me/51${state.config.whatsapp}?text=${encodeURIComponent(wa)}`, '_blank'); 
                } catch(e){} 
                app.toggleLoading(false); 
            },
            
            handleLogin: async (e) => { 
                e.preventDefault(); 
                const p = document.getElementById('auth-phone').value.trim();
                const pw = document.getElementById('auth-pass').value.trim();
                const err = document.getElementById('auth-error'); 
                app.toggleLoading(true); 
                try { 
                    const res = await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "loginUser", data: { phone: p, password: pw } }) }); 
                    const json = await res.json(); 
                    if(json.status === 'success') { app.loginSuccess(json.user); return; } 
                    else { err.innerText = json.message || "Error desconocido"; err.classList.remove('hidden'); app.toggleLoading(false); return; } 
                } catch(e) { console.error(e); err.innerText = "Error de conexi√≥n con el servidor"; err.classList.remove('hidden'); app.toggleLoading(false); } 
            },
            loginSuccess: (u) => { state.user = u; SafeStorage.setItem('app_current_user', JSON.stringify(u)); app.init(); },
            logout: () => { SafeStorage.removeItem('app_current_user'); state.user=null; state.merchantId=null; window.location.reload(); },
            
            adminLoadUsers: async () => { 
                const l = document.getElementById('admin-users-list'); 
                l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">Cargando datos seguros...</td></tr>'; 
                let u = []; 
                try { const res = await fetch(`${state.apiUrl}?action=getUsers`); const json = await res.json(); if(json.users) u = json.users; } catch(e){} 
                l.innerHTML = u.length ? u.map(user => `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-bold text-slate-700">${escapeHtml(user.phone)}</td><td class="px-6 py-4"><span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded">${escapeHtml(user.plan||'Gratis')}</span></td><td class="px-6 py-4 text-xs text-slate-400">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-'}</td><td class="px-6 py-4 text-right flex gap-2 justify-end"><button onclick="app.adminResend('${escapeHtml(user.uid)}','${escapeHtml(user.phone)}')" class="text-indigo-600 text-xs font-bold hover:bg-indigo-50 px-2 py-1 rounded">Clave</button><select onchange="app.adminUpdatePlan('${escapeHtml(user.uid)}', this.value)" class="text-xs border rounded p-1 bg-slate-50 cursor-pointer outline-none"><option value="" disabled selected>Cambiar Plan</option><option value="Gratis">Gratis</option><option value="Pro">Pro</option><option value="Empresa">Empresa</option></select></td></tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center">Base de datos vac√≠a</td></tr>'; 
                app.toggleLoading(false); 
            },
            
            adminUpdatePlan: (uid, newPlan) => { 
                app.showModal(`¬øConfirmas cambiar el plan a ${newPlan}?`, async () => {
                    app.toggleLoading(true); 
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "updateUserPlan", merchantId: uid, newPlan: newPlan }) }); } catch(e){} 
                    app.adminLoadUsers();
                    app.showToast('Plan actualizado');
                });
            },
            
            adminCreateUser: async (e) => { e.preventDefault(); const p = document.getElementById('admin-new-phone').value.trim(), pl = document.getElementById('admin-new-plan').value; app.toggleLoading(true); const np = Math.floor(1000+Math.random()*9000).toString(); try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "registerUser", data: { phone: p, password: np, plan: pl } }) }); } catch(e){} window.open(`https://wa.me/51${p}?text=${encodeURIComponent(`üîê Bienvenid@ (Plan ${pl})\nüì± User: ${p}\nüîë Pass: *${np}*\nEntra: ${window.location.href}`)}`, '_blank'); document.getElementById('admin-new-phone').value=""; app.adminLoadUsers(); app.showToast('Usuario creado con √©xito'); },
            
            adminResend: (uid, phone) => { 
                app.showModal(`¬øResetear clave para ${phone}?`, async () => {
                    app.toggleLoading(true); const np = Math.floor(1000+Math.random()*9000).toString(); 
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "changePassword", merchantId: uid, newPassword: np }) }); } catch(e){} 
                    window.open(`https://wa.me/51${phone}?text=${encodeURIComponent(`üîê Recuperaci√≥n\nüì± ${phone}\nüîë Nueva: *${np}*`)}`, '_blank'); 
                    app.toggleLoading(false);
                    app.showToast('Contrase√±a restablecida');
                });
            },
            
            saveConfig: async () => { 
                const btn = document.getElementById('btn-save-config');
                // Bloqueo de bot√≥n para evitar doble clic
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Guardando...';
                lucide.createIcons();

                app.toggleLoading(true); 
                state.config.merchantName = document.getElementById('inp-store-name').value; 
                state.config.whatsapp = document.getElementById('inp-whatsapp').value; 
                state.config.updateTime = document.getElementById('inp-time').value; 
                
                SafeStorage.setItem(`config_${state.user.uid}`, JSON.stringify(state.config)); 
                try { 
                    await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "saveConfig", merchantId: state.user.uid, data: state.config }) }); 
                } catch(e){} 
                
                setTimeout(() => { 
                    app.toggleLoading(false); 
                    app.showToast('Configuraci√≥n guardada'); 
                    // Restaurar bot√≥n
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Guardar';
                    lucide.createIcons();
                }, 500); 
            },
            
            changePassword: async () => {
                const newPass = document.getElementById('inp-new-pass').value.trim();
                if (!newPass) return;
                app.showModal('¬øEst√°s seguro de cambiar tu contrase√±a actual?', async () => {
                    app.toggleLoading(true);
                    try {
                        await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "changePassword", merchantId: state.user.uid, newPassword: newPass }) });
                        document.getElementById('inp-new-pass').value = "";
                        app.showToast('Contrase√±a actualizada');
                    } catch(e) {}
                    app.toggleLoading(false);
                });
            },
            
            copyLink: () => {
                const text = document.getElementById('share-link').innerText;
                const fallbackCopy = (t) => { const ta = document.createElement("textarea"); ta.value = t; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); };
                if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(text).catch(() => fallbackCopy(text)); else fallbackCopy(text);
                app.showToast('Enlace copiado al portapapeles');
            },

            shareOnWhatsapp: () => {
                const url = document.getElementById('share-link').innerText;
                window.open(`https://wa.me/?text=${encodeURIComponent("Hola! Visita mi tienda de env√≠os: " + url)}`, '_blank');
            },

            openClientLink: () => {
                const url = document.getElementById('share-link').innerText;
                window.open(url, '_blank');
            },
            
            loadData: async () => { 
                app.toggleLoading(true); 
                state.config = { ...initialState }; 
                try { const res = await fetch(`${state.apiUrl}?action=getConfig&merchantId=${state.merchantId}`); const json = await res.json(); if (json.data) state.config = json.data; } catch(e){ const local = SafeStorage.getItem(`config_${state.merchantId}`); if(local) state.config = JSON.parse(local); } 
                
                // UPDATE: Actualizar informaci√≥n de usuario en TODOS los elementos (M√≥vil y Desktop)
                if (state.user) {
                    document.querySelectorAll('.user-phone-display').forEach(el => el.innerText = state.user.phone);
                    if(state.user.plan) {
                        document.querySelectorAll('.user-plan-display').forEach(el => el.innerText = `PLAN ${state.user.plan.toUpperCase()}`);
                    }
                }

                if (state.isClientView) { 
                    app.renderClient(); 
                } else { 
                    app.renderDashboard(); 
                    app.loadOrders(); 
                } 
                app.toggleLoading(false); 
            },
            
            // --- NUEVA L√ìGICA DE PEDIDOS (Filtrado & Selecci√≥n) ---
            loadOrders: async () => { 
                const l = document.getElementById('orders-list'); 
                l.innerHTML = '<div class="text-center py-10 text-slate-400 flex flex-col items-center gap-2"><i data-lucide="loader" class="animate-spin w-6 h-6"></i> Cargando env√≠os...</div>'; 
                lucide.createIcons();
                
                try { 
                    // Anti-cache param
                    const res = await fetch(`${state.apiUrl}?action=getOrders&merchantId=${state.merchantId}&_t=${Date.now()}`); 
                    const json = await res.json(); 
                    state.allOrders = json.orders || []; 
                    state.selectedOrders.clear();
                } catch(e){
                    state.allOrders = [];
                } 
                app.renderOrders();
            },

            renderOrders: () => {
                const l = document.getElementById('orders-list');
                const q = (document.getElementById('inp-search-orders').value || '').toLowerCase();
                const dSpec = document.getElementById('date-specific').value;
                
                const filtered = state.allOrders.filter(x => {
                    const txt = `${x.clientName} ${x.clientPhone} ${x.clientDistrict || ''} ${x.clientAgency || ''}`.toLowerCase();
                    if (!txt.includes(q)) return false;
                    
                    if (dSpec) {
                        const dateA = new Date(x.createdAt || x.date).toLocaleDateString();
                        const [y, m, d] = dSpec.split('-');
                        const dateB = new Date(y, m-1, d).toLocaleDateString();
                        if (dateA !== dateB) return false;
                    }
                    return true;
                });
                
                state.visibleOrders = filtered;

                if (!filtered.length) {
                    l.innerHTML = '<div class="text-center py-10 text-slate-400">Sin env√≠os encontrados</div>';
                    return;
                }

                l.innerHTML = filtered.map((x, idx) => {
                    const id = String(x.orderId || x.createdAt); // FORCE STRING ID
                    const isSel = state.selectedOrders.has(id);
                    const status = x.status || 'PENDIENTE';
                    let badgeClass = 'bg-yellow-100 text-yellow-800';
                    if(status === 'ENVIADO') badgeClass = 'bg-emerald-100 text-emerald-800';

                    return `
                    <div class="bg-white p-3 rounded-lg shadow-sm border ${isSel ? 'border-emerald-500 ring-1 ring-emerald-500 bg-emerald-50/10' : 'border-slate-100'} hover:border-emerald-200 transition group flex gap-3 items-start">
                        <div class="pt-1">
                            <input type="checkbox" onchange="app.toggleOrderSelection('${id}')" ${isSel ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between font-bold text-slate-800">
                                <span class="truncate">${escapeHtml(x.clientName)}</span>
                                <div class="flex gap-2">
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded ${badgeClass}">${status}</span>
                                    <span class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-600 whitespace-nowrap">${escapeHtml(x.shippingDate)}</span>
                                </div>
                            </div>
                            <div class="text-xs text-slate-500 mt-0.5 flex flex-wrap gap-x-3 gap-y-1">
                                <span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${escapeHtml(x.clientPhone)}</span>
                                <span class="flex items-center gap-1"><i data-lucide="truck" class="w-3 h-3"></i> ${escapeHtml(x.courier)}</span>
                            </div>
                            <div class="text-xs text-slate-600 mt-1.5 font-medium border-t border-slate-50 pt-1">
                                ${x.clientAgency ? `üè¢ ${escapeHtml(x.clientAgency)}` : `üè† ${escapeHtml(x.clientDistrict)} - ${escapeHtml(x.clientAddress)}`}
                            </div>
                        </div>
                    </div>
                `}).join('');
                lucide.createIcons();
            },

            toggleOrderSelection: (id) => {
                const strId = String(id); 
                if (state.selectedOrders.has(strId)) state.selectedOrders.delete(strId);
                else state.selectedOrders.add(strId);
                app.renderOrders(); 
            },
            
            toggleAllSelection: () => {
                const allSelected = state.visibleOrders.every(x => state.selectedOrders.has(String(x.orderId || x.createdAt)));
                if (allSelected) state.visibleOrders.forEach(x => state.selectedOrders.delete(String(x.orderId || x.createdAt)));
                else state.visibleOrders.forEach(x => state.selectedOrders.add(String(x.orderId || x.createdAt)));
                app.renderOrders();
            },
            
            deleteSelected: () => {
                if (state.selectedOrders.size === 0) return app.showToast('Selecciona al menos un env√≠o');
                app.showModal(`¬øEliminar ${state.selectedOrders.size} env√≠os?`, async () => {
                    app.toggleLoading(true);
                    const ids = Array.from(state.selectedOrders);
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "deleteOrders", merchantId: state.merchantId, orderIds: ids }) }); app.showToast('Env√≠os eliminados'); app.loadOrders(); } catch(e) {}
                    app.toggleLoading(false);
                });
            },
            
            updateBatchStatus: () => {
                if (state.selectedOrders.size === 0) return app.showToast('Selecciona env√≠os');
                const newStatus = document.getElementById('batch-status-select').value;
                app.showModal(`¬øCambiar ${state.selectedOrders.size} env√≠os a ${newStatus}?`, async () => {
                    app.toggleLoading(true);
                    const ids = Array.from(state.selectedOrders);
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "updateOrdersStatus", merchantId: state.merchantId, orderIds: ids, newStatus: newStatus }) }); app.showToast('Estados actualizados'); app.loadOrders(); } catch(e) {}
                    app.toggleLoading(false);
                });
            },

            exportExcel: () => {
                const list = state.visibleOrders;
                if(!list.length) return app.showToast('No hay datos');
                let csvContent = "\uFEFFFecha,Courier,Cliente,Tel√©fono,Destino,Referencia/DNI,Estado\n";
                list.forEach(x => {
                    const destino = x.clientAgency ? `AGENCIA: ${x.clientAgency}` : `CASA: ${x.clientDistrict} - ${x.clientAddress}`;
                    const ref = x.clientAgency ? `DNI: ${x.clientDni}` : `REF: ${x.clientRef}`;
                    const row = [ x.shippingDate, x.courier, x.clientName.replace(/,/g, ''), x.clientPhone, destino.replace(/,/g, ''), ref.replace(/,/g, ''), x.status || 'PENDIENTE' ].join(",");
                    csvContent += row + "\n";
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `envios_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                app.showToast('Descargando Excel...');
            },

            printLabels: () => {
                const targets = state.selectedOrders.size > 0 ? state.allOrders.filter(x => state.selectedOrders.has(String(x.orderId || x.createdAt))) : state.visibleOrders;
                if(!targets.length) return app.showToast('Nada para imprimir');
                app.doPrint(targets);
            },

            doPrint: (list) => {
                if(!list.length) return;
                const area = document.getElementById('print-area');
                const shopName = state.config.merchantName || "Mi Tienda";
                
                area.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">
                        ${list.map(x => `
                            <div style="border: 1px solid #ddd; padding: 20px; page-break-inside: avoid; font-family: 'Segoe UI', sans-serif; border-radius: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                                    <div style="font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px;">Remitente</div>
                                    <div style="font-weight: bold; font-size: 14px; color: #333;">${escapeHtml(shopName)}</div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <p style="margin: 0; font-size: 10px; color: #a44; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">PARA:</p>
                                    <h2 style="margin: 5px 0; font-size: 20px; font-weight: 800; color: #000; line-height: 1.2;">${escapeHtml(x.clientName).toUpperCase()}</h2>
                                    <p style="margin: 0; font-size: 14px; color: #555; font-family: monospace;">${escapeHtml(x.clientPhone)}</p>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <p style="margin: 0; font-size: 10px; color: #a44; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">DESTINO:</p>
                                    <p style="margin: 5px 0 2px 0; font-size: 13px; color: #333;"><strong>${x.clientAgency ? 'DNI/CE:' : 'REF:'}</strong> ${x.clientAgency ? x.clientDni : x.clientRef}</p>
                                    <p style="margin: 0; font-size: 14px; color: #444; line-height: 1.4;">${x.clientAgency ? `<strong>Agencia:</strong> ${escapeHtml(x.clientAgency)}` : `${escapeHtml(x.clientAddress)}<br/><span style="color:#666">${escapeHtml(x.clientDistrict)}</span>`}</p>
                                </div>
                                <div style="border-top: 1px solid #eee; padding-top: 12px; display: flex; align-items: center; gap: 8px; color: #555;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                                    <span style="font-size: 12px; font-weight: bold; text-transform: uppercase;">${escapeHtml(x.courier)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                window.print();
                setTimeout(() => { area.innerHTML = ''; }, 1000);
            },

            toggleConfigItem: (k, v) => { if (state.config[k].includes(v)) state.config[k] = state.config[k].filter(i => i !== v); else state.config[k].push(v); app.renderDashboard(); },
            renderDashboard: () => { document.getElementById('inp-store-name').value = state.config.merchantName || ''; document.getElementById('inp-whatsapp').value = state.config.whatsapp || ''; document.getElementById('inp-time').value = state.config.updateTime || ''; document.getElementById('container-couriers').innerHTML = ALL_COURIERS.map(c => `<div onclick="app.toggleConfigItem('couriers','${c}')" class="cursor-pointer border rounded p-2 text-xs font-bold flex items-center gap-2 select-none ${state.config.couriers.includes(c)?'bg-blue-50 border-blue-500 text-blue-700':'bg-white hover:bg-slate-50 text-slate-600'}"><div class="w-3 h-3 border rounded flex items-center justify-center ${state.config.couriers.includes(c)?'bg-blue-600 border-blue-600':''}">${state.config.couriers.includes(c)?'<i data-lucide="check" class="w-2 h-2 text-white"></i>':''}</div>${c}</div>`).join(''); document.getElementById('container-days').innerHTML = ALL_DAYS.map(d => `<button onclick="app.toggleConfigItem('shippingDays','${d}')" class="px-3 py-1 rounded text-xs font-bold border ${state.config.shippingDays.includes(d)?'bg-emerald-500 text-white border-emerald-500':'bg-white text-slate-500 hover:bg-slate-50'}">${d}</button>`).join(''); lucide.createIcons(); },
            renderClient: () => { document.getElementById('client-title').innerText = state.config.merchantName || "Tienda"; document.getElementById('client-time').innerText = state.config.updateTime || "--:--"; const cl = state.config.couriers || []; const cs = document.getElementById('c-courier-select'); if (cl.length) cs.innerHTML = '<option value="" disabled selected>Elige una opci√≥n...</option>' + cl.map(c => `<option value="${c}">${c}</option>`).join(''); else cs.innerHTML = '<option value="" disabled selected>Sin couriers</option>'; app.generateDateOptions(); app.loadExternalLists(); lucide.createIcons(); },
            setTab: (t) => { ['config','share','orders'].forEach(x => { document.getElementById(`tab-${x}`).classList.add('hidden'); document.getElementById(`nav-${x}`).className = "nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-500 hover:bg-slate-50 transition"; }); document.getElementById(`tab-${t}`).classList.remove('hidden'); document.getElementById(`nav-${t}`).className = "nav-item p-3 rounded-lg text-sm font-bold bg-emerald-50 text-emerald-700 text-left flex gap-3 items-center transition ring-1 ring-emerald-100"; if(t==='share') document.getElementById('share-link').innerText=`${window.location.origin}${window.location.pathname}?merchant=${state.user.uid}`; },
            init: () => {
                const p = new URLSearchParams(window.location.search); const mid = p.get('merchant');
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                if (mid) { state.isClientView=true; state.merchantId=mid; document.getElementById('view-client').classList.remove('hidden'); app.loadData(); }
                else { const u = JSON.parse(SafeStorage.getItem('app_current_user')); if(u) { state.user=u; if(u.isAdmin) { document.getElementById('view-admin').classList.remove('hidden'); app.adminLoadUsers(); } else { state.merchantId=u.uid; document.getElementById('view-dashboard').classList.remove('hidden'); app.setTab('config'); app.loadData(); } } else { document.getElementById('view-auth').classList.remove('hidden'); } }
                lucide.createIcons();
            }
        };
        app.init();
    </script>
</body>
</html>
