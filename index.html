<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Tiendas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fuse.js (buscador) -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body class="bg-gray-100">
  <h1 class="text-3xl font-bold text-center mt-5">Mapa de Tiendas</h1>
  <p class="text-center text-gray-600 mb-4">Ubica las tiendas en el mapa ğŸ“</p>

  <!-- Buscador -->
  <div class="w-11/12 mx-auto mb-3">
    <input id="search" type="text" placeholder="Buscar tienda..." 
      class="w-full p-3 border rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400" />
    <ul id="results" class="bg-white mt-2 rounded-lg shadow-md"></ul>
  </div>

  <!-- Mapa -->
  <div id="map" class="w-11/12 h-[500px] mx-auto rounded-xl shadow-lg"></div>

  <script>
    let map = L.map('map').setView([-12.0464, -77.0428], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let markers = [];
    let tiendas = [];

    // Cargar JSON
    fetch('tiendas.json')
      .then(res => res.json())
      .then(data => {
        tiendas = data;

        // Agregar marcadores
        data.forEach(tienda => {
          let marker = L.marker(tienda.coords).addTo(map)
            .bindPopup(`<b>${tienda.nombre}</b><br>${tienda.descripcion}`);
          markers.push({ marker, ...tienda });
        });

        // Configurar buscador
        const fuse = new Fuse(tiendas, {
          keys: ['nombre', 'descripcion'],
          threshold: 0.3
        });

        const searchInput = document.getElementById('search');
        const resultsList = document.getElementById('results');

        searchInput.addEventListener('input', () => {
          const query = searchInput.value.trim();
          resultsList.innerHTML = "";

          if (!query) return;

          const results = fuse.search(query);
          results.forEach(r => {
            const li = document.createElement('li');
            li.textContent = r.item.nombre;
            li.className = "p-2 cursor-pointer hover:bg-gray-100";
            li.onclick = () => {
              map.setView(r.item.coords, 16);
              const found = markers.find(m => m.nombre === r.item.nombre);
              if (found) found.marker.openPopup();
              resultsList.innerHTML = "";
              searchInput.value = r.item.nombre;
            };
            resultsList.appendChild(li);
          });
        });
      })
      .catch(err => console.error("Error cargando tiendas.json:", err));
  </script>
</body>
</html>
