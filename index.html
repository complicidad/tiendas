<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Tiendas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fuse.js (buscador) -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body class="bg-gray-100">
  <h1 class="text-3xl font-bold text-center mt-5">Mapa de Tiendas</h1>
  <p class="text-center text-gray-600 mb-4">Ubica las tiendas en el mapa 📍</p>

  <!-- Buscador -->
  <div class="w-11/12 mx-auto mb-3">
    <input id="search" type="text" placeholder="Buscar tienda..." 
      class="w-full p-3 border rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400" />
    <ul id="results" class="bg-white mt-2 rounded-lg shadow-md"></ul>
  </div>

  <!-- Mapa -->
  <div id="map" class="w-11/12 h-[500px] mx-auto rounded-xl shadow-lg"></div>

  <script>
    // Coordenadas por galería
    const galerias = {
      "Gamarra": [-12.06314, -77.01457],
      "Polvos Azules": [-12.05978, -77.02968],
      "Polvos Rosados": [-12.06865, -77.03301],
      "Centro de Lima": [-12.0464, -77.0428],
      "Arenales": [-12.08968, -77.03317],
      "Mesa Redonda": [-12.0512, -77.0277]
    };

    let map = L.map('map').setView([-12.0464, -77.0428], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let markers = [];
    let tiendas = [];

    // URL de Google Sheet publicada en CSV
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-8h9aepNqoixNWhC_zdj2fV-8u5JkL1TxdYhvb1Nwdw09aDLLrJpTu2AXdlpPGAhXYXZ9sMlucKwG/pub?gid=1928937044&single=true&output=csv";

    fetch(sheetUrl)
      .then(res => res.text())
      .then(csv => {
        // Convertir CSV a JSON
        let rows = csv.split("\n").map(r => r.split(","));
        let headers = rows[0].map(h => h.trim().toLowerCase());
        let data = rows.slice(1).map(r => {
          let obj = {};
          headers.forEach((h, i) => obj[h] = r[i]?.trim());
          return obj;
        }).filter(r => r["nombre de la tienda"]); // descartar filas vacías

        tiendas = data;

        // Agregar marcadores
        tiendas.forEach(tienda => {
          let coords = galerias[tienda["galería"]];
          if (!coords) return;

          let marker = L.marker(coords).addTo(map)
            .bindPopup(`
              <b>${tienda["nombre de la tienda"]}</b><br>
              <i>${tienda["galería"]} - Piso: ${tienda["piso"] || "N/A"} - Stand: ${tienda["stand"] || "N/A"}</i><br>
              ${tienda["tiktok"] ? "🎵 TikTok: " + tienda["tiktok"] : ""}
            `);

          markers.push({ marker, ...tienda });
        });

        // Configurar buscador
        const fuse = new Fuse(tiendas, {
          keys: ['nombre de la tienda', 'galería', 'stand', 'piso'],
          threshold: 0.3
        });

        const searchInput = document.getElementById('search');
        const resultsList = document.getElementById('results');

        searchInput.addEventListener('input', () => {
          const query = searchInput.value.trim();
          resultsList.innerHTML = "";

          if (!query) return;

          const results = fuse.search(query);
          results.forEach(r => {
            const li = document.createElement('li');
            li.textContent = `${r.item["nombre de la tienda"]} (${r.item["galería"]})`;
            li.className = "p-2 cursor-pointer hover:bg-gray-100";
            li.onclick = () => {
              let coords = galerias[r.item["galería"]];
              if (!coords) return;
              map.setView(coords, 16);
              const found = markers.find(m => m["nombre de la tienda"] === r.item["nombre de la tienda"]);
              if (found) found.marker.openPopup();
              resultsList.innerHTML = "";
              searchInput.value = r.item["nombre de la tienda"];
            };
            resultsList.appendChild(li);
          });
        });
      })
      .catch(err => console.error("Error cargando Google Sheet:", err));
  </script>
</body>
</html>
