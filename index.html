<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo App Completa (LocalStorage)</title>

    <!-- Meta Tags OGP (del form.html) -->
    <meta property="og:title" content="Agenda tu env√≠o" />
    <meta property="og:description" content="Agenda tu env√≠o de manera simple, r√°pida y segura." />
    <meta property="og:image" content="https://complicidad.github.io/form/Spin.png" />
    <meta property="og:url" content="https://complicidad.github.io/form" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary" />
    
    <!-- CDNs (Consolidados) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- ======================= SDK de Firebase ELIMINADO ======================= -->
    <!-- (El script de importaci√≥n de Firebase v11 ha sido removido) -->
    <!-- ======================= FIN: SDK de Firebase ======================= -->

    <!-- Estilos (Consolidados - Sin cambios) -->
    <style>
        /* Estilos del Dashboard (base) */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        @media (min-width: 768px) {
            /* html, body, #root-container { height: 100%; } */ /* Desactivado */
        }
        #sidebar { z-index: 60; }
        #sidebarOverlay { z-index: 50; }
        header { position: sticky; top: 0; z-index: 40; }      
        body { 
            background-color: #fffaf6; 
            color: #2b2b2b; 
            line-height: 1.6;
            font-family: 'Quicksand', sans-serif;
        }
        .oculto { display: none !important; }

        /* --- L√≥gica de Navegaci√≥n de P√°gina --- */
        .page-section { display: none; }
        .page-section.active { display: block; }
        .page-section#page-dashboard.active {
            display: flex; /* Es un flex container */
            flex-direction: column;
            min-height: 100vh;
        }
        /* --- Fin L√≥gica de Navegaci√≥n --- */


        main > section { display: none; }
        main > section.active { 
            display: flex;
            flex-direction: column;
        }

        .nowrap { white-space: nowrap; }
        #editPanel { transition: transform 0.3s ease-in-out; }
        #tablaEnvios > thead > tr > th {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 5;
            background-color: #fef3c7;
        }
        
        .print-container { display: none; }
        @media print {
            /* ... (Estilos de impresi√≥n sin cambios) ... */
            #page-portal, #page-form, #root-container, .toast, #deleteModal, #editPanelOverlay, #editPanel {
                display: none !important;
            }
            .print-container { /* ... (estilos de impresi√≥n sin cambios) ... */ }
            .label-card { /* ... */ }
        }
        @media (min-width: 768px) {
            body:not(.scroll-enabled) #root-container { overflow: hidden; }
            body.scroll-enabled #mainContent { overflow-y: auto; }
        }
        .col-hidden { display: none; }
        .inline-edit-container { display: flex; align-items: center; gap: 4px; }
        .inline-edit-estado { min-width: 120px; flex-shrink: 0; padding: 0.3rem 0.5rem !important; font-size: 0.75rem !important; border-radius: 0.5rem !important; }
        .inline-edit-fecha { max-width: 150px; flex-shrink: 0; padding: 0.3rem 0.5rem !important; font-size: 0.75rem !important; border-radius: 0.5rem !important; }
        .inline-save-btn { padding: 4px 8px !important; flex-shrink: 0; font-size: 0.75rem !important; border-radius: 0.5rem !important; }
        .inline-save-btn svg { width: 14px !important; height: 14px !important; }
        #mobileCardContainer .inline-edit-container { flex-direction: column; align-items: flex-start; margin-top: 8px; gap: 8px; padding-top: 8px; border-top: 1px solid #eee; }
        #mobileCardContainer .inline-edit-fecha { max-width: none; width: 100%; padding: 0.5rem !important; font-size: 0.875rem !important; }
        #mobileCardContainer .inline-edit-estado { width: 100%; padding: 0.5rem !important; font-size: 0.875rem !important; }
        #mobileCardContainer .inline-save-btn { width: 100%; justify-content: center; padding: 0.5rem 1rem !important; font-size: 0.875rem !important; }
        #root-container { display: none; } /* Oculto por defecto */
        #page-dashboard.active #root-container { display: flex; } /* Visible cuando la p√°gina est√° activa */
        #loginScreen { display: flex; }
        
        /* Estilos del Formulario (form.html) */
        :root {
            --brand-accent: #D96B4F;
            --brand-accent-alt: #FF8B6A;
            --danger-color: #d93025; 
        }
        .is-invalid {
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 0 3px rgba(217, 48, 37, 0.15) !important;
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
          animation: spin 1s linear infinite;
        }

    </style>
    
    <!-- Tailwind Config (Consolidada - Sin cambios) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent': '#D96B4F',
                        'accent-alt': '#FF8B6A',
                        'bg-soft': '#fffaf6',
                        'badge-pending': '#9a6200',
                        'badge-sent': '#D96B4F',
                        'badge-notificado': '#1b7f3a',
                        'badge-rescheduled': '#8e44ad',
                        'brand-accent': '#D96B4F', 
                        'sidebar-bg': '#1f2937',
                        'sidebar-hover': '#374151',
                        'sidebar-active-bg': '#D96B4F',
                        'brand-bg': '#fffaf6',
                        'brand-card': '#ffffff',
                        'brand-text': '#2b2b2b',
                        'brand-muted': '#6b6b6b',
                        'brand-accent-alt': '#FF8B6A', 
                        'danger': '#d93025',
                    },
                    borderRadius: {
                        'xl': '14px', 
                    },
                    fontFamily: {
                        'sans': ['Quicksand', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
                        'quicksand': ['Quicksand', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans bg-bg-soft text-gray-900 antialiased">

    <!-- =================================================================== -->
    <!-- ===================== P√ÅGINA 1: PORTAL (index.html) =============== -->
    <!-- =================================================================== -->
    <div id="page-portal" class="page-section active">
        <!-- ... (HTML del portal sin cambios) ... -->
        <div class="container mx-auto px-4 py-16 sm:py-24">
            <header class="text-center mb-12 sm:mb-16">
                <h1 class="text-4xl sm:text-5xl font-bold text-accent mb-3">Demo de Aplicaci√≥n</h1>
                <p class="text-lg sm:text-xl text-gray-600 max-w-2xl mx-auto">
                    Prueba la herramienta. Los datos se guardar√°n en el almacenamiento local de tu navegador.
                </p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12 max-w-4xl mx-auto">
                
                <a href="#" data-page="page-form" class="nav-link card-link group block">
                    <div class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl shadow-accent/10 hover:shadow-accent/20 transition-all duration-300 transform hover:-translate-y-1 h-full flex flex-col">
                        <div class="mb-4">
                            <i data-feather="file-text" class="w-12 h-12 text-accent-alt"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">1. Agendar Env√≠o</h2>
                        <p class="text-gray-600 mb-6 flex-grow">
                            Abre el formulario de cliente. Los datos que env√≠es se guardar√°n localmente en tu navegador.
                        </p>
                        <span class="font-bold text-accent group-hover:underline flex items-center">
                            Abrir el formulario
                            <i data-feather="arrow-right" class="w-5 h-5 ml-2 transition-transform group-hover:translate-x-1"></i>
                        </span>
                    </div>
                </a>

                <a href="#" data-page="page-dashboard" class="nav-link card-link group block">
                    <div class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl shadow-accent/10 hover:shadow-accent/20 transition-all duration-300 transform hover:-translate-y-1 h-full flex flex-col">
                        <div class="mb-4">
                            <i data-feather="bar-chart-2" class="w-12 h-12 text-accent-alt"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">2. Ver el Panel</h2>
                        <p class="text-gray-600 mb-6 flex-grow">
                            Accede al panel de admin. Ver√°s los datos guardados localmente y podr√°s exportarlos a Excel.
                        </p>
                        <span class="font-bold text-accent group-hover:underline flex items-center">
                            Ir al panel
                            <i data-feather="arrow-right" class="w-5 h-5 ml-2 transition-transform group-hover:translate-x-1"></i>
                        </span>
                    </div>
                </a>
            </div>
            
            <div class="text-center mt-16">
                <button id="clearData" class="bg-gray-200 text-gray-700 py-2 px-5 rounded-xl font-semibold hover:bg-gray-300 transition-all duration-200 flex items-center mx-auto">
                    <i data-feather="trash-2" class="w-4 h-4 mr-2"></i>
                    Limpiar Datos de la Demo
                </button>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- ===================== P√ÅGINA 2: FORMULARIO (form.html) ============ -->
    <!-- =================================================================== -->
    <div id="page-form" class="page-section">
        <!-- ... (HTML del formulario sin cambios) ... -->
        <main class="flex-grow p-5 max-w-xl mx-auto font-quicksand w-full">
            
            <button type="button" class="nav-back text-accent font-semibold text-sm flex items-center mb-4 hover:underline" data-page="page-portal">
                <i data-feather="arrow-left" class="w-4 h-4 mr-1"></i>
                Volver al Portal
            </button>

            <div class="bg-brand-card p-6 md:p-8 rounded-xl shadow-2xl">

            <div class="text-center p-4">
                <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Logo Complicidad" class="max-w-[200px] h-auto inline-block">
            </div>      
                
                
                <form id="formulario" novalidate>

                    <h2 class="mt-[0px] mb-2 text-center text-2xl font-bold text-brand-text">Agenda tu env√≠o</h2>

                    <label for="telefonoUsado" class="block mt-4 font-semibold text-sm text-brand-text">WhatsApp con el que compraste <span class="text-danger">*</span></label>
                    <input
                        type="tel"
                        id="telefonoUsado"
                        name="telefonoUsado"
                        required
                        placeholder="Ej. 9XXXXXXXX"
                        pattern="^9\d{8}$"
                        title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos (debe empezar con 9)"
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text"
                    />

                    <label for="tipoAccion" class="block mt-4 font-semibold text-sm text-brand-text">Selecciona el tipo de servicio <span class="text-danger">*</span></label>
                    <select id="tipoAccion" name="tipoAccion" required
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text">
                        <option value="" disabled selected>Elige una opci√≥n</option>
                        <option value="delivery">Env√≠o a domicilio/trabajo (Delivery)</option>
                        <option value="shalom">Retiro en agencia Shalom</option>
                        <option value="usado">Usar mi direcci√≥n registrada</option>
                    </select>

                    <fieldset id="camposDelivery" class="mt-8 border-none p-0" hidden>
                        <legend class="text-xl font-bold mb-1 text-brand-text">üì¶ Delivery</legend>
                        <p class="text-sm text-brand-muted mb-3">Datos de la persona que recibir√° el pedido.</p>

                        <label for="nombreDelivery" class="block mt-4 font-semibold text-sm text-brand-text">Nombre: <span class="text-danger">*</span></label>
                        <input type="text" id="nombreDelivery" name="nombre" required
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />

                        <label for="telefonoDelivery" class="block mt-4 font-semibold text-sm text-brand-text">Tel√©fono: <span class="text-danger">*</span></label>
                        <input
                            type="tel"
                            id="telefonoDelivery"
                            name="telefono"
                            required
                            pattern="^9\d{8}$"
                            title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text"
                        />
                        
                        <div class="mt-1 flex items-center">
                            <input type="checkbox" id="usarMismoTelefonoDelivery" class="h-4 w-4 text-brand-accent rounded border-gray-300 focus:ring-brand-accent-alt" />
                            <label for="usarMismoTelefonoDelivery" class="ml-2 block text-sm text-brand-muted cursor-pointer">Usar mi n√∫mero de WhatsApp (<span id="telefonoDisplayDelivery" class="font-semibold"></span>)</label>
                        </div>

                        <label for="distrito" class="block mt-4 font-semibold text-sm text-brand-text">Distrito: <span class="text-danger">*</span></label>
                        <input type="text" id="distrito" name="distrito" required readonly
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 cursor-pointer text-brand-text" />

                        <label for="direccion" class="block mt-4 font-semibold text-sm text-brand-text">Direcci√≥n: <span class="text-danger">*</span></label>
                        <input type="text" id="direccion" name="direccion" required
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />

                        <label for="referencia" class="block mt-4 font-semibold text-sm text-brand-text">Referencia: <span class="text-danger">*</span></label>
                        <input type="text" id="referencia" name="referencia" required
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />
                        
                        <div class="modal hidden fixed inset-0 bg-brand-text bg-opacity-50 z-50 flex justify-center items-start pt-5 pb-5" id="modalDistrito">
                            <div class="modal-content bg-brand-card p-5 rounded-xl w-[350px] max-h-[95vh] shadow-2xl flex flex-col overflow-hidden">
                                <input type="text" id="buscadorDistrito" placeholder="Buscar distrito..."
                                    class="w-full p-2 mb-3 rounded-lg border border-gray-300 focus:border-brand-accent focus:ring-2 focus:ring-brand-accent-alt/40 text-brand-text" />
                                <div id="listaDistritos" class="list list-none p-0 m-0 text-brand-text overflow-y-auto"></div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset id="camposShalom" class="mt-8 border-none p-0" hidden>
                        <legend class="text-xl font-bold mb-1 text-brand-text">üì¶ Shalom</legend>
                        <p class="text-sm text-brand-muted mb-3">Datos para retiro en agencia Shalom.</p>

                        <label for="nombreShalom" class="block mt-4 font-semibold text-sm text-brand-text">Nombre completo: <span class="text-danger">*</span></label>
                        <input type="text" id="nombreShalom" name="nombre" required
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />

                        <label for="telefonoShalom" class="block mt-4 font-semibold text-sm text-brand-text">Tel√©fono: <span class="text-danger">*</span></label>
                        <input
                            type="tel"
                            id="telefonoShalom"
                            name="telefono"
                            required
                            pattern="^9\d{8}$"
                            title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text"
                        />
                        
                        <div class="mt-1 flex items-center">
                            <input type="checkbox" id="usarMismoTelefonoShalom" class="h-4 w-4 text-brand-accent rounded border-gray-300 focus:ring-brand-accent-alt" />
                            <label for="usarMismoTelefonoShalom" class="ml-2 block text-sm text-brand-muted cursor-pointer">Usar mi n√∫mero de WhatsApp (<span id="telefonoDisplayShalom" class="font-semibold"></span>)</label>
                        </div>

                        <label for="DNI" class="block mt-4 font-semibold text-sm text-brand-text">DNI/CE: <span class="text-danger">*</span></label>
                        <input type="text" id="DNI" name="DNI" required pattern="[A-Za-z0-9]{5,15}" title="Ingresa un DNI (8 d√≠gitos) o CE v√°lido (5-15 caracteres)"
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />

                        <label for="agencia" class="block mt-4 font-semibold text-sm text-brand-text">Agencia: <span class="text-danger">*</span></label>
                        <input type="text" id="agencia" name="agencia" required readonly
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 cursor-pointer text-brand-text" />
                        
                        <div class="modal hidden fixed inset-0 bg-brand-text bg-opacity-50 z-50 flex justify-center items-start pt-5 pb-5" id="modalAgencia">
                            <div class="modal-content bg-brand-card p-5 rounded-xl w-[350px] max-h-[95vh] shadow-2xl flex flex-col overflow-hidden">
                                <input type="text" id="buscadorAgencia" placeholder="Buscar agencia..."
                                    class="w-full p-2 mb-3 rounded-lg border border-gray-300 focus:border-brand-accent focus:ring-2 focus:ring-brand-accent-alt/40 text-brand-text" />
                                <div id="listaAgencias" class="list list-none p-0 m-0 text-brand-text overflow-y-auto"></div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset id="camposUsados" class="mt-8 border-none p-0" hidden>
                        <legend class="text-xl font-bold mb-1 text-brand-text">üì¶ Direcci√≥n registrada</legend>
                        <p class="text-sm text-brand-muted mb-3">Usaremos tu direcci√≥n guardada.</p>
                    </fieldset>

                    <div id="contenedorFecha" class="mt-4" style="display: none;">
                        <label for="fecha" class="block font-semibold text-sm text-brand-text">Fecha de env√≠o: <span class="text-danger">*</span></label>
                        <select id="fecha" name="fecha" required
                            class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text"></select>
                    </div>

                    <div class="flex justify-center w-full mt-6">
                        <button type="submit"
                            class="p-3 text-lg cursor-pointer bg-brand-accent text-white font-semibold border-none rounded-xl w-full transition duration-150 ease-in-out hover:bg-brand-accent-alt shadow-lg">
                            Confirmar y agendar env√≠o
                        </button>
                    </div>

                    <div class="mt-4 text-sm text-brand-muted text-center">
                        Usaremos tus datos solo para procesar y entregar tu pedido.
                        <a href="https://complicidad.github.io/privacy/" target="_blank" class="text-brand-accent hover:text-brand-accent-alt underline">Ver pol√≠tica de privacidad</a>
                    </div>
                </form>

                <div id="successMessage" class="hidden flex-col items-center justify-center p-4 text-center">
                    <svg class="w-16 h-16 text-brand-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <h2 class="mt-4 text-2xl font-bold text-brand-text">¬°Env√≠o agendado con √©xito!</h2>
                    <p class="mt-2 text-brand-muted">Tu pedido ha sido registrado. Gracias por tu confianza.</p>
                    <p class="mt-6 font-semibold text-brand-text">Mientras esperas, ¬°s√≠guenos!</p>
                    <div class="mt-4 flex justify-center gap-4">
                        <a href="https://wa.me/51981391159" target="_blank" rel="noopener noreferrer" class="inline-flex items-center hover:opacity-80 transition">
                            <img src="https://raw.githubusercontent.com/complicidad/form/main/whatsapp.png" alt="WhatsApp" width="28" height="28">
                        </a>
                        <a href="https://www.tiktok.com/@complicidadboutique" target="_blank" rel="noopener noreferrer" class="inline-flex items-center hover:opacity-80 transition">
                            <img src="https://raw.githubusercontent.com/complicidad/form/main/tik-tok.png" alt="TikTok" width="28" height="28">
                        </a>
                        <a href="https://www.instagram.com/@complicidadboutique" target="_blank" rel="noopener noreferrer" class="inline-flex items-center hover:opacity-80 transition">
                            <img src="https://raw.githubusercontent.com/complicidad/form/main/instagram.png" alt="Instagram" width="28" height="28">
                        </a>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-0 mb-5 text-center text-gray-500 text-xs">
            <p>Hecho con ‚ù§Ô∏è para tu emprendimiento.</p>
        </footer>

        <div id="spinner" class="fixed inset-0 bg-brand-bg bg-opacity-85 z-50 flex justify-center items-center flex-col hidden">
            <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Cargando..." class="w-[150px] h-auto animate-spin-custom">
            <p class="mt-4 text-lg text-brand-text">Cargando...</p>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- ================== P√ÅGINA 3: DASHBOARD (dashboard.html) =========== -->
    <!-- =================================================================== -->
    <div id="page-dashboard" class="page-section">
        
        <!-- ... (HTML del dashboard sin cambios) ... -->
        <div id="root-container" class="flex bg-bg-soft min-h-screen">
            <aside id="sidebar" class="w-64 bg-sidebar-bg text-white flex flex-col fixed h-full shadow-lg z-40 transform -translate-x-full transition-transform duration-300 ease-in-out">
                <div class="p-6 border-b border-gray-700 flex items-center gap-3">
                    <img id="sidebarLogo" src="" alt="Logo" class="h-10 w-10 rounded-md object-cover bg-white p-1 hidden">
                    <h1 id="sidebarTitle" class="text-2xl font-bold text-white">Panel</h1>
                </div>

                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" data-page="page-portal" class="nav-back text-gray-300 hover:bg-sidebar-hover hover:text-white flex items-center gap-3 p-3 rounded-lg font-semibold transition-colors duration-200">
                        <i data-feather="home" class="w-5 h-5"></i><span>Volver al Portal</span>
                    </a>
                    
                    <a href="#envios" class="nav-link active flex items-center gap-3 p-3 rounded-lg font-semibold transition-colors duration-200">
                        <i data-feather="truck" class="w-5 h-5"></i><span>Env√≠os</span>
                    </a>
                    <a href="#link" class="nav-link flex items-center gap-3 p-3 rounded-lg font-semibold transition-colors duration-200">
                        <i data-feather="link" class="w-5 h-5"></i><span>Link M√°gico</span>
                    </a>
                    <a href="#cuenta" class="nav-link flex items-center gap-3 p-3 rounded-lg font-semibold transition-colors duration-200">
                        <i data-feather="settings" class="w-5 h-5"></i><span>Mi Cuenta</span>
                    </a>
                </nav>

                <div class="p-4 border-t border-gray-700 text-sm">
                    <a href="#" id="logoutButton-sidebar" class="text-accent-alt hover:underline">Cerrar Sesi√≥n</a>
                </div>
            </aside>
            <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden transition-opacity duration-300 ease-in-out"></div>

            <div id="mainContent" class="flex-1 flex flex-col transition-all duration-300 ease-in-out">
                 <header class="bg-gradient-to-br from-brand-accent to-orange-400 text-white p-6 shadow-xl shadow-accent/25 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <button id="sidebarToggle" class="text-white p-2 rounded-md hover:bg-black/20 focus:outline-none focus:ring-2 focus:ring-white">
                            <i data-feather="menu" class="w-6 h-6"></i>
                        </button>
                        <div>
                            <h1 id="headerTitle" class="text-2xl font-bold">Env√≠os</h1>
                        </div>
                    </div>
                    <div class="hidden md:flex items-center gap-3">
                        <div class="text-right">
                             <p class="text-sm opacity-90">Bienvenido,</p>
                             <strong id="headerBusinessName" class="font-bold">[Nombre del emprendimiento]</strong>
                        </div>
                        <img id="headerLogo" src="" alt="Logo" class="h-12 w-12 rounded-md object-cover bg-white p-1 hidden">
                    </div>
                </header>

                <main class="flex-grow p-4 md:p-6">
                    
                    <section class="active md:h-full" id="envios">
                        <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-4 md:p-6 border border-gray-200 flex flex-col md:h-full">
                            <div class="flex-shrink-0">
                                    <div class="flex flex-col md:flex-row justify-between md:items-end gap-4 border-b border-gray-200 pb-4 mb-4 flex-wrap">
                                        <div class="flex flex-col md:flex-row md:items-end gap-2 flex-wrap">
                                            <label class="text-xs text-gray-500 font-semibold md:w-36">Cliente (N¬∞ Exacto)<input type="text" id="filtroCliente" placeholder="N¬∞ exacto (987654321)" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 mt-1" /></label>
                                            <label class="text-xs text-gray-500 font-semibold md:w-36">Fecha de Env√≠o<input type="date" id="filtroFecha" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 mt-1" /></label>
                                            <label class="text-xs text-gray-500 font-semibold md:w-36"">Courier
                                                <select id="filtroTipo" class="select p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 mt-1">
                                                    <option value="">Todos</option>
                                                    <option value="SHALOM">Shalom</option>
                                                    <option value="OLVA">Olva</option>
                                                    <option value="DELIVERY">Delivery Propio</option>
                                                </select>
                                            </label>
                                            <button class="btn primary bg-gradient-to-r from-accent to-accent-alt text-white py-2.5 px-4 rounded-xl font-bold text-sm shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200" id="btnAplicarFiltros">Filtrar</button>
                                            <button id="btnLimpiarFiltros" class="btn ghost bg-transparent border border-gray-300 text-gray-700 hover:bg-gray-50 py-2.5 px-4 rounded-xl font-bold text-sm transition-all duration-200">Limpiar</button>
                                            <label class="flex items-center text-sm text-gray-700 ml-4 cursor-pointer">
                                                <input type="checkbox" id="filtroDuplicados" class="rounded border-gray-300 text-accent focus:ring-accent mr-2">
                                                <span>Mostrar solo duplicados</span>
                                            </label>
                                        </div>
                                        <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                            <div class="relative inline-block text-left">
                                                <button type="button" class="btn ghost bg-transparent border border-gray-200 text-gray-900 hover:bg-gray-50 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center justify-center gap-2 w-full" id="plantillasDropdownBtn">
                                                    <i data-feather="download" class="w-4 h-4"></i>
                                                    <span>Descargar Plantilla</span>
                                                    <i data-feather="chevron-down" class="w-4 h-4 -mr-1 ml-2"></i>
                                                </button>
                                                <div id="plantillasDropdownMenu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-xl shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                                                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="plantillasDropdownBtn">
                                                        <a href="#" id="btnTplDelivery" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Plantilla DELIVERY (.xlsx)</a>
                                                        <a href="#" id="btnTplShalom" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Plantilla SHALOM (.xlsx)</a>
                                                        <a href="#" id="btnTplOlva" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Plantilla OLVA (.xlsx)</a>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="btn primary bg-gradient-to-r from-accent to-accent-alt text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center justify-center gap-2" id="btnEtiquetas"><i data-feather="tag" class="w-4 h-4"></i>Imprimir Etiquetas</button>
                                        </div>
                                    </div>

                                <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 my-3 hidden" id="batchActionsContainer">
                                    <div class="lote-left flex gap-3 items-center flex-wrap">
                                        <label class="nowrap text-sm text-gray-900"><input type="checkbox" id="checkTodos" class="rounded border-gray-300 text-accent focus:ring-accent" /> Seleccionar todo</label>
                                        <span class="text-gray-500 text-sm hidden" id="selCount">0 seleccionados</span>
                                        <span id="visibleCount" class="text-gray-500 text-sm border-l border-gray-300 pl-3 ml-3"></span>
                                    </div>
                                    <div class="lote-right flex flex-col sm:flex-row gap-2 items-center w-full md:w-auto hidden">
                                        <select id="accionLote" class="select p-2.5 border border-gray-200 rounded-xl bg-white w-full sm:w-auto text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                                            <option value="" selected>Acci√≥n en lote‚Ä¶</option>
                                            <option value="PENDIENTE">Marcar como Pendiente</option>                                       
                                            <option value="NOTIFICADO">Marcar como Notificado</option>
                                            <option value="ENVIADO">Marcar como Enviado</option>
                                            <option value="REPROGRAMADO">Reprogramar</option>
                                            <option value="ELIMINAR" class="text-red-600 font-semibold">Eliminar Seleccionados</option>
                                        </select>
                                        <input type="date" id="fechaReprog" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full sm:w-auto text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 oculto" />
                                        <button class="btn primary bg-accent text-white py-2.5 px-4 rounded-xl font-bold text-sm shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 w-full sm:w-auto" id="btnAplicarLote">Aplicar</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tableContainer" class="md:flex-grow md:relative md:min-h-0">
                                <div class="overflow-auto absolute inset-0 hidden md:block shadow-lg shadow-gray-100 rounded-xl border border-gray-200">
                                    <table id="tablaEnvios" class="w-full border-collapse bg-white">
                                        <thead>
                                            <tr>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider rounded-tl-xl w-12"><input type="checkbox" id="thCheckTodos" class="rounded border-gray-300 text-accent focus:ring-accent" /></th>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider">Fecha Reg.</th>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider">Cliente</th>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider">Courier</th>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider">Destinatario</th>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider">Destino</th>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider">Fecha Env√≠o</th>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider">Estado</th>
                                                <th class="p-3 text-left text-xs font-bold text-accent uppercase tracking-wider rounded-tr-xl">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyEnvios"></tbody>
                                    </table>
                                </div>
                                 <div id="mobileCardContainer" class="md:hidden space-y-4 md:overflow-y-auto md:absolute md:inset-0">
                                </div>
                            </div>

                            <div id="emptyStateContainer" class="hidden text-center p-10 border-2 border-dashed rounded-xl mt-4 flex-grow items-center justify-center flex-col">
                                <i data-feather="gift" class="w-16 h-16 mx-auto text-gray-300"></i>
                                <h3 class="mt-4 text-xl font-bold text-gray-800">¬°Bienvenido a tu panel de control!</h3>
                                <p class="mt-2 text-sm text-gray-500 max-w-sm mx-auto">A√∫n no tienes env√≠os registrados. El primer paso es configurar tu 'Link M√°gico' y compartirlo con tus clientes.</p>
                                <button id="goToAccountBtn" class="mt-6 btn primary bg-gradient-to-r from-accent to-accent-alt text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2">
                                    <i data-feather="settings" class="w-4 h-4"></i> Ir a Configuraci√≥n
                                </button>
                            </div>
                        </div>
                    </section>

                    <section id="link" class="h-full">
                        <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                            <p class="text-gray-500 text-sm mb-5">Comparte este link √∫nico con tus clientes. Ellos completar√°n sus datos de env√≠o directamente y la informaci√≥n aparecer√° en tu panel, ¬°sin errores y sin que tengas que transcribir nada!</p>
                            <div class="form-group">
                                <label for="linkUnicoInput" class="block text-sm text-gray-500 font-semibold mb-1.5">Tu enlace personal</label>
                                <div id="linkUnicoContainer" class="flex flex-col sm:flex-row gap-2">
                                    <input type="text" id="linkUnicoInput" class="input p-2.5 border border-gray-200 rounded-xl bg-gray-50 flex-grow text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" value="https://latam5s.com/form/tu-tienda" readonly>
                                    <button class="btn ghost bg-transparent border border-gray-200 text-gray-900 hover:bg-gray-50 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center justify-center gap-2 w-full sm:w-auto" id="btnCopiarLink"><i data-feather="copy" class="w-4 h-4"></i>Copiar</button>
                                    <button class="btn primary bg-gradient-to-r from-accent to-accent-alt text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center justify-center gap-2 w-full sm:w-auto" id="btnCompartirLink"><i data-feather="share-2" class="w-4 h-4"></i>Compartir</button>
                                </div>
                            </div>
                        </div>
                        <footer class="p-4 bg-bg-soft flex-shrink-0 flex justify-center items-center gap-2 text-gray-500 text-sm mt-auto">
                            <span>Powered by</span>
                            <svg height="20" viewBox="0 0 90 22" xmlns="http://www.w3.org/2000/svg">
                                <text x="0" y="18" style="font-family: Quicksand, sans-serif; font-size: 20px; font-weight: 700; fill: #D96B4F;">Latam5S</text>
                            </svg>
                        </footer>
                    </section>

                    <section id="cuenta">
                        <div class="flex-grow p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                                <div class="lg:col-span-3 space-y-6">
                                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="briefcase" class="w-5 h-5 text-accent"></i> Perfil del Negocio</h3>
                                        <div class="space-y-4">
                                            <div class="form-group">
                                                <label for="businessName" class="block text-sm text-gray-500 font-semibold mb-1.5">Nombre del Emprendimiento</label>
                                                <input type="text" id="businessName" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="Ej: La Tiendita de Ana" value="Mi Tienda de Prueba">
                                            </div>
                                            <div class="form-group">
                                                <label for="logoInput" class="block text-sm text-gray-500 font-semibold mb-1.5">Logo del Negocio</label>
                                                <input type="file" id="logoInput" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm file:mr-4 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-accent hover:file:bg-orange-100" accept="image/*">
                                                <img id="logoPreview" src="" alt="Vista previa del logo" class="max-h-20 rounded-lg object-contain border border-dashed border-gray-300 p-1 mt-3 hidden">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="calendar" class="w-5 h-5 text-accent"></i> Opciones de Despacho</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="space-y-3">
                                                <label class="block text-sm text-gray-500 font-semibold">Couriers Habilitados</label>
                                                <div class="space-y-2">
                                                    <label class="block text-sm text-gray-900"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-2"> Delivery</label>
                                                    <label class="block text-sm text-gray-900"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-2"> Shalom</label>
                                                    <label class="block text-sm text-gray-900"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-2"> Olva</label>
                                                    <label class="block text-sm text-gray-900"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-2"> Dinsides</label>
                                                </div>
                                            </div>
                                             <div class="space-y-3">
                                                <label class="block text-sm text-gray-500 font-semibold">D√≠as de Despacho</label>
                                                <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm">
                                                    <label class="inline-flex items-center"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Lun</label>
                                                    <label class="inline-flex items-center"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Mar</label>
                                                    <label class="inline-flex items-center"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Mi√©</label>
                                                    <label class="inline-flex items-center"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Jue</label>
                                                    <label class="inline-flex items-center"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Vie</label>
                                                    <label class="inline-flex items-center"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> S√°b</label>
                                                    <label class="inline-flex items-center"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Dom</label>
                                                </div>
                                            </div>
                                            <div class="form-group md:col-span-2">
                                                <label for="cutoffTime" class="block text-sm text-gray-500 font-semibold mb-1.5">Hora de Cierre de Pedidos</label>
                                                <input type="time" id="cutoffTime" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full md:w-auto text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="share-2" class="w-5 h-5 text-accent"></i> Redes Sociales</h3>
                                        <div class="space-y-4">
                                            <p class="text-sm text-gray-500 -mt-2">Estos enlaces aparecer√°n en tu formulario para que tus clientes puedan contactarte.</p>
                                            <div class="form-group">
                                                <label for="instagramUser" class="block text-sm text-gray-500 font-semibold mb-1.5">Usuario de Instagram</label>
                                                <div class="relative">
                                                    <i data-feather="instagram" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                                    <input type="text" id="instagramUser" class="input p-2.5 pl-9 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="mitiendaonline">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="whatsappNumber" class="block text-sm text-gray-500 font-semibold mb-1.5">N√∫mero de WhatsApp</label>
                                                <div class="relative">
                                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">+51</span>
                                                    <input type="number" id="whatsappNumber" class="input p-2.5 pl-10 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="987654321">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="facebookUser" class="block text-sm text-gray-500 font-semibold mb-1.5">Usuario de Facebook</label>
                                                <div class="relative">
                                                    <i data-feather="facebook" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                                    <input type="text" id="facebookUser" class="input p-2.5 pl-9 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="mitiendaonlinefb">
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="tiktokUser" class="block text-sm text-gray-500 font-semibold mb-1.5">Usuario de TikTok</label>
                                                <div class="relative">
                                                    <i data-feather="music" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                                    <input type="text" id="tiktokUser" class="input p-2.5 pl-9 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="mitienda.tiktok">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="lg:col-span-2 space-y-6">
                                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="award" class="w-5 h-5 text-accent"></i> Tu Suscripci√≥n</h3>
                                        <!-- ... (Contenido de suscripci√≥n sin cambios) ... -->
                                    </div>
                                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="lock" class="w-5 h-5 text-accent"></i> Seguridad de la Cuenta</h3>
                                        <!-- ... (Contenido de seguridad sin cambios) ... -->
                                    </div>
                                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="users" class="w-5 h-5 text-accent"></i> Gesti√≥n de Equipo</h3>
                                        <!-- ... (Contenido de equipo sin cambios) ... -->
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button class="btn primary bg-gradient-to-r from-accent to-accent-alt text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2" id="btnGuardarConfig"><i data-feather="save" class="w-4 h-4"></i>Guardar Cambios</button>
                            </div>
                        </div>
                        <footer class="p-4 bg-bg-soft flex-shrink-0 flex justify-center items-center gap-2 text-gray-500 text-sm mt-6">
                            <span>Powered by</span>
                            <svg height="20" viewBox="0 0 90 22" xmlns="http://www.w3.org/2000/svg">
                                <text x="0" y="18" style="font-family: Quicksand, sans-serif; font-size: 20px; font-weight: 700; fill: #D96B4F;">Latam5S</text>
                            </svg>
                        </footer>
                    </section>
                    
                </main>
            </div>
        </div>
        
        <div id="loginScreen" class="fixed inset-0 bg-gray-100 z-[100] flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-md">
                <div class="flex flex-col items-center mb-6">
                    <img id="loginLogo" src="" alt="Logo" class="h-16 w-16 rounded-md object-cover bg-white p-1 hidden mb-3">
                    <h2 id="loginTitle" class="text-2xl font-bold text-gray-900 text-center">Iniciar Sesi√≥n</h2>
                    <p id="loginBusinessName" class="text-sm text-gray-500 mt-1">[Nombre del emprendimiento]</p>
                </div>
                
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-semibold text-gray-700 mb-1.5">Correo Electr√≥nico</label>
                        <input type="email" id="loginEmail" required class="input p-3 border border-gray-300 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="tu@correo.com" value="admin@demo.com">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-1.5">Contrase√±a</label>
                        <input type="password" id="loginPassword" required class="input p-3 border border-gray-300 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <p id="loginError" class="text-sm text-red-600 text-center hidden"></p>
                    
                    <button type="submit" id="loginButton" class="btn primary w-full bg-gradient-to-r from-accent to-accent-alt text-white py-3 px-4 rounded-xl font-bold text-base shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 inline-flex items-center justify-center gap-2">
                        Ingresar
                    </button>
                </form>
            </div>
        </div>

    </div> <!-- Fin de #page-dashboard -->


    <!-- =================================================================== -->
    <!-- ===================== ELEMENTOS FLOTANTES GLOBALES ================ -->
    <!-- =================================================================== -->
    
    <div class="toast fixed right-5 bottom-5 text-white p-3 rounded-xl shadow-xl shadow-brand-accent/25 opacity-0 translate-y-2 transition-all duration-300 z-[999]" id="toast">Acci√≥n aplicada</div>
    
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[1000] hidden">
        <!-- ... (Contenido del modal de eliminaci√≥n sin cambios) ... -->
    </div>
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[1000] hidden">
        <!-- ... (Contenido del modal de edici√≥n sin cambios) ... -->
    </div>

    <div id="print-container" class="print-container"></div>


    <!-- =================================================================== -->
    <!-- ===================== SCRIPT PRINCIPAL UNIFICADO ================== -->
    <!-- =================================================================== -->
    <script type="module">
        
        // --- L√ìGICA DE NAVEGACI√ìN DE P√ÅGINA ---
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            window.scrollTo(0, 0);
            
            // --- CAMBIO ---
            // El login S√ìLO debe mostrarse si la p√°gina es "page-dashboard" Y no estamos logueados
            const loginScreen = document.getElementById('loginScreen');
            const rootContainer = document.getElementById('root-container');
            if(pageId === 'page-dashboard') {
                // La l√≥gica de login se encargar√° de mostrar/ocultar
                // `loginScreen` o `rootContainer`
                // (Si ya est√° logueado, root-container se mostrar√°, login no)
                // (Si no est√° logueado, login se mostrar√°, root-container no)
                
                // Si NO estamos logueados, muestra la pantalla de login
                if (!isLoggedIn) {
                    loginScreen.style.display = 'flex';
                    rootContainer.style.display = 'none';
                } else {
                // Si S√ç estamos logueados, muestra el panel
                    loginScreen.style.display = 'none';
                    rootContainer.style.display = 'flex';
                }

            } else {
                // Si vamos a cualquier otra p√°gina (portal, form), oculta AMBOS
                loginScreen.style.display = 'none';
                rootContainer.style.display = 'none';
            }
        }
        
        // --- INICIO: HELPER FUNCTIONS PARA LOCALSTORAGE ---
        const ENVIOS_KEY = 'demoEnvios';
        const CLIENTES_KEY = 'demoClientes';
        
        function getEnvios() {
            try {
                const data = localStorage.getItem(ENVIOS_KEY) || '[]';
                return JSON.parse(data);
            } catch (e) {
                console.error("Error al leer env√≠os de localStorage:", e);
                return [];
            }
        }
        
        function saveEnvios(enviosArray) {
            try {
                localStorage.setItem(ENVIOS_KEY, JSON.stringify(enviosArray));
            } catch (e) {
                console.error("Error al guardar env√≠os en localStorage:", e);
            }
        }
        
        function getClientes() {
            try {
                const data = localStorage.getItem(CLIENTES_KEY) || '{}';
                return JSON.parse(data);
            } catch (e) {
                console.error("Error al leer clientes de localStorage:", e);
                return {};
            }
        }
        
        function saveClientes(clientesObj) {
            try {
                localStorage.setItem(CLIENTES_KEY, JSON.stringify(clientesObj));
            } catch (e) {
                console.error("Error al guardar clientes en localStorage:", e);
            }
        }
        // --- FIN: HELPER FUNCTIONS PARA LOCALSTORAGE ---


        // --- INICIO DE LA L√ìGICA DEL FORMULARIO (form.html) ---
        function initFormLogic() { // <--- SDK ELIMINADO
            
            // --- SDK DE FIREBASE ELIMINADO ---
            // const { db, auth, doc, getDoc, collection, runTransaction, setDoc, signInAnonymously } = sdk;
            
            // L√≥gica de modal de listas (distritos, agencias)
            (function initModals() {
                // ... (l√≥gica de modals sin cambios) ...
                const campoDistrito = document.getElementById("distrito");
                const overlay = document.getElementById("modalDistrito");
                const buscador = document.getElementById("buscadorDistrito");
                const listaDistritos = document.getElementById("listaDistritos");
                let distritos = [];
                
                campoDistrito.addEventListener("click", () => {
                  overlay.style.display = "flex";
                  buscador.value = "";
                  mostrarDistritos(distritos);
                  buscador.focus();
                });
                overlay.addEventListener("click", (e) => { if (e.target === overlay) { overlay.style.display = "none"; } });
                buscador.addEventListener("input", () => {
                  const filtro = buscador.value.toLowerCase();
                  const filtrados = distritos.filter(d => d.toLowerCase().includes(filtro));
                  mostrarDistritos(filtrados);
                });
                function mostrarDistritos(lista) {
                  listaDistritos.innerHTML = "";
                  lista.forEach(d => {
                    const div = document.createElement("div");
                    div.className = "p-2 cursor-pointer border-b border-gray-100 hover:bg-gray-100 transition list-item";
                    div.textContent = d;
                    div.addEventListener("click", () => {
                      campoDistrito.value = d;
                      overlay.style.display = "none";
                    });
                    listaDistritos.appendChild(div);
                  });
                }
                fetch("https://raw.githubusercontent.com/complicidad/form/main/lstDinsides.json")
                  .then(res => res.json())
                  .then(data => {
                    distritos = data.map(item => `${item.Distrito} | ${item.Precio}`);
                    mostrarDistritos(distritos);
                  })
                  .catch(err => { console.error("Error cargando distritos:", err); });
                
                const campoAgencia = document.getElementById("agencia");
                const overlayAgencia = document.getElementById("modalAgencia");
                const buscadorAgencia = document.getElementById("buscadorAgencia");
                const listaAgencias = document.getElementById("listaAgencias");
                let agencias = [];
                
                campoAgencia.addEventListener("click", () => {
                  overlayAgencia.style.display = "flex";
                  buscadorAgencia.value = "";
                  mostrarAgencias(agencias);
                  buscadorAgencia.focus();
                });
                overlayAgencia.addEventListener("click", (e) => { if (e.target === overlayAgencia) { overlayAgencia.style.display = "none"; } });
                buscadorAgencia.addEventListener("input", () => {
                  const filtro = buscadorAgencia.value.toLowerCase();
                  const filtrados = agencias.filter(a => a.toLowerCase().includes(filtro));
                  mostrarAgencias(filtrados);
                });
                function mostrarAgencias(lista) {
                  listaAgencias.innerHTML = "";
                  lista.forEach(a => {
                    const [titulo, ...resto] = a.split("\n");
                    const div = document.createElement("div");
                    div.className = "p-2 cursor-pointer border-b border-gray-100 hover:bg-gray-100 transition list-item";
                    div.innerHTML = `<span class="font-semibold">${titulo}</span>${resto.length ? "<br><span class='text-sm text-gray-600'>" + resto.join("<br>") + "</span>" : ""}`;
                    div.addEventListener("click", () => {
                      campoAgencia.value = titulo;
                      overlayAgencia.style.display = "none";
                    });
                    listaAgencias.appendChild(div);
                  });
                }
                fetch("https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json")
                  .then(res => res.json())
                  .then(data => {
                    agencias = data.map(item => `${item.Agencia}\n${item.Direccion}`);
                    mostrarAgencias(agencias);
                  })
                  .catch(err => { console.error("Error cargando agencias:", err); });
            })();

            // --- AUTENTICACI√ìN AN√ìNIMA ELIMINADA ---
            // const authPromise = signInAnonymously(auth)...
            
            // L√≥gica principal del formulario (jQuery)
            $(document).ready(function () {
                // ... (toda la l√≥gica de UI, fechas, y checkboxes del formulario se mantiene igual) ...
                const $telefonoUsado = $("#telefonoUsado");
                const $telefonoDelivery = $("#telefonoDelivery");
                const $telefonoShalom = $("#telefonoShalom");
                const $usarMismoTelefonoDelivery = $("#usarMismoTelefonoDelivery");
                const $usarMismoTelefonoShalom = $("#usarMismoTelefonoShalom");
                const $telefonoDisplayDelivery = $("#telefonoDisplayDelivery");
                const $telefonoDisplayShalom = $("#telefonoDisplayShalom");

                function obtenerFechasEnvio() {
                    const ahora = new Date();
                    const opciones = [];
                    const diasPermitidos = [2, 5]; // martes = 2, viernes = 5
                    const horaCorte = 10; // 10:00 a.m.
                    const limite = new Date();
                    limite.setDate(ahora.getDate() + 14);

                    let fecha = new Date();
                    fecha.setHours(0, 0, 0, 0);

                    while (fecha <= limite) {
                        const diaSemana = fecha.getDay();
                        if (diasPermitidos.includes(diaSemana)) {
                            const fechaCorte = new Date(fecha);
                            fechaCorte.setDate(fecha.getDate() - 1);
                            fechaCorte.setHours(horaCorte, 0, 0, 0);
                            if (ahora < fechaCorte) {
                                opciones.push(new Date(fecha));
                            }
                        }
                        fecha.setDate(fecha.getDate() + 1);
                    }
                    return opciones;
                }

                function formatearFecha(fecha) {
                    return fecha.toLocaleDateString("es-ES", {
                        weekday: "long", day: "2-digit", month: "long", year: "numeric",
                    });
                }

                const $selectFecha = $("#fecha");
                $selectFecha.append($("<option>").val("").text("Elige una fecha de env√≠o...").prop("disabled", true).prop("selected", true));
                const fechas = obtenerFechasEnvio();
                fechas.forEach((f) => {
                    const option = $("<option>").val(f.toISOString().split("T")[0]).text(formatearFecha(f));
                    $selectFecha.append(option);
                });

                function limpiarCampos(idContenedor) {
                    const selector = `#${idContenedor} input, #${idContenedor} select`;
                    document.querySelectorAll(selector).forEach((campo) => {
                        if (campo.tagName === "SELECT") { $(campo).val(null).trigger("change"); } else { campo.value = ""; }
                        $(campo).removeClass("is-invalid");
                        if(campo.id === 'telefonoDelivery' || campo.id === 'telefonoShalom') { $(campo).prop('readonly', false).removeClass('bg-gray-100'); }
                    });
                    $usarMismoTelefonoDelivery.prop('checked', false);
                    $usarMismoTelefonoShalom.prop('checked', false);
                }
                
                function mostrarMensajeTelefono(mensaje, tipo = "success") {
                    const $toast = $("#toast"); // Usa el toast global
                    $toast.removeClass("bg-gradient-to-r from-brand-accent to-brand-accent-alt from-red-500 to-red-600 opacity-100 translate-y-0");
                    if (tipo === "success") { $toast.addClass("bg-gradient-to-r from-brand-accent to-brand-accent-alt shadow-brand-accent/25"); } 
                    else { $toast.addClass("bg-gradient-to-r from-red-500 to-red-600 shadow-red-500/25"); }
                    $toast.text(mensaje);
                    setTimeout(() => { $toast.addClass("opacity-100 translate-y-0"); }, 50);
                    clearTimeout($toast.data('timer'));
                    const timer = setTimeout(() => {
                        $toast.removeClass("opacity-100 translate-y-0").addClass("opacity-0 translate-y-2");
                        setTimeout(() => { $toast.removeClass("from-brand-accent to-brand-accent-alt from-red-500 to-red-600 shadow-brand-accent/25 shadow-red-500/25"); }, 300);
                    }, 5000); 
                    $toast.data('timer', timer);
                }

                function updateTelefonoDisplay() {
                    const val = $telefonoUsado.val() || 'N/A';
                    $telefonoDisplayDelivery.text(val);
                    $telefonoDisplayShalom.text(val);
                }
                updateTelefonoDisplay();
                $telefonoUsado.on('input', function() {
                    updateTelefonoDisplay();
                    if ($usarMismoTelefonoDelivery.is(':checked')) { $telefonoDelivery.val($(this).val()); }
                    if ($usarMismoTelefonoShalom.is(':checked')) { $telefonoShalom.val($(this).val()); }
                });

                $usarMismoTelefonoDelivery.on('change', function() {
                    const checked = $(this).is(':checked');
                    if (checked) {
                        $telefonoDelivery.val($telefonoUsado.val());
                        $telefonoDelivery.prop('readonly', true).removeClass('cursor-pointer').addClass('bg-gray-100');
                        $telefonoDelivery.removeClass('is-invalid');
                    } else {
                        $telefonoDelivery.val('');
                        $telefonoDelivery.prop('readonly', false).removeClass('bg-gray-100').focus();
                    }
                });
                $usarMismoTelefonoShalom.on('change', function() {
                    const checked = $(this).is(':checked');
                    if (checked) {
                        $telefonoShalom.val($telefonoUsado.val());
                        $telefonoShalom.prop('readonly', true).removeClass('cursor-pointer').addClass('bg-gray-100');
                        $telefonoShalom.removeClass('is-invalid');
                    } else {
                        $telefonoShalom.val('');
                        $telefonoShalom.prop('readonly', false).removeClass('bg-gray-100').focus();
                    }
                });

                $("#tipoAccion").on("change", function () {
                    limpiarCampos("camposDelivery");
                    limpiarCampos("camposShalom");
                    limpiarCampos("camposUsados");
                    $("#camposDelivery, #camposShalom, #camposUsados").attr("hidden", true).find("input, select").prop("disabled", true);
                    $usarMismoTelefonoDelivery.prop('checked', false);
                    $usarMismoTelefonoShalom.prop('checked', false);
                    const valor = $(this).val();
                    if (valor === "delivery") { $("#camposDelivery").attr("hidden", false).find("input, select").prop("disabled", false); } 
                    else if (valor === "shalom") { $("#camposShalom").attr("hidden", false).find("input, select").prop("disabled", false); } 
                    else if (valor === "usado") { $("#camposUsados").attr("hidden", false).find("input, select").prop("disabled", false); }

                    const $contenedorFecha = $("#contenedorFecha");
                    $contenedorFecha.hide();
                    if (["delivery", "shalom", "usado"].includes(valor)) {
                        if (valor === "delivery") { $("#camposDelivery").append($contenedorFecha); } 
                        else if (valor === "shalom") { $("#camposShalom").append($contenedorFecha); } 
                        else { $("#camposUsados").append($contenedorFecha); }
                        $contenedorFecha.show();
                        $("#fecha").prop("disabled", false);
                    } else {
                        $("#fecha").prop("disabled", true);
                    }
                    
                    let targetId = null; 
                    if (valor === "delivery") { targetId = "nombreDelivery"; } 
                    else if (valor === "shalom") { targetId = "nombreShalom"; } 
                    else if (valor === "usado") { targetId = "fecha"; }
                    if (targetId) {
                        setTimeout(() => {
                            const targetElement = document.getElementById(targetId);
                            if (targetElement) { targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                        }, 100); 
                    }
                });

                // Env√≠o del formulario
                $("#formulario").on("submit", async function (e) {
                    e.preventDefault();
                    $("#toast").removeClass("opacity-100 translate-y-0").addClass("opacity-0 translate-y-2");
                    function mostrarMensaje(mensaje, tipo = "success") { mostrarMensajeTelefono(mensaje, tipo); }
                    const tipoAccion = $("#tipoAccion").val();
                    function aplicarClaseError(id) {
                        $(`#${id}`).addClass('is-invalid');
                        $(`#${id}`).on('input change', function() { $(this).removeClass('is-invalid'); });
                    }
                    if (tipoAccion === "delivery") {
                        if (!$("#distrito").val()) {
                            mostrarMensaje("Por favor, selecciona un distrito de la lista", "error");
                            aplicarClaseError("distrito"); return;
                        }
                    }
                    if (tipoAccion === "shalom") {
                        if (!$("#agencia").val()) {
                            mostrarMensaje("Por favor, selecciona una agencia de la lista", "error");
                            aplicarClaseError("agencia"); return;
                        }
                    }
                    if (!this.checkValidity()) {
                        $(this).find(':invalid').each(function() { aplicarClaseError(this.id); });
                        this.reportValidity(); return;
                    }

                    const spinnerOverlay = document.getElementById('spinner');
                    spinnerOverlay.classList.remove('hidden');
                    spinnerOverlay.classList.add('flex');

                    // --- INICIO DE L√ìGICA DE LOCALSTORAGE (REEMPLAZA FIRESTORE) ---
                    try {
                        // --- AWAIT DE AUTH ELIMINADO ---
                        // await authPromise; 
                        console.log("Procediendo con el env√≠o local.");
                        
                        const telefonoCliente = $("#telefonoUsado").val().replace(/\D/g, "");
                        
                        // Obtenemos datos de localStorage
                        const envios = getEnvios();
                        const clientes = getClientes();

                        const envioData = {
                            id: 'local-' + new Date().getTime(), // ID local √∫nico
                            fechaRegistro: new Date().toISOString(), // Usamos ISO string
                            cliente: telefonoCliente,
                            courier: tipoAccion.toUpperCase(),
                            fechaEnvio: $("#fecha").val(),
                            estado: "PENDIENTE",
                        };

                        let clienteData = {};
                        let esEnvioNuevo = false;

                        if (tipoAccion === "delivery") {
                            clienteData.nombre = $("#nombreDelivery").val();
                            clienteData.telefono = $("#telefonoDelivery").val();
                            clienteData.distrito = $("#distrito").val();
                            clienteData.direccion = $("#direccion").val();
                            clienteData.referencia = $("#referencia").val();
                            clienteData.tipoUltimoEnvio = "delivery";
                            esEnvioNuevo = true;
                            Object.assign(envioData, clienteData);
                        } else if (tipoAccion === "shalom") {
                            clienteData.nombre = $("#nombreShalom").val();
                            clienteData.telefono = $("#telefonoShalom").val();
                            clienteData.DNI = $("#DNI").val();
                            clienteData.agencia = $("#agencia").val();
                            clienteData.tipoUltimoEnvio = "shalom";
                            esEnvioNuevo = true;
                            Object.assign(envioData, clienteData);
                        } else if (tipoAccion === "usado") {
                            // const clienteDoc = await getDoc(clienteRef); // <--- REEMPLAZADO
                            const datosCliente = clientes[telefonoCliente]; // <--- Lectura local
                            
                            if (!datosCliente) { // <--- REEMPLAZADO
                                mostrarMensaje("El n√∫mero ingresado no est√° registrado.", "error");
                                aplicarClaseError("telefonoUsado");
                                $("#telefonoUsado").focus();
                                spinnerOverlay.classList.remove('flex');
                                spinnerOverlay.classList.add('hidden');
                                return;
                            } else {
                                // const datosCliente = clienteDoc.data(); // <--- REEMPLAZADO
                                if (datosCliente.tipoUltimoEnvio) {
                                     envioData.courier = datosCliente.tipoUltimoEnvio.toUpperCase();
                                }
                                envioData.nombre = datosCliente.nombre || "";
                                envioData.telefono = datosCliente.telefono || "";
                                envioData.distrito = datosCliente.distrito || "";
                                envioData.direccion = datosCliente.direccion || "";
                                envioData.referencia = datosCliente.referencia || "";
                                envioData.DNI = datosCliente.DNI || "";
                                envioData.agencia = datosCliente.agencia || "";
                            }
                        }

                        console.log("Iniciando guardado local...");
                        // --- TRANSACCI√ìN REEMPLAZADA POR GUARDADO DIRECTO ---
                        // await runTransaction(db, async (transaction) => { ... });
                        
                        // 1. A√±adir nuevo env√≠o
                        envios.push(envioData);
                        saveEnvios(envios);
                        
                        // 2. Actualizar (o crear) cliente si es necesario
                        if (esEnvioNuevo) {
                            // Hacemos merge manual con datos existentes
                            clientes[telefonoCliente] = { ...clientes[telefonoCliente], ...clienteData };
                            saveClientes(clientes);
                        }
                        // --- FIN DE REEMPLAZO DE TRANSACCI√ìN ---
                        
                        console.log("¬°Guardado local completado!");
                        
                        // Simular espera de red
                        await new Promise(resolve => setTimeout(resolve, 500)); 

                        $("#formulario").hide();
                        $("#successMessage").removeClass('hidden').addClass('flex');
                        $("#formulario")[0].reset();
                        $("#camposDelivery, #camposShalom, #camposUsados").attr("hidden", true).find("input, select").prop("disabled", true);
                        $("#contenedorFecha").hide();
                        $("#fecha").empty();
                        $("#fecha").append($("<option>").val("").text("Elige una fecha de env√≠o...").prop("disabled", true).prop("selected", true));
                        const nuevasFechas = obtenerFechasEnvio();
                        nuevasFechas.forEach(f => {
                            $("#fecha").append($("<option>").val(f.toISOString().split("T")[0]).text(formatearFecha(f)));
                        });
                        $usarMismoTelefonoDelivery.prop('checked', false);
                        $usarMismoTelefonoShalom.prop('checked', false);
                        $telefonoDelivery.prop('readonly', false).removeClass('bg-gray-100');
                        $telefonoShalom.prop('readonly', false).removeClass('bg-gray-100');
                    } catch (err) {
                        console.error("Error al guardar en LocalStorage:", err);
                        mostrarMensaje("Ocurri√≥ un error al guardar tus datos", "error");
                    } finally {
                        spinnerOverlay.classList.remove('flex');
                        spinnerOverlay.classList.add('hidden');
                    }
                    // --- FIN DE L√ìGICA DE LOCALSTORAGE ---
                });
            });
        }
        // --- FIN DE LA L√ìGICA DEL FORMULARIO ---


        // --- INICIO DE LA L√ìGICA DEL PORTAL (index.html) ---
        function initPortalLogic() {
            document.getElementById('clearData').addEventListener('click', () => {
                if (confirm('¬øEst√°s seguro de que deseas borrar los datos de env√≠o guardados en la demo?')) {
                    // --- CAMBIO ---
                    // Ahora s√≠ borra los datos de localStorage
                    localStorage.removeItem(ENVIOS_KEY);
                    localStorage.removeItem(CLIENTES_KEY);
                    alert('Datos de la demo limpiados.');
                }
            });
        }
        // --- FIN DE LA L√ìGICA DEL PORTAL ---


        // =================================================================
        // --- INICIO DE LA L√ìGICA DEL DASHBOARD (dashboard.html) ---
        // =================================================================
        function initDashboardLogic() { // <--- SDK ELIMINADO
            
            feather.replace();

            // ======================= INICIO: L√≥gica de Firebase ELIMINADA =======================
            // let app, db, auth, userId, enviosCollectionRef;
            // async function initFirebase() { ... } // ELIMINADO
            // --- FIN: L√≥gica de Firebase ELIMINADA ---

            // --- L√≥gica de Autenticaci√≥n (SIMULADA) ---
            const loginScreen = document.getElementById('loginScreen');
            const rootContainerEl = document.getElementById('root-container');
            const loginForm = document.getElementById('loginForm');
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            const loginError = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');

            async function handleLogin(e) {
                e.preventDefault();
                loginButton.disabled = true;
                loginButton.textContent = 'Ingresando...';
                loginError.classList.add('hidden');
                
                // --- INICIO: SIMULACI√ìN DE LOGIN ---
                const email = loginEmail.value;
                const password = loginPassword.value;
                
                // Simular espera de red
                await new Promise(resolve => setTimeout(resolve, 500)); 

                if (email === 'admin@demo.com' && password === '123456') {
                    console.log("Inicio de sesi√≥n simulado exitoso.");
                    isLoggedIn = true; // Variable global
                    rootContainerEl.style.display = 'flex';
                    loginScreen.style.display = 'none';
                    ejecutarConsultaEnvios(); // Cargar datos locales
                    syncBusinessInfo();
                } else {
                    console.error("Error de inicio de sesi√≥n simulado.");
                    loginError.textContent = 'Error: Correo o contrase√±a incorrectos.';
                    loginError.classList.remove('hidden');
                    loginButton.disabled = false;
                    loginButton.textContent = 'Ingresar';
                }
                // --- FIN: SIMULACI√ìN DE LOGIN ---
            }

            async function handleLogout() {
                // --- INICIO: SIMULACI√ìN DE LOGOUT ---
                console.log("Sesi√≥n cerrada (simulado).");
                isLoggedIn = false; // Variable global
                todosLosEnvios = []; // Limpiar datos
                rootContainerEl.style.display = 'none';
                loginScreen.style.display = 'flex';
                loginButton.disabled = false;
                loginButton.textContent = 'Ingresar';
                loginForm.reset();
                // --- FIN: SIMULACI√ìN DE LOGOUT ---
            }
            
            function handleNotifyClick(id) {
                // ... (l√≥gica de notificaci√≥n sin cambios) ...
                const envio = todosLosEnvios.find(e => e.id === id);
                if (!envio) { showToast('Error: No se encontr√≥ el env√≠o.'); return; }
                if (!envio.cliente) { showToast('Este env√≠o no tiene un n√∫mero de tel√©fono asignado.'); return; }
                const businessName = localStorage.getItem('businessName') || 'Tu Emprendimiento';
                let destinoBlock = '';
                const courier = (envio.courier || 'OTRO').toUpperCase();
                if (courier === 'DELIVERY') {
                    let diaPago = 'N/A';
                    let distritoMostrado = envio.distrito || 'N/A';
                    let tarifaMostrada = 'S/. 12';
                    if (envio.fechaEnvioInput) {
                        try {
                            const fecha = new Date(envio.fechaEnvioInput + 'T12:00:00');
                            const fechaPago = new Date(fecha);
                            fechaPago.setDate(fecha.getDate() - 1);
                            diaPago = new Intl.DateTimeFormat('es-ES', { day: 'numeric', month: 'short' }).format(fechaPago);
                        } catch (e) { console.error("Error al parsear fecha para plantilla: ", e); }
                    }
                    if (envio.distrito && envio.distrito.includes('|')) {
                        const partes = envio.distrito.split('|');
                        distritoMostrado = partes[0].trim();
                        tarifaMostrada = partes[1].trim();
                    }
                    destinoBlock = `* _Distrito: ${distritoMostrado}_
* _Direcci√≥n: ${envio.direccion || 'N/A'}_
* _Referencia: ${envio.referencia || '(Sin referencia)'}_

*Pago del DELIVERY* üíö
* _D√≠a de pago: ${diaPago} (m√°x. 6pm)_
* _tarifa plana: ${tarifaMostrada}_
* _Yape: 981391159 - 975100450_
* _Titular: Rosalinda Barzola_`;
                } else {
                    destinoBlock = `* _DNI: ${envio.DNI || 'N/A'}_
* _Agencia (Destino): ${envio.agencia || 'N/A'}_`;
                }
                const mensaje = `*¬°Hola bonita!* üòäüíñ
_Tu pedido ya est√° programado üí´_

*Env√≠o por ${envio.courier || 'N/A'}* üì¶
* _Fecha de env√≠o: ${envio.fechaEnvioDisplay || 'Por programar'}_
* _Destinatario: ${envio.nombre || 'N/A'} (${envio.telefono || 'N/A'})_
${destinoBlock}

_Atte. CompliEnv√≠os_ ü•∞
`;
                let numeroFormateado = envio.cliente.replace(/[^\d]/g, '');
                if (numeroFormateado.length === 9 && !numeroFormateado.startsWith('51')) {
                    numeroFormateado = '51' + numeroFormateado;
                }
                const whatsappUrl = `https://wa.me/${numeroFormateado}?text=${encodeURIComponent(mensaje)}`;
                window.open(whatsappUrl, '_blank');
            }

            // --- LISTENER DE AUTH ELIMINADO ---
            // function setupAuthListener() { ... } // ELIMINADO

            // --- L√≥gica del Men√∫ Colapsable (Dashboard) ---
            // ... (l√≥gica del men√∫ sin cambios) ...
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            function closeSidebar() { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); }
            function openSidebar() { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); }
            sidebarToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                if (sidebar.classList.contains('-translate-x-full')) { openSidebar(); } else { closeSidebar(); }
            });
            sidebarOverlay.addEventListener('click', closeSidebar);


            // --- L√≥gica Dropdown Plantillas (Dashboard) ---
            // ... (l√≥gica del dropdown sin cambios) ...
            const plantillasBtn = document.getElementById('plantillasDropdownBtn');
            const plantillasMenu = document.getElementById('plantillasDropdownMenu');
            plantillasBtn.addEventListener('click', () => { plantillasMenu.classList.toggle('hidden'); });
            window.addEventListener('click', (e) => {
                if (plantillasBtn && !plantillasBtn.contains(e.target) && plantillasMenu && !plantillasMenu.contains(e.target)) {
                    plantillasMenu.classList.add('hidden');
                }
            });

            // --- L√ìGICA DEL MEN√ö VERTICAL (DASHBOARD) ---
            // Se elimin√≥ el event listener conflictivo de 'navLinks.forEach'.
            // El manejador global ahora se encargar√° de esto.
            const navLinks = document.querySelectorAll('#page-dashboard .nav-link'); // <--- A√öN NECESITAMOS ESTA L√çNEA
            const sections = document.querySelectorAll('#page-dashboard main > section'); // <--- A√öN NECESITAMOS ESTA L√çNEA
            const headerTitle = document.getElementById('headerTitle');
            const activeClasses = ['bg-sidebar-active-bg', 'text-white'];
            const inactiveClasses = ['text-gray-300', 'hover:bg-sidebar-hover', 'hover:text-white'];

            // --- BLOQUE ELIMINADO ---
            // navLinks.forEach(link => {
            //     link.addEventListener('click', (e) => {
            //         ...
            //     });
            // });
            // --- FIN DEL BLOQUE ELIMINADO ---
            
            // Solo dejamos la sincronizaci√≥n de clases al inicio
            document.querySelector('#page-dashboard .nav-link.active')?.classList.remove(...inactiveClasses);
            document.querySelector('#page-dashboard .nav-link.active')?.classList.add(...activeClasses);


            // --- L√≥gica del Panel (Dashboard) ---
            // ... (elementos del DOM sin cambios) ...
            const btnLimpiarFiltros = document.getElementById('btnLimpiarFiltros');
            const templateLinks = document.querySelectorAll('#plantillasDropdownMenu a');
            const btnEtiquetas = document.getElementById('btnEtiquetas');
            const tbodyEnvios = document.getElementById('tbodyEnvios');
            const mobileCardContainer = document.getElementById('mobileCardContainer');
            const filtroCliente = document.getElementById('filtroCliente');
            const filtroFecha = document.getElementById('filtroFecha');
            const filtroTipo = document.getElementById('filtroTipo');
            const filtroDuplicados = document.getElementById('filtroDuplicados');
            const btnAplicarFiltros = document.getElementById('btnAplicarFiltros');
            const tableContainer = document.getElementById('tableContainer').querySelector('.overflow-auto');
            const mobileContainerParent = document.getElementById('mobileCardContainer').parentElement;
            const emptyStateContainer = document.getElementById('emptyStateContainer');
            const batchActionsContainer = document.getElementById('batchActionsContainer');
            const checkTodos = document.getElementById('checkTodos');
            const thCheckTodos = document.getElementById('thCheckTodos');
            const selCount = document.getElementById('selCount');
            const accionLote = document.getElementById('accionLote');
            // =================================================================
            // --- INICIALIZADOR PRINCIPAL ---
            // =================================================================
            
            let todosLosEnvios = [];
            // let unsubscribeEnvios = null; // ELIMINADO

            function ejecutarConsultaEnvios() {
                // --- REEMPLAZO DE FIREBASE POR LOCALSTORAGE ---
                // if (unsubscribeEnvios) { unsubscribeEnvios(); }
                // if (!enviosCollectionRef) { ... }
                
                showToast('Cargando datos locales...');
                
                // 1. Leer TODOS los env√≠os desde localStorage
                todosLosEnvios = getEnvios();
                
                // 2. Formatear fechas (Firestore lo hac√≠a autom√°ticamente)
                todosLosEnvios = todosLosEnvios.map(data => {
                    const formatTimestamp = (isoString) => {
                        if (!isoString) return { display: '', input: '' };
                        try {
                            // Asumir que la fecha guardada es YYYY-MM-DD o ISO completa
                            const jsDate = new Date(isoString);
                            // Corregir problema de zona horaria (tomar como local)
                            const utcDate = new Date(jsDate.getUTCFullYear(), jsDate.getUTCMonth(), jsDate.getUTCDate());
                            
                            const day = String(utcDate.getDate()).padStart(2, '0');
                            const month = String(utcDate.getMonth() + 1).padStart(2, '0');
                            const year = utcDate.getFullYear();
                            
                            // Si la fecha es inv√°lida (ej. solo 'PENDIENTE'), devuelve vac√≠o
                            if (isNaN(day)) return { display: '', input: '' };

                            return { 
                                display: `${day}-${month}-${year}`, // dd-mm-yyyy
                                input: `${year}-${month}-${day}`   // YYYY-MM-DD
                            };
                        } catch (e) {
                            return { display: '', input: '' };
                        }
                    };
                    
                    const fechaReg = formatTimestamp(data.fechaRegistro);
                    const fechaEnvio = formatTimestamp(data.fechaEnvio);
                    
                    return {
                        ...data, // id, cliente, nombre, etc.
                        estado: data.estado || 'PENDIENTE',
                        fechaReg: fechaReg.display,
                        fechaEnvioDisplay: fechaEnvio.display,
                        fechaEnvioInput: fechaEnvio.input,
                    };
                });
                
                // 3. Aplicar filtros (ahora locales)
                aplicarFiltros();
                showToast('Env√≠os locales cargados.');
                // --- FIN DE REEMPLAZO ---
            }

            function aplicarFiltros() {
                const hoy = new Date();
                const offset = hoy.getTimezoneOffset() * 60000;
                const hoyLocal = new Date(hoy.getTime() - offset);
                const hoyString = hoyLocal.toISOString().split('T')[0];
                
                // --- OBTENER TODOS LOS FILTROS ---
                const clienteFilter = filtroCliente.value.toLowerCase();
                const fechaFilter = filtroFecha.value; // YYYY-MM-DD
                const tipoFilter = filtroTipo.value;
                const mostrarSoloDuplicados = filtroDuplicados.checked;
                
                // Detectar duplicados
                const seen = {};
                const duplicates = new Set();
                todosLosEnvios.forEach(envio => {
                    const key = `${envio.cliente}-${envio.fechaEnvioDisplay || ''}`;
                    if (seen[key]) { duplicates.add(key); } else { seen[key] = true; }
                });

                // --- FILTRADO LOCAL (REEMPLAZA FILTRADO FIRESTORE) ---
                const algunFiltroActivo = clienteFilter || fechaFilter || tipoFilter || mostrarSoloDuplicados;

                const enviosFiltrados = todosLosEnvios.filter(envio => {
                    // Excluir eliminados SIEMPRE
                    if (envio.estado === 'ELIMINADO') return false;
                    
                    // Aplicar filtros locales
                    const clienteMatch = !clienteFilter || (envio.cliente && envio.cliente.includes(clienteFilter));
                    const fechaMatch = !fechaFilter || envio.fechaEnvioInput === fechaFilter;
                    const tipoMatch = !tipoFilter || envio.courier === tipoFilter;
                    
                    let estadoMatch = true;
                    if (!algunFiltroActivo) {
                        // Si no hay filtros, mostrar solo PENDIENTE
                        estadoMatch = (envio.estado === 'PENDIENTE');
                    }
                    
                    let duplicadoMatch = true;
                    if (mostrarSoloDuplicados) {
                        const key = `${envio.cliente}-${envio.fechaEnvioDisplay || ''}`;
                        duplicadoMatch = duplicates.has(key);
                    }
                    
                    return clienteMatch && fechaMatch && tipoMatch && estadoMatch && duplicadoMatch;
                });
                // --- FIN FILTRADO LOCAL ---
                      
                enviosFiltrados.sort((a, b) => {
                    const fechaA = a.fechaEnvio || ''; const fechaB = b.fechaEnvio || '';
                    const clienteA = String(a.cliente || ''); const clienteB = String(b.cliente || '');
                    const comparacionFecha = fechaB.localeCompare(fechaA);
                    if (comparacionFecha !== 0) { return comparacionFecha; }
                    return clienteB.localeCompare(clienteA);
                });        
                renderizarTabla(enviosFiltrados, duplicates);
            }

            function renderizarTabla(envios, duplicates) {
                // ... (l√≥gica de renderizado sin cambios) ...
                tbodyEnvios.innerHTML = '';
                mobileCardContainer.innerHTML = '';
                const visibleCountEl = document.getElementById('visibleCount');
                if(visibleCountEl) { visibleCountEl.textContent = `Mostrando ${envios.length} de ${todosLosEnvios.length} env√≠os`; }
                const hasEnvios = envios.length > 0;
                tableContainer.parentElement.classList.toggle('hidden', !hasEnvios);
                emptyStateContainer.classList.toggle('hidden', hasEnvios);
                batchActionsContainer.classList.toggle('hidden', !hasEnvios);

                if (hasEnvios) {
                    envios.forEach(envio => {
                        const getEstadoClass = (estado) => {
                            switch (estado) {
                                case 'PENDIENTE': return 'bg-yellow-100 text-badge-pending';
                                case 'ENVIADO': return 'bg-orange-100 text-badge-sent';
                                case 'NOTIFICADO': return 'bg-green-100 text-badge-notificado';
                                case 'REPROGRAMADO': return 'bg-purple-100 text-badge-rescheduled';
                                default: return 'bg-gray-100 text-gray-800';
                            }
                        };
                        const key = `${envio.cliente}-${envio.fechaEnvioDisplay || ''}`;
                        const isDuplicate = duplicates.has(key);
                        const duplicateClass = isDuplicate ? 'bg-yellow-200/50' : '';
                        const tr = document.createElement('tr');
                        tr.className = `border-b border-gray-100 hover:bg-orange-50/50 transition-colors duration-200 ${duplicateClass}`;
                        tr.dataset.id = envio.id;
                        tr.innerHTML = `
                            <td class="p-3 text-center"><input type="checkbox" class="rowCheck rounded border-gray-300 text-accent focus:ring-accent" data-id="${envio.id}"></td>
                            <td class="p-3 text-sm text-gray-700">${envio.fechaReg || ''}</td>
                            <td class="p-3 text-sm text-gray-700">${envio.cliente}</td>
                            <td class="p-3 text-sm text-gray-700">${envio.courier}</td>
                            <td class="p-3 text-sm text-gray-700">
                                <span class="font-bold text-gray-900">${envio.nombre || 'N/A'}</span>
                                <span class="block text-sm text-gray-500">${envio.telefono || 'N/A'}</span>
                                ${(envio.DNI) ? `<span class="block text-sm text-gray-500 mt-1 pt-1 border-t border-gray-100">${envio.DNI}</span>` : ''}
                            </td>
                            <td class="p-3 text-sm text-gray-700">
                                ${(() => {
                                    if (envio.courier === 'DELIVERY') {
                                        return `<span class="font-semibold text-gray-800">${envio.distrito || 'N/A'}</span>
                                                <span class="block text-xs text-gray-500">${envio.direccion || 'N/A'}</span>
                                                <span class="block text-xs text-gray-500 italic">${envio.referencia || 'N/A'}</span>`;
                                    } else { return `<span class="font-semibold text-gray-800">${envio.agencia || 'N/A'}</span>`; }
                                })()}
                            </td>
                            <td class="p-3 text-sm text-gray-700">${envio.fechaEnvioDisplay || ''}</td>
                            <td class="p-3 text-sm">
                                <div class="inline-edit-container">
                                    <select class="inline-edit-estado select border border-gray-200 bg-white focus:outline-none focus:border-accent focus:ring-1 focus:ring-orange-100" data-original-estado="${envio.estado}">
                                        <option value="PENDIENTE" ${envio.estado === 'PENDIENTE' ? 'selected' : ''}>Pendiente</option>
                                        <option value="ENVIADO" ${envio.estado === 'ENVIADO' ? 'selected' : ''}>Enviado</option>
                                        <option value="NOTIFICADO" ${envio.estado === 'NOTIFICADO' ? 'selected' : ''}>Notificado</option>
                                        <option value="REPROGRAMADO" ${envio.estado === 'REPROGRAMADO' ? 'selected' : ''}>Reprogramado</option>
                                        <option value="ELIMINAR" class="text-red-600 font-semibold">Eliminar...</option>
                                    </select>
                                    <input type="date" class="inline-edit-fecha input border border-gray-200 bg-white focus:outline-none focus:border-accent focus:ring-1 focus:ring-orange-100 oculto" value="${envio.fechaEnvioInput || ''}" data-original-fecha="${envio.fechaEnvioInput || ''}">
                                    <button class="inline-save-btn btn primary bg-accent text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 inline-flex items-center justify-center gap-1 oculto">
                                        <i data-feather="save" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </td>                    
                            <td class="p-3 text-center">
                                <div class="flex justify-center items-center gap-2">
                                    <button data-id="${envio.id}" class="btn-edit-full text-blue-600 hover:text-blue-800" title="Editar Env√≠o Completo">
                                        <i data-feather="edit-2" class="w-4 h-4"></i>
                                    </button>
                                    <button data-id="${envio.id}" class="btn-notify text-green-600 hover:text-green-800" title="Notificar por WhatsApp">
                                        <i data-feather="send" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbodyEnvios.appendChild(tr);

                        const card = document.createElement('div');
                        const cardBgClass = isDuplicate ? 'bg-yellow-200/50' : 'bg-white';
                        card.className = `${cardBgClass} rounded-xl shadow p-4 border border-gray-200 space-y-3`;
                        card.dataset.id = envio.id;
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" class="rowCheck rounded border-gray-300 text-accent focus:ring-accent" data-id="${envio.id}">
                                    <div>
                                        <p class="font-bold text-gray-800">${envio.nombre}</p>
                                        ${(() => {
                                            if (envio.courier === 'DELIVERY') { return `<p class="text-sm text-gray-500">${envio.distrito || 'N/A'}</p>`; } 
                                            else { return `<p class="text-sm text-gray-500">${envio.agencia || 'N/A'}</p>`; }
                                        })()}
                                    </div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 space-y-2 pl-8">
                                <p><strong class="text-gray-500">Cliente:</strong> ${envio.cliente}</p>
                                <p><strong class="text-gray-500">Courier:</strong> ${envio.courier}</p>
                                <p><strong class="text-gray-500">Fecha Env√≠o:</strong> ${envio.fechaEnvioDisplay || ''}</p>
                            </div>
                            <div class="inline-edit-container">
                                <label class="block text-xs text-gray-500 font-semibold mb-1">Estado:</label>
                                <select class="inline-edit-estado select p-2 border border-gray-200 rounded-lg bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-1 focus:ring-orange-100" data-original-estado="${envio.estado}">
                                    <option value="PENDIENTE" ${envio.estado === 'PENDIENTE' ? 'selected' : ''}>Pendiente</option>
                                    <option value="ENVIADO" ${envio.estado === 'ENVIADO' ? 'selected' : ''}>Enviado</option>
                                    <option value="NOTIFICADO" ${envio.estado === 'NOTIFICADO' ? 'selected' : ''}>Notificado</option>
                                    <option value="REPROGRAMADO" ${envio.estado === 'REPROGRAMADO' ? 'selected' : ''}>Reprogramado</option>
                                </select>
                                <input type="date" class="inline-edit-fecha input p-2 border border-gray-200 rounded-lg bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-1 focus:ring-orange-100 oculto" value="${envio.fechaEnvioInput || ''}" data-original-fecha="${envio.fechaEnvioInput || ''}">
                                <button class="inline-save-btn btn primary bg-accent text-white rounded-lg font-bold text-sm shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 inline-flex items-center justify-center gap-1 oculto py-2">
                                    <i data-feather="save" class="w-4 h-4"></i> Guardar Cambio
                                </button>
                            </div>
                            <div class="flex justify-end items-center pt-2 gap-4">
                                <button data-id="${envio.id}" class="btn-edit-full text-blue-600 hover:text-blue-800 text-sm font-bold inline-flex items-center gap-1" title="Editar Env√≠o Completo">
                                    <i data-feather="edit-2" class="w-4 h-4"></i> Editar
                                </button>
                                <button data-id="${envio.id}" class="btn-notify text-green-600 hover:text-green-800 text-sm font-bold inline-flex items-center gap-1" title="Notificar por WhatsApp">
                                    <i data-feather="send" class="w-4 h-4"></i> Notificar
                                </button>
                            </div>
                        `;
                        mobileCardContainer.appendChild(card);
                    });
                    feather.replace();
                }
                contarSeleccionados();
            }

            function obtenerIdsSeleccionados() {
                // ... (l√≥gica sin cambios) ...
                if (window.innerWidth < 768) { return [...mobileCardContainer.querySelectorAll('.rowCheck:checked')].map(chk => chk.dataset.id); } 
                else { return [...tbodyEnvios.querySelectorAll('.rowCheck:checked')].map(chk => chk.dataset.id); }
            }

            function contarSeleccionados() {
                // ... (l√≥gica sin cambios) ...
                const seleccionados = Math.max(tbodyEnvios.querySelectorAll('.rowCheck:checked').length, mobileCardContainer.querySelectorAll('.rowCheck:checked').length);
                const totalVisibleRows = (window.innerWidth < 768) ? mobileCardContainer.children.length : tbodyEnvios.rows.length;
                selCount.textContent = `${seleccionados} seleccionados`;
                const allChecked = totalVisibleRows > 0 && seleccionados === totalVisibleRows;
                checkTodos.checked = allChecked;
                thCheckTodos.checked = allChecked;
                const loteRightControls = batchActionsContainer.querySelector('.lote-right');
                const hasSelections = seleccionados > 0;
                selCount.classList.toggle('hidden', !hasSelections);
                if (loteRightControls) { loteRightControls.classList.toggle('hidden', !hasSelections); }
            }
            
            function seleccionarTodos(checked) {
                // ... (l√≥gica sin cambios) ...
                document.querySelectorAll('.rowCheck').forEach(chk => chk.checked = checked);
                contarSeleccionados();
            }

            accionLote.addEventListener('change', () => {
                // ... (l√≥gica sin cambios) ...
                const esReprog = accionLote.value === 'REPROGRAMADO';
                fechaReprog.classList.toggle('oculto', !esReprog);
            });    

            btnAplicarLote.addEventListener('click', async () => {
                const seleccionadosIds = obtenerIdsSeleccionados();
                const accion = accionLote.value;
                if (seleccionadosIds.length === 0 || !accion) {
                    showToast(!accion ? 'Por favor, selecciona una acci√≥n.' : 'No has seleccionado ning√∫n env√≠o.');
                    return;
                }
                if (accion === 'ELIMINAR') {
                    abrirModalConfirmacion(seleccionadosIds); return;
                }
                
                let updates = {};
                if (accion === 'REPROGRAMADO') {
                    if (!fechaReprog.value) { showToast('Debes seleccionar una fecha para reprogramar.'); return; }
                    updates = { estado: 'REPROGRAMADO', fechaEnvio: fechaReprog.value };
                } else { updates = { estado: accion }; }

                showToast('Aplicando cambios...');
                try {
                    // --- INICIO: REEMPLAZO LOCALSTORAGE ---
                    // const batch = writeBatch(db); // ELIMINADO
                    let envios = getEnvios();
                    let actualizados = 0;
                    
                    envios.forEach((envio) => {
                        if (seleccionadosIds.includes(envio.id)) {
                            Object.assign(envio, updates); // Aplicar cambios
                            actualizados++;
                        }
                    });
                    
                    saveEnvios(envios); // Guardar el array completo
                    // await batch.commit(); // ELIMINADO
                    
                    showToast(`Acci√≥n en lote aplicada a ${actualizados} env√≠os.`);
                    ejecutarConsultaEnvios(); // Recargar la vista
                    // --- FIN: REEMPLAZO LOCALSTORAGE ---
                } catch (error) {
                    console.error('Error batch updating local:', error);
                    showToast('Error al aplicar la acci√≥n.');
                } finally {
                    accionLote.value = '';
                    fechaReprog.classList.add('oculto');
                }
            });

            checkTodos.addEventListener('change', (e) => seleccionarTodos(e.target.checked));
            thCheckTodos.addEventListener('change', (e) => seleccionarTodos(e.target.checked));
            
            document.getElementById('envios').addEventListener('change', (e) => {
                // ... (l√≥gica de checkboxes sin cambios) ...
                if(e.target.classList.contains('rowCheck')) {
                    const id = e.target.dataset.id;
                    const isChecked = e.target.checked;
                    document.querySelectorAll(`.rowCheck[data-id="${id}"]`).forEach(chk => {
                        if (chk !== e.target) chk.checked = isChecked;
                    });
                    contarSeleccionados();
                }
            });

            btnEtiquetas.addEventListener('click', () => {
                // ... (l√≥gica de etiquetas sin cambios) ...
                const seleccionadosIds = obtenerIdsSeleccionados();
                if (seleccionadosIds.length === 0) { showToast('Debes seleccionar al menos un env√≠o para imprimir etiquetas.'); return; }
                const enviosSeleccionados = todosLosEnvios.filter(envio => seleccionadosIds.includes(envio.id));
                const printContainer = document.getElementById('print-container');
                const businessName = localStorage.getItem('businessName') || 'Tu Emprendimiento';
                const logoSrc = localStorage.getItem('businessLogo');
                let labelsHtml = '';
                enviosSeleccionados.forEach(envio => {
                    let destinationHtml = '', detailsHtml = '';
                    if (envio.courier === 'DELIVERY') {
                        let distritoMostrado = envio.distrito || 'N/A';
                        if (envio.distrito && envio.distrito.includes('|')) {
                            distritoMostrado = envio.distrito.split('|')[0].trim();
                        }
                        destinationHtml = `
                            <div class="label-section">
                                <div class="label-section-title">Destino:</div>
                                <p class="label-destination-text">
                                    <strong>Distrito:</strong> ${distritoMostrado}<br>
                                    <strong>Fecha Entrega:</strong> ${envio.fechaEnvioDisplay || ''}<br>
                                    <strong>Detalle:</strong> Ropa<br>
                                    <strong>Cobrar:</strong> S/. 0,00<br>
                                </p>
                            </div>`;
                    } else {
                        destinationHtml = `
                            <div class="label-section">
                                <div class="label-section-title">Destino:</div>
                                <p class="label-destination-text">
                                    <strong>DNI/CE:</strong> ${envio.DNI || 'N/A'}<br>
                                    <strong>Agencia:</strong> ${envio.agencia || 'N/A'}
                                </p>
                            </div>`;
                    }
                    labelsHtml += `
                        <div class="label-card">
                            <div class="label-header">
                                ${logoSrc ? `<img src="${logoSrc}" alt="Logo" class="label-logo">` : '<div></div>'}
                                <div class="label-business-name">${businessName}</div>
                            </div>
                            <div class="label-body">
                                <div class="label-section">
                                    <div class="label-section-title">Para:</div>
                                    <div class="label-recipient-name">${String(envio.nombre || '').toUpperCase()}</div>
                                    <div class="label-recipient-phone">${envio.telefono || 'Sin tel√©fono'}</div>
                                </div>
                                ${destinationHtml}
                                ${detailsHtml}
                            </div>
                            <div class="label-footer">
                                <div class="label-courier-info">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                                    <span>${envio.courier || 'N/A'}</span>
                                </div>
                            </div>
                        </div>`;
                });
                printContainer.innerHTML = labelsHtml;
                window.print();
            });

            templateLinks.forEach(link => {
                // ... (l√≥gica de exportaci√≥n a Excel sin cambios) ...
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    plantillasMenu.classList.add('hidden');
                    const seleccionadosIds = obtenerIdsSeleccionados();
                    if (seleccionadosIds.length === 0) { showToast('Debes seleccionar al menos un env√≠o para exportar.'); return; }
                    const templateId = e.target.id;
                    let targetCourier = '', filename = 'exportacion_filtrada.xlsx';
                    switch (templateId) {
                        case 'btnTplDelivery': targetCourier = 'DELIVERY'; filename = 'exportacion_delivery.xlsx'; break;
                        case 'btnTplShalom': targetCourier = 'SHALOM'; filename = 'exportacion_shalom.xlsx'; break;
                        case 'btnTplOlva': targetCourier = 'OLVA'; filename = 'exportacion_olva.xlsx'; break;
                        default: showToast('Tipo de plantilla no reconocido.'); return;
                    }
                    const enviosSeleccionados = todosLosEnvios.filter(envio => seleccionadosIds.includes(envio.id) && envio.courier === targetCourier);
                    if (enviosSeleccionados.length === 0) { showToast(`No se encontr√≥ ning√∫n env√≠o de tipo "${targetCourier}" en tu selecci√≥n.`); return; }
                    showToast(`Exportando ${enviosSeleccionados.length} env√≠o(s) de tipo ${targetCourier}...`);
                    const headers = [ 'ID', 'Fecha Reg.', 'Cliente', 'Courier', 'Destinatario', 'Tel√©fono', 'DNI', 'Distrito', 'Direcci√≥n', 'Referencia', 'Agencia', 'Fecha Env√≠o', 'Estado' ];
                    const dataToExport = [headers];
                    enviosSeleccionados.forEach(envio => {
                        const row = [ envio.id, envio.fechaReg, envio.cliente, envio.courier, envio.nombre, envio.telefono, envio.DNI, envio.distrito, envio.direccion, envio.referencia, envio.agencia, envio.fechaEnvioDisplay, envio.estado ];
                        dataToExport.push(row);
                    });
                    try {
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.aoa_to_sheet(dataToExport);
                        XLSX.utils.book_append_sheet(wb, ws, 'Envios');
                        XLSX.writeFile(wb, filename); 
                    } catch (error) {
                        console.error("Error al generar el XLSX:", error);
                        showToast("Error al generar el archivo Excel.");
                    }
                });
            });

            btnAplicarFiltros.addEventListener('click', aplicarFiltros); // --- CAMBIO: Llama a aplicarFiltros local
            filtroCliente.addEventListener('keyup', (e) => { if(e.key === 'Enter') aplicarFiltros() });
            btnLimpiarFiltros.addEventListener('click', () => {
                filtroCliente.value = '';
                filtroFecha.value = '';
                filtroTipo.value = '';
                filtroDuplicados.checked = false;
                aplicarFiltros(); // --- CAMBIO: Llama a aplicarFiltros local
                showToast('Filtros limpiados.');
            });

            const businessNameInput = document.getElementById('businessName');
            const headerBusinessName = document.getElementById('headerBusinessName');
            const logoInput = document.getElementById('logoInput');
            const logoPreview = document.getElementById('logoPreview');
            const btnGuardarConfig = document.getElementById('btnGuardarConfig');
            const sidebarTitle = document.getElementById('sidebarTitle');
            const sidebarLogo = document.getElementById('sidebarLogo');
            const headerLogo = document.getElementById('headerLogo');

            function syncBusinessInfo() {
                // ... (l√≥gica de sync sin cambios) ...
                const name = localStorage.getItem('businessName') || 'Mi Tienda de Prueba';
                businessNameInput.value = name;
                headerBusinessName.textContent = name;
                sidebarTitle.textContent = name;     
                const logoSrc = localStorage.getItem('businessLogo');
                if (logoSrc) {
                    sidebarLogo.src = logoSrc; headerLogo.src = logoSrc; logoPreview.src = logoSrc;
                    sidebarLogo.classList.remove('hidden');
                    headerLogo.classList.remove('hidden');
                    logoPreview.classList.remove('hidden');
                } else {
                    sidebarLogo.classList.add('hidden');
                    headerLogo.classList.add('hidden');
                    logoPreview.classList.add('hidden');
                }
                const loginLogo = document.getElementById('loginLogo');
                const loginTitle = document.getElementById('loginTitle');
                const loginBusinessName = document.getElementById('loginBusinessName');
                loginBusinessName.textContent = name;
                if (logoSrc) { loginLogo.src = logoSrc; loginLogo.classList.remove('hidden'); } 
                else { loginLogo.classList.add('hidden'); }
            }
            
            logoInput.addEventListener('change', function() {
                // ... (l√≥gica sin cambios) ...
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => { localStorage.setItem('businessLogo', e.target.result); syncBusinessInfo(); };
                    reader.readAsDataURL(this.files[0]);
                }
            });
            btnGuardarConfig.addEventListener('click', () => {
                // ... (l√≥gica sin cambios) ...
                localStorage.setItem('businessName', businessNameInput.value);
                showToast('Cambios guardados con √©xito.');
                syncBusinessInfo();
            });
            goToAccountBtn.addEventListener('click', () => {
                // ... (l√≥gica sin cambios) ...
                document.querySelector('a.nav-link[href="#cuenta"]').click();
            });

            async function saveInlineChanges(buttonElement) {
                buttonElement.disabled = true;
                showToast('Guardando...');
                const row = buttonElement.closest('tr[data-id], div[data-id]');
                const id = row.dataset.id;
                const estadoSelect = row.querySelector('.inline-edit-estado');
                const fechaInput = row.querySelector('.inline-edit-fecha');
                const nuevoEstado = estadoSelect.value;
                let nuevaFecha = fechaInput.value;
                
                // --- REEMPLAZO LOCALSTORAGE ---
                const envioOriginal = todosLosEnvios.find(e => e.id === id); // 'todosLosEnvios' es local
                if (!envioOriginal) { showToast('Error: No se encontr√≥ el env√≠o original.'); buttonElement.disabled = false; return; }
                
                const datosParaActualizar = { estado: nuevoEstado, fechaEnvio: envioOriginal.fechaEnvioInput };
                if (nuevoEstado === 'REPROGRAMADO') {
                    if (!nuevaFecha) { showToast('Selecciona una fecha para reprogramar.'); buttonElement.disabled = false; return; }
                    datosParaActualizar.fechaEnvio = nuevaFecha;
                }
                
                try {
                    // const docRef = doc(enviosCollectionRef, id); // ELIMINADO
                    // await updateDoc(docRef, datosParaActualizar); // ELIMINADO
                    
                    let envios = getEnvios();
                    const index = envios.findIndex(e => e.id === id);
                    if (index !== -1) {
                        // Aplicar los cambios al env√≠o
                        envios[index] = { ...envios[index], ...datosParaActualizar };
                        saveEnvios(envios);
                        showToast('Env√≠o actualizado.');
                        ejecutarConsultaEnvios(); // Recargar la vista
                    } else {
                        showToast('Error: No se encontr√≥ el env√≠o para actualizar.');
                    }
                } catch (error) {
                    console.error('Error updating shipment local:', error);
                    showToast(`Error al guardar: ${error.message}`);
                    buttonElement.disabled = false;
                }
                // --- FIN REEMPLAZO ---
            }

            document.getElementById('envios').addEventListener('change', (e) => {
                // ... (l√≥gica de detecci√≥n de cambios inline sin cambios) ...
                if (e.target.classList.contains('inline-edit-estado')) {
                    const selectEstado = e.target;
                    const container = selectEstado.closest('.inline-edit-container');
                    const fechaInput = container.querySelector('.inline-edit-fecha');
                    const saveBtn = container.querySelector('.inline-save-btn');
                    const originalEstado = selectEstado.dataset.originalEstado;
                    const nuevoEstado = selectEstado.value;
                    if (nuevoEstado === 'ELIMINAR') {
                        const row = selectEstado.closest('tr[data-id], div[data-id]');
                        const id = row.dataset.id;
                        abrirModalConfirmacion([id]);
                        selectEstado.value = originalEstado;
                        return;
                    }
                    const esReprogramado = nuevoEstado === 'REPROGRAMADO';
                    fechaInput.classList.toggle('oculto', !esReprogramado);
                    const estadoCambiado = nuevoEstado !== originalEstado;
                    const fechaCambiada = esReprogramado && (fechaInput.value !== fechaInput.dataset.originalFecha); 
                    saveBtn.classList.toggle('oculto', !(estadoCambiado || fechaCambiada));
                } 
                else if (e.target.classList.contains('inline-edit-fecha')) {
                    const fechaInput = e.target;
                    const container = fechaInput.closest('.inline-edit-container');
                    const saveBtn = container.querySelector('.inline-save-btn');
                    const selectEstado = container.querySelector('.inline-edit-estado');
                    const fechaCambiada = fechaInput.value !== fechaInput.dataset.originalFecha;
                    const estadoCambiado = selectEstado.value !== selectEstado.dataset.originalEstado;
                     saveBtn.classList.toggle('oculto', !(fechaCambiada || estadoCambiado));
                }
            });

            document.getElementById('envios').addEventListener('click', (e) => {
                 // ... (l√≥gica de click en botones (save, notify, edit) sin cambios) ...
                 const button = e.target.closest('.inline-save-btn');
                 if (button) { e.preventDefault(); saveInlineChanges(button); }
                const notifyButton = e.target.closest('.btn-notify');
                if (notifyButton) { e.preventDefault(); handleNotifyClick(notifyButton.dataset.id); }
                const editButton = e.target.closest('.btn-edit-full');
                if (editButton) {
                    e.preventDefault();
                    const envioId = editButton.dataset.id;
                    const envio = todosLosEnvios.find(e => e.id === envioId);
                    if (envio) { abrirModalEdicion(envio); } 
                    else { showToast('Error: No se encontr√≥ el env√≠o para editar.'); }
                }
            });

            const deleteModal = document.getElementById('deleteModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const modalMessage = document.getElementById('modalMessage');
            let idsParaEliminar = [];

            const editModal = document.getElementById('editModal');
            const editForm = document.getElementById('editForm');
            const confirmEditBtn = document.getElementById('confirmEditBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const editActualizarPerfil = document.getElementById('editActualizarPerfil');
            const editEnvioId = document.getElementById('editEnvioId');
            const editCliente = document.getElementById('editCliente');
            const editNombre = document.getElementById('editNombre');
            const editTelefono = document.getElementById('editTelefono');
            const editDNI = document.getElementById('editDNI');
            const editCourier = document.getElementById('editCourier');
            const editDistrito = document.getElementById('editDistrito');
            const editDireccion = document.getElementById('editDireccion');
            const editReferencia = document.getElementById('editReferencia');
            const editAgencia = document.getElementById('editAgencia');

            function abrirModalEdicion(envio) {
                // ... (l√≥gica sin cambios) ...
                editEnvioId.value = envio.id; editCliente.value = envio.cliente || '';
                editNombre.value = envio.nombre || ''; editTelefono.value = envio.telefono || '';
                editDNI.value = envio.DNI || ''; editCourier.value = envio.courier || 'DELIVERY';
                editDistrito.value = envio.distrito || ''; editDireccion.value = envio.direccion || '';
                editReferencia.value = envio.referencia || ''; editAgencia.value = envio.agencia || '';
                editModal.classList.remove('hidden');
            }
            function cerrarModalEdicion() {
                // ... (l√≥gica sin cambios) ...
                editModal.classList.add('hidden');
                editForm.reset();
                editActualizarPerfil.checked = false;
            }
            async function guardarCambiosEdicion(e) {
                e.preventDefault();
                const id = editEnvioId.value;
                const clienteId = editCliente.value;
                if (!id || !clienteId) { showToast('Error: ID de env√≠o o Cliente no encontrado.'); return; }
                const updatesEnvio = {
                    nombre: editNombre.value, telefono: editTelefono.value, DNI: editDNI.value,
                    distrito: editDistrito.value, direccion: editDireccion.value,
                    referencia: editReferencia.value, agencia: editAgencia.value
                };
                showToast('Guardando cambios...');
                try {
                    // --- INICIO: REEMPLAZO LOCALSTORAGE ---
                    // const docRefEnvio = doc(enviosCollectionRef, id); // ELIMINADO
                    // await updateDoc(docRefEnvio, updatesEnvio); // ELIMINADO
                    
                    let envios = getEnvios();
                    const indexEnvio = envios.findIndex(e => e.id === id);
                    if (indexEnvio === -1) throw new Error("No se encontr√≥ el env√≠o local");
                    
                    // Actualizar el env√≠o
                    envios[indexEnvio] = { ...envios[indexEnvio], ...updatesEnvio };
                    saveEnvios(envios);

                    if (editActualizarPerfil.checked) {
                        const updatesPerfil = {
                            nombre: editNombre.value, telefono: editTelefono.value, DNI: editDNI.value,
                            distrito: editDistrito.value, direccion: editDireccion.value,
                            referencia: editReferencia.value, agencia: editAgencia.value
                        };
                        // const docRefCliente = doc(db, 'clientes', clienteId); // ELIMINADO
                        // await setDoc(docRefCliente, updatesPerfil, { merge: true }); // ELIMINADO
                        
                        let clientes = getClientes();
                        clientes[clienteId] = { ...clientes[clienteId], ...updatesPerfil };
                        saveClientes(clientes);
                        
                        showToast('Env√≠o y Perfil actualizados.');
                    } else {
                        showToast('Env√≠o actualizado con √©xito.');
                    }
                    
                    ejecutarConsultaEnvios(); // Recargar la vista
                    cerrarModalEdicion();
                    // --- FIN: REEMPLAZO LOCALSTORAGE ---
                } catch (error) {
                    console.error("Error al actualizar el env√≠o (local):", error);
                    showToast("Error al guardar los cambios.");
                }
            }
            cancelEditBtn.addEventListener('click', cerrarModalEdicion);
            editForm.addEventListener('submit', guardarCambiosEdicion);

            function abrirModalConfirmacion(ids) {
                // ... (l√≥gica sin cambios) ...
                idsParaEliminar = ids;
                modalMessage.textContent = `¬øEst√°s seguro de que quieres eliminar ${ids.length} env√≠o(s) seleccionados? Esta acci√≥n no se puede deshacer.`;
                deleteModal.classList.remove('hidden');
            }
            function cerrarModalConfirmacion() {
                // ... (l√≥gica sin cambios) ...
                deleteModal.classList.add('hidden');
                idsParaEliminar = [];
            }
            confirmDeleteBtn.addEventListener('click', async () => {
                const eliminadosCount = idsParaEliminar.length;
                if (eliminadosCount === 0) return;
                showToast('Eliminando env√≠os...');
                try {
                    // --- INICIO: REEMPLAZO LOCALSTORAGE ---
                    // const batch = writeBatch(db); // ELIMINADO
                    let envios = getEnvios();
                    let actualizados = 0;
                    
                    // Aplicamos "soft delete" (marcar como ELIMINADO)
                    envios.forEach(envio => {
                        if (idsParaEliminar.includes(envio.id)) {
                            envio.estado = 'ELIMINADO';
                            actualizados++;
                        }
                    });
                    
                    saveEnvios(envios);
                    // await batch.commit(); // ELIMINADO
                    
                    cerrarModalConfirmacion();
                    showToast(`${actualizados} env√≠o(s) eliminados correctamente.`);
                    ejecutarConsultaEnvios(); // Recargar la vista
                    // --- FIN: REEMPLAZO LOCALSTORAGE ---
                } catch (error) {
                    console.error('Error deleting shipments (local):', error);
                    showToast('Error al eliminar los env√≠os.');
                } finally {
                    accionLote.value = '';
                }
            });
            cancelDeleteBtn.addEventListener('click', cerrarModalConfirmacion);

            const toast = document.getElementById('toast');
            let toastTimeout;
            function showToast(msg){
                // ... (l√≥gica sin cambios) ...
                clearTimeout(toastTimeout);
                toast.textContent = msg;
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
                toastTimeout = setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-2');
                }, 2500);
            }

            // --- Conectar botones de login/logout (dashboard) ---
            loginForm.addEventListener('submit', handleLogin);
            document.querySelector('#logoutButton-sidebar').addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });
            
            // Carga inicial de info de negocio (dashboard)
            syncBusinessInfo(); 

            // --- ELIMINADA LA INICIALIZACI√ìN DE FIREBASE Y AUTH LISTENER DE AQU√ç ---
            
        } // --- FIN DE initDashboardLogic ---


        // =================================================================
        // --- INICIALIZADOR PRINCIPAL ---
        // =================================================================
        
        // --- NUEVA VARIABLE DE ESTADO DE LOGIN ---
        let isLoggedIn = false; 

        document.addEventListener('DOMContentLoaded', async () => {
            
            // --- ELIMINADA LA INICIALIZACI√ìN DE FIREBASE ---
            // const { ... } = window.firebase;
            // let app, db, auth;
            // try { ... } catch(e) { ... }
            // const sdk = { ... };

            // 3. Inicializar la l√≥gica de cada "p√°gina" (SIN SDK)
            initPortalLogic();
            initFormLogic();
            initDashboardLogic(); 
            
            // --- LISTENER DE AUTH ELIMINADO ---
            // setupAuthListener()

            // 4. Configurar la navegaci√≥n principal (REEMPLAZADO)
            // --- ELIMINAR EL ANTIGUO LISTENER ---
            // document.body.addEventListener('click', (e) => { ... });

            // --- INICIO: CORRECCI√ìN DEL MANEJADOR DE NAVEGACI√ìN GLOBAL ---
            document.body.addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link, .nav-back');
                
                if (navLink) {
                    e.preventDefault();
                    
                    const pageId = navLink.dataset.page; // Para cambiar de P√ÅGINA (ej: "page-form")
                    const sectionHref = navLink.getAttribute('href'); // Para cambiar de SECCI√ìN (ej: "#envios")

                    // --- L√ìGICA CORREGIDA ---
                    
                    // 1. SIEMPRE priorizar si el enlace tiene 'data-page'
                    if (pageId) {
                        // Es un enlace de cambio de P√ÅGINA (Portal -> Form, Form -> Portal, etc.)
                        showPage(pageId);
                        
                        // Si volvemos al portal, reseteamos las clases activas del sidebar
                        if (pageId === 'page-portal') {
                            const dashboardNavLinks = document.querySelectorAll('#page-dashboard .nav-link');
                            dashboardNavLinks.forEach(l => {
                                l.classList.remove('bg-sidebar-active-bg', 'text-white');
                                l.classList.add('text-gray-300', 'hover:bg-sidebar-hover', 'hover:text-white');
                            });
                            // Reactivar "Env√≠os" por defecto para la pr√≥xima vez
                            const enviosLink = document.querySelector('#page-dashboard a[href="#envios"]');
                            if(enviosLink) {
                                enviosLink.classList.add('bg-sidebar-active-bg', 'text-white');
                                enviosLink.classList.remove('text-gray-300', 'hover:bg-sidebar-hover', 'hover:text-white');
                            }
                        }
                    
                    // 2. SI NO tiene 'data-page', Y es un enlace de secci√≥n (href NO es solo "#")
                    } else if (sectionHref && sectionHref.startsWith('#') && sectionHref.length > 1) {
                        // Es un enlace de cambio de SECCI√ìN (Dentro del Dashboard: #envios, #link, etc.)
                        const targetId = sectionHref.substring(1);
                        const targetSection = document.getElementById(targetId);
                        
                        if (targetSection) {
                            // Actualizar T√≠tulo
                            const newTitle = navLink.querySelector('span')?.textContent;
                            if(newTitle) document.getElementById('headerTitle').textContent = newTitle;
                            
                            // Controlar Scroll
                            if (targetId === 'cuenta') { document.body.classList.add('scroll-enabled'); } 
                            else { document.body.classList.remove('scroll-enabled'); }

                            // Actualizar clases de links
                            const dashboardNavLinks = document.querySelectorAll('#page-dashboard .nav-link');
                            dashboardNavLinks.forEach(l => {
                                l.classList.remove('bg-sidebar-active-bg', 'text-white');
                                l.classList.add('text-gray-300', 'hover:bg-sidebar-hover', 'hover:text-white');
                            });
                            navLink.classList.add('bg-sidebar-active-bg', 'text-white');
                            navLink.classList.remove('text-gray-300', 'hover:bg-sidebar-hover', 'hover:text-white');
                            
                            // Mostrar secci√≥n
                            document.querySelectorAll('#page-dashboard main > section').forEach(sec => sec.classList.remove('active'));
                            targetSection.classList.add('active');
                            
                            // Cerrar sidebar en m√≥vil
                            document.getElementById('sidebar').classList.add('-translate-x-full');
                            document.getElementById('sidebarOverlay').classList.add('hidden');
                        }
                    }
                    // Si un enlace es solo href="#" y no tiene data-page, no se hace nada (como deber√≠a ser).
                    // --- FIN L√ìGICA CORREGIDA ---
                }
            });
            // --- FIN: NUEVO MANEJADOR DE NAVEGACI√ìN GLOBAL ---


            // 5. Inicializar Feather Icons (globalmente)
            feather.replace();
            
            // 6. Mostrar la p√°gina de inicio (portal) por defecto
            // (La l√≥gica de `showPage` se encarga de ocultar el login/dashboard)
            showPage('page-portal');
        });

    </script>

</body>
</html>
