<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Tiendas</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (para el √≠cono del bot√≥n flotante, llama y check) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Estilo para el bot√≥n flotante */
        #addButton {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        #addButton:hover {
            transform: scale(1.05);
        }
        /* Estilos del Modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        /* Estilo para la tarjeta de tienda */
        .store-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .store-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 4px, 6px, 0.1);
        }
    </style>
</head>
<body>

    <!-- Contenedor Principal -->
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-6 text-center">
            Buscador de Tiendas üîé
        </h1>
        <p class="text-sm text-gray-500 mb-8 text-center">
            Muestra tiendas de Gamarra, filtradas por galer√≠a y ordenadas por **Nivel de Fuego** (Recomendaciones).
            <span id="userIdDisplay" class="block mt-2 text-xs text-blue-600"></span>
        </p>

        <!-- Filtros y B√∫squeda -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <input type="text" id="searchInput" placeholder="Buscar por nombre o descripci√≥n..."
                   class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <select id="galleryFilter"
                    class="p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150 sm:w-1/3">
                <option value="all">Todas las galer√≠as</option>
            </select>
        </div>

        <!-- Contenedor de Tiendas -->
        <div id="storesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <p id="loadingMessage" class="text-center text-gray-500 col-span-full">Cargando tiendas...</p>
        </div>
    </div>

    <!-- Bot√≥n Flotante para Agregar Tienda -->
    <button id="addButton" onclick="showAddStoreModal()"
            class="w-14 h-14 rounded-full bg-blue-600 text-white flex items-center justify-center text-2xl font-bold hover:bg-blue-700 transition duration-150">
        <i data-lucide="plus" class="w-6 h-6"></i>
    </button>

    <!-- MODAL 1: Agregar Tienda -->
    <div id="addStoreModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-y-auto max-h-[90vh]">
            <!-- Encabezado del Modal -->
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Registrar Nueva Tienda</h2>
                <button onclick="hideAddStoreModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Formulario -->
            <form id="storeForm" class="p-6 space-y-4">
                <div>
                    <label for="storeName" class="block text-sm font-medium text-gray-700">Nombre de la Tienda (ID)</label>
                    <input type="text" id="storeName" required placeholder="Ej: Moda Joven S.A.C."
                           class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="gallerySelectInput" class="block text-sm font-medium text-gray-700">Galer√≠a</label>
                    <select id="gallerySelectInput" required 
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>Cargando galer√≠as...</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="floor" class="block text-sm font-medium text-gray-700">Piso</label>
                        <input type="text" id="floor" required placeholder="Ej: 3"
                               class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="stand" class="block text-sm font-medium text-gray-700">Stand/N√∫mero</label>
                        <input type="text" id="stand" required placeholder="Ej: 305"
                               class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                 <div>
                    <label for="imageUrl" class="block text-sm font-medium text-gray-700">URL de Imagen (Opcional)</label>
                    <input type="url" id="imageUrl" placeholder="https://placehold.co/400x200/505050/ffffff?text=Tienda"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="tiktok" class="block text-sm font-medium text-gray-700">Enlace de TikTok</label>
                    <input type="url" id="tiktok" placeholder="https://tiktok.com/@mitienda"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Descripci√≥n Libre</label>
                    <textarea id="description" rows="3" required placeholder="Breve descripci√≥n del tipo de producto o especialidad."
                              class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <!-- Mensaje de Error (oculto por defecto) -->
                <div id="formMessage" class="hidden p-3 text-sm rounded-lg" role="alert"></div>

                <!-- Bot√≥n de Env√≠o -->
                <button type="submit" id="saveButton"
                        class="w-full py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                    Guardar Tienda
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL 2: Verificaciones -->
    <div id="reviewsModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-y-auto max-h-[90vh]">
            <!-- Encabezado del Modal -->
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Verificaciones de <span id="reviewStoreName" class="text-blue-600"></span></h2>
                <button onclick="hideReviewsModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Contenido del Modal de Verificaciones -->
            <div class="p-6">
                <!-- Formulario para A√±adir Verificaci√≥n -->
                <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">A√±ade tu Verificaci√≥n de Compra</h3>
                    <form id="reviewForm" class="space-y-3">
                        <textarea id="reviewText" rows="3" required placeholder="Confirma la ubicaci√≥n, la calidad de los productos o el buen trato. S√© constructivo."
                                  class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                        
                        <!-- Mensaje de Error/√âxito para Verificaciones -->
                        <div id="reviewFormMessage" class="hidden p-3 text-sm rounded-lg" role="alert"></div>

                        <button type="submit" id="saveReviewButton"
                                class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                            Publicar Verificaci√≥n ‚úÖ
                        </button>
                    </form>
                </div>

                <!-- Lista de Verificaciones -->
                <h3 class="text-lg font-semibold mb-3 text-gray-700 border-b pb-2">Verificaciones de Compradores (<span id="reviewCount">0</span>)</h3>
                <div id="reviewsContainer" class="space-y-4">
                    <p id="noReviewsMessage" class="text-center text-gray-500">No hay verificaciones todav√≠a. ¬°S√© el primero!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, increment, getDoc, deleteDoc, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log a Debug para ver actividad de Firestore
        setLogLevel('Debug');

        // =================================================================
        // CONFIGURACI√ìN DE DATOS EST√ÅTICOS Y FIREBASE
        // =================================================================

        // LISTA EST√ÅTICA DE GALER√çAS
        const STATIC_GALLERIES = [
            "El Rey",
            "La Rotonda",
            "Cyber Plaza",
            "Galer√≠a Gamarra Moda"
        ];

        // Variables Globales (Aseg√∫rate de reemplazar __app_id, __firebase_config y __initial_auth_token por tus valores de producci√≥n)
        const firebaseConfig = { 
            apiKey: "AIzaSyAomajVOrWE-d8p9_bfk5lHYPY4JRFutIw",
            authDomain: "tiendasapp-233e5.firebaseapp.com",
            projectId: "tiendasapp-233e5",
            storageBucket: "tiendasapp-233e5.firebasestorage.app",
            messagingSenderId: "747918968733",
            appId: "1:747918968733:web:dc3085a8b0b09c2d46d174",
            measurementId: "G-2YG39F0V53"
        }; 
        // Usamos el projectId como appId para la ruta de la colecci√≥n p√∫blica (artifact/{appId}/...)
        const appId = 'tiendasapp-233e5'; 
        
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;
        
        // Estado para el Modal de Verificaciones
        let currentReviewStoreId = null;

        // Referencias del DOM
        const storesContainer = document.getElementById('storesContainer');
        const galleryFilter = document.getElementById('galleryFilter');
        const searchInput = document.getElementById('searchInput');
        const loadingMessage = document.getElementById('loadingMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        
        // Formulario Agregar Tienda
        const storeForm = document.getElementById('storeForm');
        const gallerySelectInput = document.getElementById('gallerySelectInput');
        const formMessage = document.getElementById('formMessage');

        // Modal de Verificaciones
        const reviewsModal = document.getElementById('reviewsModal');
        const reviewStoreName = document.getElementById('reviewStoreName');
        const reviewForm = document.getElementById('reviewForm');
        const reviewTextarea = document.getElementById('reviewText');
        const reviewsContainer = document.getElementById('reviewsContainer');
        const noReviewsMessage = document.getElementById('noReviewsMessage');
        const reviewFormMessage = document.getElementById('reviewFormMessage');
        const reviewCount = document.getElementById('reviewCount');


        // Estado local para las recomendaciones del usuario
        let userRecommendations = new Set(); // Almacena IDs de tiendas recomendadas
        let unsubscribeReviews = null; // Para detener el escuchador de verificaciones cuando se cierra el modal
        
        // =================================================================
        // 1. INICIALIZACI√ìN Y AUTENTICACI√ìN
        // =================================================================

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loadingMessage.textContent = "Error al conectar con la base de datos.";
            }
        } else {
             loadingMessage.textContent = "¬°ATENCI√ìN! Configuraci√≥n de Firebase faltante. Revisa el script.";
             console.error("Configuraci√≥n de Firebase no disponible.");
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = `Tu ID de usuario (necesario para recomendaciones/verificaciones): ${currentUserId}`;
            } else {
                try {
                     await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error al autenticar an√≥nimamente:", error);
                }
            }
            isAuthReady = true;
            if (db) {
                // Ejecutar la siembra de datos de prueba (se ejecuta solo una vez)
                await seedDatabase(); 
                setupRealtimeListeners();
            }
        });


        // =================================================================
        // 2. L√ìGICA DE FIRESTORE (LECTURA y ESCRITURA)
        // =================================================================

        // Define la ruta de la colecci√≥n de tiendas
        function getStoresCollectionRef() {
            // Ruta para datos p√∫blicos: /artifacts/{appId}/public/data/tiendas
            return collection(db, `artifacts/${appId}/public/data/tiendas`);
        }
        
        // Define la ruta de la colecci√≥n de recomendaciones del usuario actual
        function getRecommendationsCollectionRef() {
            if (!currentUserId) return null;
            // Ruta privada del usuario: /artifacts/{appId}/users/{userId}/recommendations
            return collection(db, `artifacts/${appId}/users/${currentUserId}/recommendations`);
        }

        // Define la ruta de la subcolecci√≥n de verificaciones para una tienda espec√≠fica
        function getVerificationsCollectionRef(storeId) {
            return collection(db, `artifacts/${appId}/public/data/tiendas/${storeId}/verifications`);
        }

        // --- SIEMBRA DE DATOS DE PRUEBA ---
        async function seedDatabase() {
            const storesColRef = getStoresCollectionRef();
            const checkDocRef = doc(storesColRef, "ModaTrendy"); // Usar una tienda como marcador

            try {
                // Verificar si ya existe la tienda "ModaTrendy" para evitar duplicaci√≥n
                const checkDoc = await getDoc(checkDocRef);
                if (checkDoc.exists()) {
                    console.log("Datos de prueba ya existen. Omitiendo siembra.");
                    return;
                }
                
                console.log("Sembrando datos de prueba...");
                
                const initialStores = [
                    {
                        id: "ModaTrendy",
                        'nombre de la tienda': "Moda Trendy",
                        galer√≠a: "El Rey", 
                        piso: "2",
                        stand: "215",
                        'descripci√≥n libre': "Especialistas en ropa urbana y juvenil.",
                        tiktok: "https://tiktok.com/@modatrendy",
                        imageUrl: "https://placehold.co/400x200/2563eb/ffffff?text=Moda+Trendy", 
                        recommendations: 15, // CAMBIADO de likes a recommendations
                        verificationCount: 3, // CAMBIADO de reviewCount a verificationCount
                        createdAt: new Date().toISOString(),
                        creatorId: 'system-seed'
                    },
                    {
                        id: "TextilSofia",
                        'nombre de la tienda': "Textil Sof√≠a",
                        galer√≠a: "La Rotonda", 
                        piso: "5",
                        stand: "501",
                        'descripci√≥n libre': "Venta de telas por mayor, variedad de colores y dise√±os.",
                        tiktok: "https://tiktok.com/@textilsofia",
                        imageUrl: "https://placehold.co/400x200/059669/ffffff?text=Textil+Sofia", 
                        recommendations: 8,
                        verificationCount: 0, 
                        createdAt: new Date().toISOString(),
                        creatorId: 'system-seed'
                    },
                    {
                        id: "AccesoriosCool",
                        'nombre de la tienda': "Accesorios Cool",
                        galer√≠a: "Cyber Plaza", 
                        piso: "1",
                        stand: "103",
                        'descripci√≥n libre': "Joyas de fantas√≠a, lentes y gorras de moda.",
                        tiktok: "https://tiktok.com/@accesorioscool",
                        imageUrl: "https://placehold.co/400x200/9d174d/ffffff?text=Accesorios+Cool", 
                        recommendations: 22,
                        verificationCount: 1, 
                        createdAt: new Date().toISOString(),
                        creatorId: 'system-seed'
                    },
                ];

                for (const store of initialStores) {
                    await setDoc(doc(storesColRef, store.id), store); 
                }

                console.log("¬°Siembra de datos completada!");

            } catch (error) {
                console.error("Error al sembrar datos de prueba:", error);
            }
        }
        
        // --- INICIAR ESCUCHADORES EN TIEMPO REAL ---
        function setupRealtimeListeners() {
            // 1. Escuchar la lista de tiendas
            setupStoreListener();
            // 2. Escuchar las recomendaciones del usuario (si est√° autenticado)
            if (currentUserId) {
                setupRecommendationsListener();
            }
            // 3. Poblar galer√≠as EST√ÅTICAS
            populateGalleryFilter(STATIC_GALLERIES); 
            populateGallerySelectInput(STATIC_GALLERIES);
        }
        
        // --- ESCUCHADOR DE TIENDAS ---
        function setupStoreListener() {
            const storesColRef = getStoresCollectionRef();
            const q = query(storesColRef);

            onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden');
                const stores = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const storeData = {
                        id: doc.id,
                        recommendations: data.recommendations || 0, // Nuevo campo
                        verificationCount: data.verificationCount || 0, // Nuevo campo
                        ...data
                    };
                    stores.push(storeData);
                });

                // Ordenar por el nuevo campo: recommendations
                stores.sort((a, b) => b.recommendations - a.recommendations); 
                
                // Pasa el estado actual de todas las tiendas y las recomendaciones del usuario
                displayStores(stores, userRecommendations); 

                galleryFilter.onchange = () => displayStores(stores, userRecommendations);
                searchInput.oninput = () => displayStores(stores, userRecommendations);
            }, (error) => {
                console.error("Error en onSnapshot (Tiendas): ", error);
                loadingMessage.textContent = "Error al cargar los datos en tiempo real.";
            });
        }
        
        // --- ESCUCHADOR DE RECOMENDACIONES DEL USUARIO ---
        function setupRecommendationsListener() {
            const recommendationsColRef = getRecommendationsCollectionRef();
            if (!recommendationsColRef) return;
            
            onSnapshot(recommendationsColRef, (snapshot) => {
                userRecommendations.clear(); // Limpia el set
                snapshot.forEach(doc => {
                    userRecommendations.add(doc.id); // Agrega el ID de la tienda que el usuario recomienda
                });
            }, (error) => {
                console.error("Error en onSnapshot (Recomendaciones): ", error);
            });
        }

        // --- ESCRITURA (Recomendaciones - üî• Fuego) ---
        window.recommendStore = async function(storeId) {
            if (!currentUserId) {
                alertUser("Necesitas estar autenticado para dar o quitar una Recomendaci√≥n (Fuego).");
                return;
            }

            const recommendationDocRef = doc(getRecommendationsCollectionRef(), storeId);
            const storeDocRef = doc(getStoresCollectionRef(), storeId);

            try {
                const recommendationDoc = await getDoc(recommendationDocRef);

                if (recommendationDoc.exists()) {
                    // Ya recomend√≥: Quitar recomendaci√≥n
                    await deleteRecommendation(recommendationDocRef, storeDocRef);
                } else {
                    // No ha recomendado: A√±adir recomendaci√≥n
                    await addRecommendation(recommendationDocRef, storeDocRef);
                }
            } catch (error) {
                console.error("Error al gestionar la recomendaci√≥n:", error);
                alertUser("Error de conexi√≥n al dar o quitar la Recomendaci√≥n.");
            }
        };

        async function addRecommendation(recommendationDocRef, storeDocRef) {
            await setDoc(recommendationDocRef, { recommendedAt: new Date().toISOString() });
            await updateDoc(storeDocRef, {
                recommendations: increment(1) // Incrementa el contador principal
            });
        }

        async function deleteRecommendation(recommendationDocRef, storeDocRef) {
            await deleteDoc(recommendationDocRef);
            
            const storeSnapshot = await getDoc(storeDocRef);
            if (storeSnapshot.exists() && storeSnapshot.data().recommendations > 0) {
                 await updateDoc(storeDocRef, {
                    recommendations: increment(-1)
                });
            }
        }
        
        // --- ESCRITURA (A√±adir Tienda) ---
        window.addStore = async function(e) {
            e.preventDefault();
            displayFormMessage('', 'hide', formMessage);
            
            const storeName = document.getElementById('storeName').value.trim();
            const selectedGallery = document.getElementById('gallerySelectInput').value.trim(); 
            
            if (!storeName || !selectedGallery) {
                displayFormMessage("El nombre y la galer√≠a son obligatorios.", 'error', formMessage);
                return;
            }
            
            const documentId = storeName; 

            const newStoreData = {
                id: documentId,
                'nombre de la tienda': storeName,
                galer√≠a: selectedGallery, 
                piso: document.getElementById('floor').value.trim(),
                stand: document.getElementById('stand').value.trim(),
                'descripci√≥n libre': document.getElementById('description').value.trim(),
                tiktok: document.getElementById('tiktok').value.trim(),
                imageUrl: document.getElementById('imageUrl').value.trim() || 'https://placehold.co/400x200/505050/ffffff?text=Tienda', 
                recommendations: 0, // Nuevo campo
                verificationCount: 0, // Nuevo campo
                createdAt: new Date().toISOString(),
                creatorId: currentUserId
            };
            
            const storeDocRef = doc(getStoresCollectionRef(), documentId);

            try {
                const existingDoc = await getDoc(storeDocRef);
                if (existingDoc.exists()) {
                    displayFormMessage(`Ya existe una tienda con el nombre "${storeName}". Usa un nombre √∫nico.`, 'error', formMessage);
                    return;
                }

                await setDoc(storeDocRef, newStoreData);

                displayFormMessage("¬°Tienda registrada con √©xito!", 'success', formMessage);
                storeForm.reset();
                setTimeout(hideAddStoreModal, 1500); 
            } catch (error) {
                console.error("Error al a√±adir la tienda:", error);
                displayFormMessage("Error al guardar la tienda. Verifica la consola.", 'error', formMessage);
            }
        }
        
        // Asignar la funci√≥n de env√≠o al formulario
        storeForm.addEventListener('submit', window.addStore);

        // --- ESCRITURA (A√±adir Verificaci√≥n - ‚úÖ Check) ---
        window.addVerification = async function(e) {
            e.preventDefault();
            displayFormMessage('', 'hide', reviewFormMessage);
            
            if (!currentReviewStoreId) return; // Debe haber una tienda seleccionada

            const verificationText = reviewTextarea.value.trim();

            if (!verificationText) {
                displayFormMessage("La verificaci√≥n no puede estar vac√≠a.", 'error', reviewFormMessage);
                return;
            }
            if (!currentUserId) {
                displayFormMessage("Debes estar autenticado para dejar una verificaci√≥n.", 'error', reviewFormMessage);
                return;
            }

            const newVerification = {
                text: verificationText,
                creatorId: currentUserId,
                createdAt: serverTimestamp() // Usa serverTimestamp para la hora del servidor
            };

            try {
                // 1. Guarda la verificaci√≥n en la subcolecci√≥n
                await addDoc(getVerificationsCollectionRef(currentReviewStoreId), newVerification);
                
                // 2. Incrementa el contador de verificaciones en el documento principal de la tienda
                const storeDocRef = doc(getStoresCollectionRef(), currentReviewStoreId);
                await updateDoc(storeDocRef, {
                    verificationCount: increment(1)
                });

                displayFormMessage("¬°Verificaci√≥n publicada con √©xito!", 'success', reviewFormMessage);
                reviewTextarea.value = ''; // Limpiar textarea
            } catch (error) {
                console.error("Error al a√±adir la verificaci√≥n:", error);
                displayFormMessage("Error al publicar la verificaci√≥n. Verifica la consola.", 'error', reviewFormMessage);
            }
        }
        
        // Asignar la funci√≥n de env√≠o al formulario de verificaciones
        reviewForm.addEventListener('submit', window.addVerification);


        // --- ESCUCHADOR DE VERIFICACIONES (Se inicia al abrir el modal) ---
        function setupVerificationsListener(storeId) {
            // Detener el escuchador anterior si existe
            if (unsubscribeReviews) {
                unsubscribeReviews();
            }

            const reviewsColRef = getVerificationsCollectionRef(storeId);
            // Ordena por fecha de creaci√≥n descendente
            const q = query(reviewsColRef); 
            
            unsubscribeReviews = onSnapshot(q, (snapshot) => {
                const verifications = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let dateString = 'Pendiente...';
                    // Convertir el timestamp de Firestore a una cadena legible
                    if (data.createdAt && typeof data.createdAt.toDate === 'function') {
                        dateString = data.createdAt.toDate().toLocaleString();
                    } else if (data.createdAt) {
                        dateString = new Date(data.createdAt).toLocaleString();
                    }
                    
                    verifications.push({
                        id: doc.id,
                        ...data,
                        createdAt: dateString
                    });
                });
                
                // Ordenar en el cliente (por si la query no usa 'orderBy')
                verifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                displayVerifications(verifications);
            }, (error) => {
                console.error("Error en onSnapshot (Verificaciones): ", error);
            });
        }


        // =================================================================
        // 3. FUNCIONES DE UI Y L√ìGICA DE FILTRADO
        // =================================================================

        // Llena el SELECT del FILTRO Galer√≠a
        function populateGalleryFilter(galleryNames) {
            galleryFilter.innerHTML = '<option value="all">Todas las galer√≠as</option>';
            const sortedGalleries = Array.from(galleryNames).sort();
            sortedGalleries.forEach(gallery => {
                const option = document.createElement('option');
                option.value = gallery;
                option.textContent = gallery;
                galleryFilter.appendChild(option);
            });
        }

        // Llena el SELECT del FORMULARIO Galer√≠a
        function populateGallerySelectInput(galleryNames) {
            gallerySelectInput.innerHTML = '<option value="" disabled selected>Selecciona una galer√≠a</option>';
            
            galleryNames.sort().forEach(galleryName => {
                const option = document.createElement('option');
                option.value = galleryName; 
                option.textContent = galleryName;
                gallerySelectInput.appendChild(option);
            });
             if (galleryNames.length === 0) {
                 gallerySelectInput.innerHTML = '<option value="" disabled selected>No hay galer√≠as configuradas</option>';
            }
        }

        // Renderiza la lista de tiendas
        function displayStores(stores, recommendationsSet) {
            const selectedGallery = galleryFilter.value;
            const searchTerm = searchInput.value.toLowerCase().trim();
            storesContainer.innerHTML = '';

            const filteredStores = stores.filter(store => {
                const galleryMatch = selectedGallery === 'all' || store.galer√≠a === selectedGallery;

                const searchMatch = store['nombre de la tienda'].toLowerCase().includes(searchTerm) ||
                                    (store['descripci√≥n libre'] && store['descripci√≥n libre'].toLowerCase().includes(searchTerm));

                return galleryMatch && searchMatch;
            });

            if (filteredStores.length === 0) {
                storesContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">
                                                No se encontraron tiendas que coincidan con los filtros.
                                            </p>`;
                return;
            }

            // Renderizar tarjetas de tiendas
            filteredStores.forEach(store => {
                const isRecommended = recommendationsSet.has(store.id);
                // Color para el √≠cono de llama (Fire)
                const fireClass = isRecommended ? 'fill-orange-500' : 'stroke-orange-500';
                
                const card = document.createElement('div');
                card.className = 'store-card bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg';
                
                const imageHtml = store.imageUrl ? 
                    `<img src="${store.imageUrl}" alt="Imagen de ${store['nombre de la tienda']}" 
                          class="w-full h-32 object-cover rounded-lg mb-4"
                          onerror="this.onerror=null;this.src='https://placehold.co/400x200/505050/ffffff?text=Tienda+Sin+Imagen';" />` :
                    '';

                card.innerHTML = `
                    ${imageHtml}
                    <h3 class="text-xl font-bold text-blue-600 mb-2">${store['nombre de la tienda']}</h3>
                    <p class="text-sm text-gray-700 mb-3">${store['descripci√≥n libre']}</p>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm mb-4 border-t pt-3">
                        <p><strong>Galer√≠a:</strong> ${store.galer√≠a}</p>
                        <p><strong>Piso:</strong> ${store.piso}</p>
                        <p><strong>Stand:</strong> ${store.stand}</p>
                        ${store.tiktok ? `
                        <a href="${store.tiktok}" target="_blank" class="text-pink-500 hover:text-pink-600 font-medium truncate">
                            <i data-lucide="tiktok" class="inline w-4 h-4 mr-1"></i>TikTok
                        </a>
                        ` : '<p class="text-gray-400">Sin TikTok</p>'}
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t">
                        <!-- Bot√≥n de Recomendaci√≥n (Fuego) -->
                        <button onclick="recommendStore('${store.id}')" 
                                class="flex items-center text-orange-500 hover:text-orange-700 transition duration-150 mr-4">
                            <i data-lucide="flame" class="w-5 h-5 mr-1 ${fireClass}"></i>
                            <span class="font-bold">${store.recommendations}</span> Fuego üî•
                        </button>
                        
                        <!-- Bot√≥n de Verificaciones (Check) -->
                        <button onclick="showReviewsModal('${store.id}', '${store['nombre de la tienda']}')" 
                                class="flex items-center text-green-600 hover:text-green-800 transition duration-150">
                            <i data-lucide="check-square" class="w-5 h-5 mr-1 stroke-green-600"></i>
                            <span class="font-bold mr-1">${store.verificationCount || 0}</span> Verificaciones
                        </button>
                        
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-right">ID: ${store.id.substring(0, 10)}...</p>
                `;
                storesContainer.appendChild(card);
            });
            // Reemplazar √≠conos de lucide despu√©s de renderizar
            lucide.createIcons();
        }

        // Renderiza la lista de verificaciones en el modal
        function displayVerifications(verifications) {
            reviewsContainer.innerHTML = '';
            reviewCount.textContent = verifications.length;
            
            if (verifications.length === 0) {
                noReviewsMessage.classList.remove('hidden');
            } else {
                noReviewsMessage.classList.add('hidden');
                
                verifications.forEach(verification => {
                    const verificationElement = document.createElement('div');
                    verificationElement.className = 'p-3 border border-gray-100 rounded-lg bg-white shadow-sm';
                    verificationElement.innerHTML = `
                        <p class="text-gray-800 break-words flex items-start">
                            <i data-lucide="check-circle" class="w-5 h-5 mr-2 text-green-500"></i>
                            <span>${verification.text}</span>
                        </p>
                        <div class="flex justify-between items-center mt-2 text-xs text-gray-400 border-t pt-2">
                            <span>Usuario: ${verification.creatorId.substring(0, 8)}...</span>
                            <span>Fecha: ${verification.createdAt}</span>
                        </div>
                    `;
                    reviewsContainer.appendChild(verificationElement);
                    lucide.createIcons(); // Vuelve a crear iconos para los elementos dentro del modal
                });
            }
        }
        
        // --- UTILIDADES DE UI ---
        
        function alertUser(message) {
            const existingAlert = document.getElementById('customAlert');
            if (existingAlert) existingAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'customAlert';
            alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-xl z-[9999]';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function displayFormMessage(message, type, element) {
            element.textContent = message;
            element.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (type === 'error') {
                element.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                element.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'hide') {
                 element.classList.add('hidden');
            }
        }
        
        // =================================================================
        // 4. FUNCIONES DE MODALES
        // =================================================================
        
        // --- MODAL AGREGAR TIENDA ---
        window.showAddStoreModal = function() {
            const modal = document.getElementById('addStoreModal');
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        window.hideAddStoreModal = function() {
            const modal = document.getElementById('addStoreModal');
            modal.classList.add('hidden');
            displayFormMessage('', 'hide', formMessage);
            storeForm.reset();
        }
        
        // --- MODAL VERIFICACIONES ---
        window.showReviewsModal = function(storeId, storeName) {
            // 1. Configurar estado
            currentReviewStoreId = storeId;
            reviewStoreName.textContent = storeName;
            
            // 2. Iniciar escuchador de verificaciones para esta tienda
            setupVerificationsListener(storeId);
            
            // 3. Mostrar modal
            reviewsModal.classList.remove('hidden');
            lucide.createIcons();
        }

        window.hideReviewsModal = function() {
            // 1. Ocultar modal
            reviewsModal.classList.add('hidden');
            
            // 2. Detener escuchador de verificaciones
            if (unsubscribeReviews) {
                unsubscribeReviews();
                unsubscribeReviews = null;
            }
            
            // 3. Limpiar estado y formulario
            currentReviewStoreId = null;
            reviewForm.reset();
            displayFormMessage('', 'hide', reviewFormMessage);
            reviewsContainer.innerHTML = '';
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('addStoreModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('addStoreModal')) {
                window.hideAddStoreModal();
            }
        });
         document.getElementById('reviewsModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('reviewsModal')) {
                window.hideReviewsModal();
            }
        });
        
    </script>
</body>
</html>
