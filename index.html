<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Clientes y Boletas</title>
    <!-- Cargamos Tailwind CSS para un diseño limpio -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos adicionales para la cámara */
        #video-stream {
            width: 100%;
            max-width: 600px;
            border-radius: 0.5rem;
        }
        #photo-canvas {
            width: 100%;
            max-width: 600px;
            border-radius: 0.5rem;
        }
        /* Ocultar elementos por defecto */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4">

    <div class="max-w-2xl mx-auto bg-white shadow-md rounded-lg p-6">

        <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">Gestor de Boletas</h1>

        <!-- 1. Vista de Lista de Clientes -->
        <div id="client-list-view">
            <h2 class="text-2xl font-semibold mb-4">Selecciona un Cliente</h2>
            <div id="client-list" class="space-y-3">
                <!-- Aquí irían tus clientes. data-phone debe tener el código de país (ej. 51 para Perú) -->
                <button data-name="Juan Pérez" data-phone="51912345678" class="client-button w-full text-left p-4 bg-gray-50 border rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="font-medium">Juan Pérez</div>
                    <div class="text-sm text-gray-600">+51 912 345 678</div>
                </button>
                <button data-name="Maria Garcia" data-phone="51987654321" class="client-button w-full text-left p-4 bg-gray-50 border rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="font-medium">Maria Garcia</div>
                    <div class="text-sm text-gray-600">+51 987 654 321</div>
                </button>
                <button data-name="Carlos Sánchez" data-phone="51999888777" class="client-button w-full text-left p-4 bg-gray-50 border rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="font-medium">Carlos Sánchez</div>
                    <div class="text-sm text-gray-600">+51 999 888 777</div>
                </button>
            </div>
        </div>

        <!-- 2. Vista de Cámara -->
        <div id="camera-view" class="hidden">
            <h2 class="text-2xl font-semibold mb-4">Boleta para: <span id="client-name-title" class="text-blue-600"></span></h2>
            <p class_="text-gray-700 mb-4">Apunta la cámara a la boleta y toma la foto.</p>
            <!-- El stream de la cámara -->
            <video id="video-stream" autoplay playsinline></video>
            
            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <button id="snap-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                    Tomar Foto
                </button>
                <button id="cancel-button" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition duration-300">
                    Cancelar
                </button>
            </div>
        </div>

        <!-- 3. Vista de Previsualización y Compartir -->
        <div id="preview-view" class="hidden">
            <h2 class="text-2xl font-semibold mb-4">Foto Capturada</h2>
            <!-- El canvas mostrará la foto tomada -->
            <canvas id="photo-canvas"></canvas>

            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <button id="share-button" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300">
                    Compartir Foto
                </button>
                <button id="retake-button" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition duration-300">
                    Tomar Otra
                </button>
            </div>
        </div>

    </div>

    <script>
        // Obtenemos los elementos principales del DOM
        const clientListView = document.getElementById('client-list-view');
        const cameraView = document.getElementById('camera-view');
        const previewView = document.getElementById('preview-view');
        
        const clientList = document.getElementById('client-list');
        const clientNameTitle = document.getElementById('client-name-title');
        
        const video = document.getElementById('video-stream');
        const canvas = document.getElementById('photo-canvas');
        
        const snapButton = document.getElementById('snap-button');
        const cancelButton = document.getElementById('cancel-button');
        const shareButton = document.getElementById('share-button');
        const retakeButton = document.getElementById('retake-button');

        // Variables para guardar el estado
        let currentStream = null;
        let currentClient = {
            name: '',
            phone: ''
        };

        // --- MANEJADORES DE EVENTOS ---

        // 1. Cuando se hace clic en un cliente
        clientList.addEventListener('click', (e) => {
            // Buscamos el botón de cliente más cercano
            const clientButton = e.target.closest('.client-button');
            if (clientButton) {
                currentClient.name = clientButton.dataset.name;
                currentClient.phone = clientButton.dataset.phone;
                clientNameTitle.innerText = currentClient.name;
                
                // Abrimos la cámara
                openCamera();
            }
        });

        // 2. Cuando se hace clic en "Tomar Foto"
        snapButton.addEventListener('click', takePhoto);

        // 3. Cuando se hace clic en "Cancelar"
        cancelButton.addEventListener('click', closeCamera);

        // 4. Cuando se hace clic en "Tomar Otra"
        retakeButton.addEventListener('click', () => {
            // Simplemente volvemos a mostrar la vista de la cámara
            previewView.classList.add('hidden');
            cameraView.classList.remove('hidden');
        });

        // 5. Cuando se hace clic en "Compartir Foto"
        shareButton.addEventListener('click', sharePhoto);


        // --- FUNCIONES PRINCIPALES ---

        /**
         * Pide permiso al usuario y abre la cámara del dispositivo.
         */
        async function openCamera() {
            // Ocultar lista de clientes y mostrar cámara
            clientListView.classList.add('hidden');
            previewView.classList.add('hidden');
            cameraView.classList.remove('hidden');

            try {
                // Pedir acceso a la cámara trasera (environment)
                const constraints = {
                    video: {
                        facingMode: 'environment' // Usar cámara trasera
                    },
                    audio: false
                };
                
                // Iniciar el stream de video
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                currentStream = stream;

            } catch (err) {
                console.error("Error al acceder a la cámara: ", err);
                // Manejar error: el usuario no dio permiso o no tiene cámara
                // No usamos alert() por buenas prácticas
                clientNameTitle.innerText = "Error de cámara";
            }
        }

        /**
         * Detiene el stream de la cámara y vuelve a la lista de clientes.
         */
        function closeCamera() {
            if (currentStream) {
                // Detener todas las pistas (apagar la luz de la cámara)
                currentStream.getTracks().forEach(track => track.stop());
            }
            currentStream = null;
            
            // Mostrar lista de clientes y ocultar cámara
            cameraView.classList.add('hidden');
            previewView.classList.add('hidden');
            clientListView.classList.remove('hidden');
        }

        /**
         * Captura un fotograma del video y lo dibuja en el canvas.
         */
        function takePhoto() {
            const context = canvas.getContext('2d');
            
            // Ajustar el tamaño del canvas al del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Dibujar la imagen del video en el canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Ocultar la cámara y mostrar la previsualización
            cameraView.classList.add('hidden');
            previewView.classList.remove('hidden');
        }

        /**
         * Utiliza la Web Share API para compartir la foto.
         */
        async function sharePhoto() {
            // Comprobar si el navegador soporta la API de "Compartir"
            if (!navigator.share) {
                console.error("La API de Web Share no es soportada en este navegador.");
                // Aquí podrías mostrar un mensaje modal en lugar de alert
                // alert("Tu navegador no soporta la función de compartir.");
                return;
            }

            // Convertir la imagen del canvas a un archivo (Blob)
            canvas.toBlob(async (blob) => {
                const file = new File([blob], `boleta-${currentClient.name.replace(' ', '-')}.jpg`, {
                    type: 'image/jpeg'
                });

                const shareData = {
                    files: [file],
                    title: `Boleta para ${currentClient.name}`,
                    text: `Aquí está la foto de la boleta para ${currentClient.name}.`
                };

                try {
                    // Abrir el diálogo nativo de "Compartir"
                    await navigator.share(shareData);
                    console.log("Foto compartida exitosamente");
                    // Después de compartir, volver a la lista de clientes
                    closeCamera(); 
                } catch (err) {
                    console.error("Error al compartir: ", err);
                }
            }, 'image/jpeg');
        }

    </script>
</body>
</html>
