<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Migración de Clientes</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SDKs de Firebase (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* Estilo simple para los logs */
        #logs div:nth-child(even) { background-color: #f9f9f9; }
        #logs .success { color: green; font-weight: bold; }
        #logs .error { color: red; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100 font-sans p-5 md:p-10">

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800">Herramienta de Migración</h1>
        <p class="text-gray-600 mt-2">Esta herramienta leerá tu colección `envios` y creará/actualizará tu colección `clientes` con el último registro de cada cliente. Úsala solo una vez.</p>
        <p class="text-sm text-red-600 font-semibold mt-2">Importante: Debes haber actualizado tus Reglas de Firestore (Paso 1) para darle permisos de lectura a tu email de administrador.</p>

        <!-- Estado de Autenticación -->
        <div id="authStatus" class="mt-4 p-3 bg-gray-50 rounded text-gray-700">
            Estado: No autenticado.
        </div>

        <!-- Botones de Acción -->
        <div class="flex gap-4 mt-4">
            <button id="btnSignIn" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                1. Iniciar Sesión con Google
            </button>
            <button id="btnMigrate" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" disabled>
                2. Iniciar Migración
            </button>
        </div>

        <!-- Logs de Salida -->
        <div class="mt-6">
            <h2 class="text-lg font-semibold">Logs de Ejecución:</h2>
            <div id="logs" class="mt-2 h-64 overflow-y-auto bg-gray-50 border border-gray-300 p-3 rounded-lg text-sm font-mono">
                <div>Esperando para iniciar...</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACIÓN ---
        // Pega el firebaseConfig de tu proyecto (el mismo de tu formulario)
        const firebaseConfig = {
          apiKey: "AIzaSyCzJ36uZ6Bh6DdZK3VBv5HMu2xcU4GqCMQ",
          authDomain: "form-bedc2.firebaseapp.com",
          projectId: "form-bedc2",
          storageBucket: "form-bedc2.firebasestorage.app",
          messagingSenderId: "942482653487",
          appId: "1:942482653487:web:4193c16f078992659521da"
        };

        // --- 2. INICIALIZACIÓN ---
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Referencias a elementos del DOM
        const btnSignIn = document.getElementById('btnSignIn');
        const btnMigrate = document.getElementById('btnMigrate');
        const authStatus = document.getElementById('authStatus');
        const logs = document.getElementById('logs');

        // Función para añadir logs a la pantalla
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `p-1 border-b border-gray-200 ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            // Auto-scroll hacia abajo
            logs.scrollTop = logs.scrollHeight;
        }

        // --- 3. LÓGICA DE AUTENTICACIÓN ---
        btnSignIn.addEventListener('click', async () => {
            log("Iniciando autenticación con Google...");
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                log(`¡Éxito! Autenticado como: ${user.email}`, 'success');
                authStatus.textContent = `Estado: Autenticado como ${user.email}`;
                authStatus.classList.add('bg-green-100');
                btnSignIn.disabled = true;
                btnMigrate.disabled = false;
            } catch (error) {
                log(`Error de autenticación: ${error.message}`, 'error');
                authStatus.textContent = `Error: ${error.message}`;
                authStatus.classList.add('bg-red-100');
            }
        });

        // --- 4. LÓGICA DE MIGRACIÓN ---
        btnMigrate.addEventListener('click', async () => {
            if (!auth.currentUser) {
                log("No estás autenticado.", 'error');
                return;
            }
            
            btnMigrate.disabled = true;
            btnMigrate.textContent = "Migrando...";
            log("--- INICIANDO MIGRACIÓN ---");
            log("Paso 1: Leyendo TODOS los documentos de 'envios'...");

            try {
                // 1. Obtener TODOS los envíos y ordenarlos por fecha
                const enviosCollection = db.collection('envios');
                const enviosSnapshot = await enviosCollection.orderBy('fechaRegistro', 'desc').get();
                
                log(`Paso 2: Se encontraron ${enviosSnapshot.docs.length} envíos. Ordenando...`);

                const clientesCollection = db.collection('clientes');
                let clientesProcesados = new Set();
                let contadorClientesUnicos = 0;
                let contadorErrores = 0;

                // 2. Iterar sobre cada envío (del más nuevo al más viejo)
                for (const envioDoc of enviosSnapshot.docs) {
                    const envioData = envioDoc.data();
                    const telefonoCliente = envioData.cliente;

                    // 3. Si tiene teléfono Y NO lo hemos procesado ya...
                    if (telefonoCliente && !clientesProcesados.has(telefonoCliente)) {
                        
                        // 4. Marcarlo para no volver a procesarlo
                        clientesProcesados.add(telefonoCliente);
                        
                        // 5. Preparar los datos del cliente
                        const clienteData = {
                            nombre: envioData.nombre || '',
                            telefono: envioData.telefono || '',
                            distrito: envioData.distrito || '',
                            direccion: envioData.direccion || '',
                            referencia: envioData.referencia || '',
                            DNI: envioData.DNI || '',
                            agencia: envioData.agencia || '',
                            tipoUltimoEnvio: envioData.courier || ''
                        };

                        // 6. Escribir/Actualizar el documento en 'clientes'
                        try {
                            // Usamos el teléfono como ID del documento
                            await clientesCollection.doc(telefonoCliente).set(clienteData, { merge: true });
                            contadorClientesUnicos++;
                            log(`Cliente ${telefonoCliente} guardado.`);
                        } catch (writeError) {
                            log(`Error al guardar cliente ${telefonoCliente}: ${writeError.message}`, 'error');
                            contadorErrores++;
                        }
                    }
                }

                log("--- ¡MIGRACIÓN COMPLETADA! ---", 'success');
                log(`Total de clientes únicos encontrados y migrados: ${contadorClientesUnicos}`, 'success');
                log(`Total de errores de escritura: ${contadorErrores}`, 'error');
                btnMigrate.textContent = "Migración Completa";

            } catch (readError) {
                log(`Error FATAL al leer la colección 'envios': ${readError.message}`, 'error');
                log("Verifica tus Reglas de Firestore (Paso 1). Debes dar permiso de 'read' a tu email.", 'error');
                btnMigrate.disabled = false;
                btnMigrate.textContent = "Reintentar Migración";
            }
        });

    </script>
</body>
</html>

