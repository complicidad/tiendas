<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listado de Tiendas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fuse.js (buscador) -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body class="bg-gray-100">
  <h1 class="text-3xl font-bold text-center mt-5">Tiendas Registradas</h1>
  <p class="text-center text-gray-600 mb-4">Explora las tiendas y abre su ubicaci√≥n en Google Maps üìç</p>

  <!-- Buscador -->
  <div class="w-11/12 md:w-1/2 mx-auto mb-6">
    <input id="search" type="text" placeholder="Buscar tienda, productos o tags..." 
      class="w-full p-3 border rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400" />
    <ul id="results" class="bg-white mt-2 rounded-lg shadow-md"></ul>
  </div>

  <!-- Contenedor de tarjetas -->
  <div id="tiendas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-11/12 mx-auto"></div>

  <!-- Bot√≥n registrar -->
  <a href="https://forms.gle/ZXdRHsZ1XDiojz8FA" target="_blank"
     class="fixed bottom-5 right-5 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition"
     style="z-index: 9999;">
     ‚ûï
  </a>

  <script>
    // Coordenadas por galer√≠a
    const galerias = {
      "Gamarra": [-12.06314, -77.01457],
      "Polvos Azules": [-12.05978, -77.02968],
      "Polvos Rosados": [-12.06865, -77.03301],
      "Centro de Lima": [-12.0464, -77.0428],
      "Arenales": [-12.08968, -77.03317],
      "Mesa Redonda": [-12.0512, -77.0277]
    };

    let tiendas = [];

    // URL de Google Sheet publicada en CSV
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-8h9aepNqoixNWhC_zdj2fV-8u5JkL1TxdYhvb1Nwdw09aDLLrJpTu2AXdlpPGAhXYXZ9sMlucKwG/pub?gid=1928937044&single=true&output=csv";

    fetch(sheetUrl)
      .then(res => res.text())
      .then(csv => {
        // Convertir CSV a JSON
        let rows = csv.split("\n").map(r => r.split(","));
        let headers = rows[0].map(h => h.trim().toLowerCase());
        let data = rows.slice(1).map(r => {
          let obj = {};
          headers.forEach((h, i) => obj[h] = r[i]?.trim());
          return obj;
        }).filter(r => r["nombre de la tienda"]); // descartar filas vac√≠as

        tiendas = data;

        renderTiendas(tiendas);

        // Configurar buscador con Fuse.js
        const fuse = new Fuse(tiendas, {
          keys: [
            'nombre de la tienda', 
            'galer√≠a', 
            'stand', 
            'piso',
            'productos',
            'tags',
            'descripcion'
          ],
          threshold: 0.3
        });

        const searchInput = document.getElementById('search');
        const resultsList = document.getElementById('results');

        searchInput.addEventListener('input', () => {
          const query = searchInput.value.trim();
          resultsList.innerHTML = "";

          if (!query) {
            renderTiendas(tiendas);
            return;
          }

          const results = fuse.search(query).slice(0, 5);
          renderTiendas(results.map(r => r.item));

          results.forEach(r => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="font-bold">${r.item["nombre de la tienda"]}</span> 
                            <span class="text-gray-500 text-sm">(${r.item["galer√≠a"]})</span>`;
            li.className = "p-2 cursor-pointer hover:bg-blue-100 transition";
            li.onclick = () => {
              searchInput.value = r.item["nombre de la tienda"];
              renderTiendas([r.item]);
              resultsList.innerHTML = "";
            };
            resultsList.appendChild(li);
          });
        });

        // Cerrar lista al hacer clic fuera
        document.addEventListener("click", (e) => {
          if (!resultsList.contains(e.target) && e.target !== searchInput) {
            resultsList.innerHTML = "";
          }
        });
      })
      .catch(err => console.error("Error cargando Google Sheet:", err));

    // Funci√≥n para renderizar tiendas como tarjetas
    function renderTiendas(lista) {
      const container = document.getElementById('tiendas-list');
      container.innerHTML = "";

      lista.forEach(tienda => {
        let coords = galerias[tienda["galer√≠a"]];
        let mapsLink = coords 
          ? `https://www.google.com/maps?q=${coords[0]},${coords[1]}` 
          : "#";

        const card = document.createElement('div');
        card.className = "bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition";

        card.innerHTML = `
          <h2 class="text-xl font-bold mb-1">${tienda["nombre de la tienda"]}</h2>
          <p class="text-gray-600 mb-1">${tienda["galer√≠a"] || "Ubicaci√≥n no definida"}</p>
          <p class="text-sm text-gray-500">Piso: ${tienda["piso"] || "?"} - Stand: ${tienda["stand"] || "?"}</p>

          ${tienda["productos"] ? `<p class="mt-2 text-sm"><span class="font-semibold">Productos:</span> ${tienda["productos"]}</p>` : ""}
          ${tienda["descripcion"] ? `<p class="mt-1 text-gray-700 text-sm">${tienda["descripcion"]}</p>` : ""}
          
          ${tienda["tags"] ? `<div class="mt-2 flex flex-wrap gap-1">
            ${tienda["tags"].split(",").map(tag => 
              `<span class="px-2 py-0.5 text-xs bg-gray-200 rounded-full">${tag.trim()}</span>`
            ).join("")}
          </div>` : ""}
          
          <div class="mt-3 flex flex-wrap gap-2">
            ${coords ? `<a href="${mapsLink}" target="_blank" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg shadow hover:bg-blue-600 transition">üìç Google Maps</a>` : ""}
            ${tienda["tiktok"] ? `<a href="${tienda["tiktok"]}" target="_blank" class="px-3 py-1 bg-pink-500 text-white text-sm rounded-lg shadow hover:bg-pink-600 transition">üéµ TikTok</a>` : ""}
          </div>
        `;

        container.appendChild(card);
      });
    }
  </script>
</body>
</html>
