<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listado de Tiendas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fuse.js (buscador) -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body class="bg-gray-100">
  <h1 class="text-3xl font-bold text-center mt-5">Tiendas Registradas</h1>
  <p class="text-center text-gray-600 mb-4">Explora las tiendas y abre su ubicaciÃ³n en Google Maps ğŸ“</p>

  <!-- Buscador -->
  <div class="w-11/12 md:w-1/2 mx-auto mb-6">
    <input id="search" type="text" placeholder="Buscar tienda, productos o tags..." 
      class="w-full p-3 border rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400" />
    <ul id="results" class="bg-white mt-2 rounded-lg shadow-md"></ul>
  </div>

  <!-- Contenedor de tarjetas -->
  <div id="tiendas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-11/12 mx-auto"></div>

  <!-- BotÃ³n registrar -->
  <a href="https://forms.gle/ZXdRHsZ1XDiojz8FA" target="_blank"
     class="fixed bottom-5 right-5 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition"
     style="z-index: 9999;">
     â•
  </a>

  <script>
    
  function toggleLike(storeName, btn) {
    // Recuperar likes del navegador
    let likes = JSON.parse(localStorage.getItem("likes")) || {};
    
    // Cambiar estado del like
    if (likes[storeName]) {
      delete likes[storeName]; // quitar like
      btn.classList.remove("bg-red-500", "text-white");
      btn.classList.add("bg-gray-200", "text-gray-700");
      btn.innerText = "ğŸ‘ Like";
    } else {
      likes[storeName] = true; // dar like
      btn.classList.add("bg-red-500", "text-white");
      btn.classList.remove("bg-gray-200", "text-gray-700");
      btn.innerText = "â¤ï¸ Liked";
    }

    // Guardar en localStorage
    localStorage.setItem("likes", JSON.stringify(likes));
  }

  // FunciÃ³n para renderizar botÃ³n segÃºn estado
  function renderLikeButton(storeName) {
    let likes = JSON.parse(localStorage.getItem("likes")) || {};
    const liked = !!likes[storeName];

    return `<button 
      onclick="toggleLike('${storeName}', this)"
      class="px-3 py-1 rounded-lg shadow transition text-sm ${
        liked ? "bg-red-500 text-white" : "bg-gray-200 text-gray-700"
      }"
    >${liked ? "â¤ï¸ Liked" : "ğŸ‘ Like"}</button>`;
  }
   
    
    
    // Coordenadas por galerÃ­a
    const galerias = {
      "Gamarra": [-12.06314, -77.01457],
      "Polvos Azules": [-12.05978, -77.02968],
      "Polvos Rosados": [-12.06865, -77.03301],
      "Centro de Lima": [-12.0464, -77.0428],
      "Arenales": [-12.08968, -77.03317],
      "Mesa Redonda": [-12.0512, -77.0277]
    };
    
    // Diccionario de categorÃ­as para extraer tags
    const diccionarioTags = [
      // ğŸ‘Ÿ Calzado
      "zapatillas", "nike", "adidas", "puma", "reebok", "vans", "converse",
      "sandalias", "botas", "tacones", "calzado", "original", "rÃ©plica",

      // ğŸ‘• Ropa y moda
      "ropa", "moda", "camisetas", "polos", "pantalones", "jeans", 
      "casacas", "abrigos", "vestidos", "blusas", "camisas",
      "ropa deportiva", "ropa urbana", "ropa casual", "ropa formal",

      // ğŸ’ Accesorios
      "accesorios", "carteras", "bolsos", "mochilas", "gorras", "cinturones",
      "lentes", "relojes", "joyas", "bisuterÃ­a", "aretes", "collares", "anillos",

      // ğŸ“± ElectrÃ³nica y gadgets
      "electronica", "celulares", "iphone", "samsung", "xiaomi", 
      "audÃ­fonos", "cargadores", "smartwatch", "laptops", "tablets",

      // ğŸ® Cultura pop y hobbies
      "anime", "manga", "cosplay", "figuras", "coleccionables", "comics", "videojuegos",
      "juguetes", "peluches", "funko", "cartas", "trading cards",

      // ğŸ  Hogar
      "hogar", "decoraciÃ³n", "muebles", "cocina", "vajilla", "iluminaciÃ³n",

      // ğŸ›ï¸ Extras generales
      "oferta", "descuento", "nuevo", "importado", "peruano"
    ];


    let tiendas = [];

    // FunciÃ³n para recortar texto largo
    function recortarTexto(texto, maxLength = 50) {
      if (!texto) return "";
      if (texto.length <= maxLength) return texto;
      return texto.slice(0, maxLength) + "...";
    }

    
    // URL de Google Sheet publicada en CSV
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS-8h9aepNqoixNWhC_zdj2fV-8u5JkL1TxdYhvb1Nwdw09aDLLrJpTu2AXdlpPGAhXYXZ9sMlucKwG/pub?gid=1928937044&single=true&output=csv";

    fetch(sheetUrl)
      .then(res => res.text())
      .then(csv => {
        let rows = csv.split("\n").map(r => r.split(","));
        let headers = rows[0].map(h => h.trim().toLowerCase());
        let data = rows.slice(1).map(r => {
          let obj = {};
          headers.forEach((h, i) => obj[h] = r[i]?.trim());
          return obj;
        }).filter(r => r["nombre de la tienda"]);

        // Extraer tags desde la descripciÃ³n libre
        tiendas = data.map(tienda => {
          let descripcion = (tienda["descripciÃ³n libre"] || "").toLowerCase();
          let tags = diccionarioTags.filter(tag => descripcion.includes(tag));
          return { ...tienda, tags: tags.join(",") };
        });

        renderTiendas(tiendas);

        // Configurar buscador
        const fuse = new Fuse(tiendas, {
          keys: [
            'nombre de la tienda', 
            'galerÃ­a', 
            'piso',
            'stand',
            'descripciÃ³n libre',
            'tags'
          ],
          threshold: 0.3
        });

        const searchInput = document.getElementById('search');
        const resultsList = document.getElementById('results');

        searchInput.addEventListener('input', () => {
          const query = searchInput.value.trim();
          resultsList.innerHTML = "";

          if (!query) {
            renderTiendas(tiendas);
            return;
          }

          const results = fuse.search(query).slice(0, 5);
          renderTiendas(results.map(r => r.item));

          results.forEach(r => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="font-bold">${r.item["nombre de la tienda"]}</span> 
                            <span class="text-gray-500 text-sm">(${r.item["galerÃ­a"]})</span>`;
            li.className = "p-2 cursor-pointer hover:bg-blue-100 transition";
            li.onclick = () => {
              searchInput.value = r.item["nombre de la tienda"];
              renderTiendas([r.item]);
              resultsList.innerHTML = "";
            };
            resultsList.appendChild(li);
          });
        });

        document.addEventListener("click", (e) => {
          if (!resultsList.contains(e.target) && e.target !== searchInput) {
            resultsList.innerHTML = "";
          }
        });
      })
      .catch(err => console.error("Error cargando Google Sheet:", err));

    // Renderizar tiendas como tarjetas
    function renderTiendas(lista) {
      const container = document.getElementById('tiendas-list');
      container.innerHTML = "";
      
      lista.forEach(tienda => {
        let coords = galerias[tienda["galerÃ­a"]];
        let mapsLink = coords 
          ? `https://www.google.com/maps?q=${coords[0]},${coords[1]}` 
          : "#";

        let descripcion = tienda["descripciÃ³n libre"] || "";
        let descripcionCorta = recortarTexto(descripcion, 50);
              
        const card = document.createElement('div');
        card.className = "bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition";

        card.innerHTML = `
          <h2 class="text-xl font-bold mb-1">${tienda["nombre de la tienda"]}</h2>
          <p class="text-gray-600 mb-1">${tienda["galerÃ­a"] || "UbicaciÃ³n no definida"}</p>
          <p class="text-sm text-gray-500">Piso: ${tienda["piso"] || "?"} - Stand: ${tienda["stand"] || "?"}</p>

          ${descripcion ? `
            <p class="mt-2 text-gray-700 text-sm">
              <span class="descripcion-corta">${descripcionCorta}</span>
              <span class="descripcion-completa hidden">${descripcion}</span>
              ${descripcion.length > 50 
                ? `<button class="text-blue-500 text-xs ml-1 leer-mas hover:underline">Leer mÃ¡s</button>` 
                : ""}
            </p>` : ""}
            
            
          
          ${tienda["tags"] ? `<div class="mt-2 flex flex-wrap gap-1">
            ${tienda["tags"].split(",").map(tag => 
              `<span class="px-2 py-0.5 text-xs bg-gray-200 rounded-full cursor-pointer hover:bg-blue-200" 
                onclick="filtrarPorTag('${tag.trim()}')">#${tag.trim()}</span>`
            ).join("")}
          </div>` : ""}
          
          <div class="mt-3 flex flex-wrap gap-2">
            ${coords ? `<a href="${mapsLink}" target="_blank" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg shadow hover:bg-blue-600 transition">ğŸ“ Google Maps</a>` : ""}
            ${tienda["tiktok"] ? `<a href="${tienda["tiktok"]}" target="_blank" class="px-3 py-1 bg-pink-500 text-white text-sm rounded-lg shadow hover:bg-pink-600 transition">ğŸµ TikTok</a>` : ""}
            ${renderLikeButton(tienda["nombre de la tienda"])}
          </div>
        `;

        container.appendChild(card);
      });
    
      // Activar "Leer mÃ¡s / Leer menos"
      document.querySelectorAll(".leer-mas").forEach(btn => {
        btn.addEventListener("click", () => {
          const card = btn.closest("p");
          const corta = card.querySelector(".descripcion-corta");
          const completa = card.querySelector(".descripcion-completa");

          if (completa.classList.contains("hidden")) {
            corta.classList.add("hidden");
            completa.classList.remove("hidden");
            btn.textContent = "Leer menos";
          } else {
            completa.classList.add("hidden");
            corta.classList.remove("hidden");
            btn.textContent = "Leer mÃ¡s";
          }
        });
      });    
    
    }

    // Filtrar por tag desde un chip
    function filtrarPorTag(tag) {
      const filtradas = tiendas.filter(t => (t.tags || "").includes(tag));
      renderTiendas(filtradas);
      document.getElementById('search').value = "#" + tag;
    }
  </script>
</body>
</html>
